<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <meta charset="UTF-8">
    <title>Thêm sản phẩm mới</title>
    <th:block layout:fragment="styles">
        <style>
            body {
                font-family: 'Montserrat', 'Helvetica Neue', Arial, sans-serif;
                color: #111;
                background-color: #f8f9fa;
            }

            h1, h2, h3, h4 {
                font-weight: 700;
                letter-spacing: 0.5px;
                text-transform: uppercase;
            }

            .form-label {
                font-weight: 600;
                font-size: 14px;
            }

            .form-control, .form-select {
                border-radius: 6px;
                border-color: #ddd;
                background-color: #fff;
                padding: .5rem .75rem;
                color: #111;
            }

            .form-control:focus, .form-select:focus {
                border-color: #000;
                box-shadow: 0 0 0 0.25rem rgba(0,0,0,.1);
            }

            .btn-dark {
                background-color: #000;
                border: none;
                font-size: 14px;
                font-weight: 600;
                letter-spacing: 0.5px;
                transition: all 0.2s;
                padding: 10px 25px;
                border-radius: 6px;
            }

            .btn-dark:hover {
                background-color: #333;
            }

            .card {
                border: 1px solid #e5e5e5;
                border-radius: 8px;
            }

            .card-header {
                background-color: #f8f9fa;
                border-bottom: 2px solid #000;
            }

            .form-check-input:checked {
                background-color: #000;
                border-color: #000;
            }

            /* --- Image Upload Styles --- */
            .upload-area {
                transition: background-color .2s ease-in-out;
            }
            .upload-area:hover {
                background-color: #e9ecef;
            }
            .preview-image-wrapper {
                position: relative;
                width: 120px;
                height: 120px;
            }
            .preview-image {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 8px;
                border: 1px solid #ddd;
            }
            .btn-remove-image {
                position: absolute;
                top: -5px;
                right: -5px;
                width: 24px;
                height: 24px;
                background-color: black;
                color: white;
                border-radius: 50%;
                border: 2px solid white;
                font-weight: bold;
                line-height: 1;
                cursor: pointer;
                display: flex;
                justify-content: center;
                align-items: center;
            }
        </style>
    </th:block>

</head>
<body>

<div layout:fragment="content" class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">

            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="mb-4 text-center">Thêm sản phẩm mới</h1>
                <a th:href="@{/vendor/products}" class="btn btn-outline-dark"><i class="fas fa-arrow-left me-2"></i> Quay lại</a>
            </div>

            <div th:if="${errorMessage}" class="alert alert-danger">
                <p th:text="${errorMessage}"></p>
            </div>

            <form th:action="@{/vendor/products/add}" th:object="${form}" method="post" id="productForm">

                <!-- Product Core Info -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">Thông tin cơ bản</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="productName" class="form-label">Tên sản phẩm (*)</label>
                                    <input type="text" id="productName" class="form-control" th:field="*{product.productName}" required>
                                    <p th:if="${#fields.hasErrors('product.productName')}" th:errors="*{product.productName}" class="text-danger small"></p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="sku" class="form-label">SKU (Mã sản phẩm)</label>
                                    <input type="text" id="sku" class="form-control" th:field="*{product.sku}">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="shortDescription" class="form-label">Mô tả ngắn</label>
                            <textarea id="shortDescription" class="form-control" rows="3" th:field="*{product.shortDescription}"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Mô tả chi tiết</label>
                            <textarea id="description" class="form-control" rows="6" th:field="*{product.description}"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Pricing -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">Giá sản phẩm</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="price" class="form-label">Giá gốc (*)</label>
                                <div class="input-group">
                                    <input type="number" id="price" class="form-control" th:field="*{product.price}" required step="any">
                                    <span class="input-group-text">VNĐ</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="salePrice" class="form-label">Giá khuyến mãi</label>
                                <div class="input-group">
                                     <input type="number" id="salePrice" class="form-control" th:field="*{product.salePrice}" step="any">
                                     <span class="input-group-text">VNĐ</span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="costPrice" class="form-label">Giá vốn</label>
                                <div class="input-group">
                                    <input type="number" id="costPrice" class="form-control" th:field="*{product.costPrice}" step="any">
                                    <span class="input-group-text">VNĐ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                 <!-- Images -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">Hình ảnh</h4>
                    </div>
                    <div class="card-body">
                        <!-- Image Upload Section -->
                        <div class="mb-3">
                            <label class="form-label">Tải ảnh lên</label>
                             <p class="text-muted small">Tải lên tối đa 5 ảnh. Ảnh đầu tiên sẽ là ảnh đại diện.</p>
                            <div class="upload-area border rounded p-4 text-center" id="imageUploadArea" style="cursor: pointer;">
                                <i class="fas fa-cloud-upload-alt fa-3x text-primary"></i>
                                <p class="mt-2 mb-0"><strong>Nhấp hoặc kéo thả ảnh vào đây</strong></p>
                                <small class="text-muted">Hỗ trợ JPG, PNG, GIF</small>
                                <input type="file" id="imageInput" accept="image/*" multiple class="d-none">
                            </div>
                        </div>
                        <!-- Image Preview Section -->
                        <div id="imagePreview" class="mt-3 d-flex flex-wrap gap-3">
                            <!-- Previews will be appended here -->
                        </div>
                        <!-- Hidden Inputs for Image URLs -->
                        <div id="hiddenImageInputsContainer">
                            <!-- Hidden inputs for submitted URLs will be appended here -->
                        </div>
                    </div>
                </div>


                <!-- Inventory & Shipping -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">Tồn kho & Vận chuyển</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="stockQuantity" class="form-label">Số lượng tồn kho</label>
                                <input type="number" id="stockQuantity" class="form-control" th:field="*{product.stockQuantity}">
                            </div>
                            <div class="col-md-6">
                                <label for="lowStockThreshold" class="form-label">Ngưỡng tồn kho thấp</label>
                                <input type="number" id="lowStockThreshold" class="form-control" th:field="*{product.lowStockThreshold}">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <label for="weight" class="form-label">Cân nặng (gram)</label>
                                <input type="number" id="weight" class="form-control" th:field="*{product.weight}" step="any">
                            </div>
                            <div class="col-md-6">
                                <label for="dimensions" class="form-label">Kích thước (D x R x C)</label>
                                <input type="text" id="dimensions" class="form-control" th:field="*{product.dimensions}" placeholder="e.g. 20x15x10">
                            </div>
                        </div>
                         <div class="row mt-3">
                             <div class="col-md-12">
                                <label for="material" class="form-label">Chất liệu</label>
                                <input type="text" id="material" class="form-control" th:field="*{product.material}">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Organization -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h4 class="mb-0">Phân loại</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="category" class="form-label">Danh mục (*)</label>
                                <select id="category" class="form-select" th:field="*{product.categoryId}" required>
                                    <option value="">-- Chọn danh mục --</option>
                                    <option th:each="cat : ${categories}" th:value="${cat.id}" th:text="${cat.categoryName}"></option>
                                </select>
                                <p th:if="${#fields.hasErrors('product.categoryId')}" th:errors="*{product.categoryId}" class="text-danger small"></p>
                            </div>
                            <div class="col-md-6">
                                 <label for="brand" class="form-label">Thương hiệu</label>
                                <select id="brand" class="form-select" th:field="*{product.brandId}">
                                    <option value="">-- Chọn thương hiệu --</option>
                                    <option th:each="brand : ${brands}" th:value="${brand.id}" th:text="${brand.brandName}"></option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card mb-4">
                     <div class="card-header">
                        <h4 class="mb-0">Tùy chọn hiển thị</h4>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" id="featured" th:field="*{product.featured}">
                            <label class="form-check-label" for="featured">Sản phẩm nổi bật (Hiển thị ở trang chủ của shop)</label>
                        </div>
                    </div>
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-dark">Thêm sản phẩm</button>
                </div>
            </form>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            // --- CLOUDINARY CONFIG ---
            const CLOUDINARY_CLOUD_NAME = /*[[${@environment.getProperty('cloudinaryProduct.cloud-name')}]]*/ 'dins132fr';
            const CLOUDINARY_UPLOAD_PRESET = /*[[${@environment.getProperty('cloudinaryProduct.upload-preset')}]]*/ 'ml_default';
            const CLOUDINARY_API_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
            const MAX_IMAGES = 5;

            // --- DOM ELEMENTS ---
            const imageUploadArea = document.getElementById('imageUploadArea');
            const imageInput = document.getElementById('imageInput');
            const imagePreviewContainer = document.getElementById('imagePreview');
            const hiddenInputsContainer = document.getElementById('hiddenImageInputsContainer');

            // --- EVENT LISTENERS ---
            imageUploadArea.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', handleFileSelect);

            function handleFileSelect(event) {
                const files = event.target.files;
                const currentImageCount = hiddenInputsContainer.children.length;

                if (currentImageCount + files.length > MAX_IMAGES) {
                    alert(`Lỗi: Bạn chỉ có thể tải lên tối đa ${MAX_IMAGES} ảnh.`);
                    return;
                }

                Array.from(files).forEach(uploadToCloudinary);
                event.target.value = ''; // Reset input
            }

            function uploadToCloudinary(file) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);

                const previewId = `preview-${Date.now()}-${Math.random().toString(36).substring(2)}`;
                const loadingHtml = `
                    <div id="${previewId}" class="preview-image-wrapper">
                        <div class="d-flex align-items-center justify-content-center h-100 border rounded">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>`;
                imagePreviewContainer.insertAdjacentHTML('beforeend', loadingHtml);

                fetch(CLOUDINARY_API_URL, { method: 'POST', body: formData })
                    .then(response => response.json())
                    .then(data => {
                        const loadingElement = document.getElementById(previewId);
                        if (data.secure_url) {
                            addPreviewAndHiddenInput(loadingElement, data.secure_url);
                        } else {
                            loadingElement.remove();
                            console.error('Cloudinary upload error:', data);
                            alert('Có lỗi xảy ra khi tải ảnh. Vui lòng thử lại.');
                        }
                    })
                    .catch(error => {
                        const loadingElement = document.getElementById(previewId);
                        if(loadingElement) loadingElement.remove();
                        console.error('API fetch error:', error);
                        alert('Lỗi mạng. Không thể tải ảnh lên.');
                    });
            }

            function addPreviewAndHiddenInput(previewElement, imageUrl) {
                // Create hidden input
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'imageUrls';
                hiddenInput.value = imageUrl;
                hiddenInput.id = `hidden-${previewElement.id}`;
                hiddenInputsContainer.appendChild(hiddenInput);

                // Update preview content
                previewElement.innerHTML = `
                    <img src="${imageUrl}" class="preview-image" alt="Product Preview">
                    <button type="button" class="btn-remove-image" data-preview-id="${previewElement.id}">&times;</button>
                `;
                
                // Add primary badge if it's the first image
                if (hiddenInputsContainer.children.length === 1) {
                    addPrimaryBadge(previewElement);
                }

                // Add event listener for remove button
                previewElement.querySelector('.btn-remove-image').addEventListener('click', function() {
                    const wasPrimary = previewElement.querySelector('.primary-badge') !== null;
                    
                    document.getElementById(hiddenInput.id).remove();
                    previewElement.remove();

                    if (wasPrimary && imagePreviewContainer.children.length > 0) {
                        const newFirstPreview = imagePreviewContainer.firstElementChild;
                        addPrimaryBadge(newFirstPreview);
                    }
                });
            }

            function addPrimaryBadge(previewElement) {
                 if (previewElement.querySelector('.primary-badge')) return; // Badge already exists
                const badge = document.createElement('span');
                badge.className = 'primary-badge position-absolute bottom-0 start-0 bg-dark text-white small px-2 py-1 rounded-pill mb-2 ms-2';
                badge.textContent = 'Ảnh chính';
                previewElement.appendChild(badge);
            }
        });
    </script>
</th:block>

</body>
</html>
