<!-- resources/templates/layout/default.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title layout:title-pattern="$CONTENT_TITLE - $LAYOUT_TITLE">UTE Fashion</title>

    <!-- Favicon -->
    <link rel="icon" href="data:,">
    
    <!-- CSRF Meta Tags -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Page specific styles -->
    <th:block layout:fragment="styles"></th:block>
    
    <style>
        /* Cart Dropdown Animation */
        .cart-dropdown {
            animation: slideDown 0.3s ease-out;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            border: none;
            border-radius: 8px;
            overflow: hidden;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .cart-item {
            transition: background-color 0.2s;
        }
        
        .cart-item:hover {
            background-color: #f8f9fa;
        }
        
        .cart-items::-webkit-scrollbar {
            width: 6px;
        }
        
        .cart-items::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .cart-items::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
        
        .cart-items::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        #cartDropdown:hover i {
            transform: scale(1.1);
            transition: transform 0.2s;
        }
        
        .cart-item .btn-close {
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .cart-item:hover .btn-close {
            opacity: 1;
        }
        .btn-white {
            background-color: #fff;
            color: #111;
            border: 1px solid #ddd !important;
            transition: all 0.2s ease;
        }

        .btn-white:hover {
            background-color: #f8f9fa;
            color: #000;
            border-color: #111 !important;
        }
		
    </style>
</head>
<body style ="display: flex; flex-direction: column">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top">
        <div class="container">
            <a class="navbar-brand" href="/UTE_Fashion">
                <i class="fas fa-shopping-bag me-2"></i>UTE Fashion
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/UTE_Fashion">Trang chủ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/products}">Sản phẩm</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Giới thiệu</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/vendor/register}">Đăng ký shop</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Liên hệ</a>
                    </li>
                    <!-- Admin Menu - chỉ hiện với ADMIN -->
                    <li class="nav-item dropdown" th:if="${session.currentUser != null}">
                        <th:block th:each="role : ${session.currentUser.roles}">
                            <th:block th:if="${role.roleName == 'ADMIN'}">
                                <a class="nav-link dropdown-toggle text-danger fw-bold" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-shield-alt me-1"></i> Admin
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" th:href="@{/admin/orders/pending}">
                                        <i class="fas fa-clock me-2"></i>Đơn chờ xử lý
                                    </a></li>
                                    <li><a class="dropdown-item" th:href="@{/admin/orders}">
                                        <i class="fas fa-shopping-bag me-2"></i>Tất cả đơn hàng
                                    </a></li>
                                    <li><a class="dropdown-item" th:href="@{/admin/orders/returns}">
                                        <i class="fas fa-undo me-2"></i>Yêu cầu trả hàng
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" th:href="@{/admin/carriers}">
                                        <i class="fas fa-truck me-2"></i>Nhà vận chuyển
                                    </a></li>
                                    <li><a class="dropdown-item" th:href="@{/admin/products}">
                                        <i class="fas fa-box me-2"></i>Sản phẩm
                                    </a></li>
                                    <li><a class="dropdown-item" th:href="@{/admin/shippers}">
                                        <i class="fas fa-motorcycle me-2"></i>Shipper
                                    </a></li>
                                    <li><a class="dropdown-item" th:href="@{/admin/shops}">
                                        <i class="fas fa-shop me-2"></i>Shops
                                    </a></li>
                                </ul>
                            </th:block>
                        </th:block>
                    </li>
                    
                    <!-- Shipper Menu - chỉ hiện với SHIPPER -->
                    <li class="nav-item dropdown" th:if="${session.currentUser != null}">
                        <th:block th:each="role : ${session.currentUser.roles}">
                            <th:block th:if="${role.roleName == 'SHIPPER'}">
                                <a class="nav-link dropdown-toggle text-success fw-bold" href="#" id="shipperDropdown" role="button" data-bs-toggle="dropdown">
                                    <i class="fas fa-motorcycle me-1"></i> Shipper
                                </a>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" th:href="@{/shipper}">
                                        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="if(window.location.pathname.includes('/shipper') && typeof loadContent === 'function') { loadContent('orders'); return false; } else { window.location.href='/UTE_Fashion/shipper'; return false; }">
                                        <i class="fas fa-clipboard-list me-2"></i>Đơn được giao
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="if(window.location.pathname.includes('/shipper') && typeof loadContent === 'function') { loadContent('delivering'); return false; } else { window.location.href='/UTE_Fashion/shipper'; return false; }">
                                        <i class="fas fa-shipping-fast me-2"></i>Đơn đang giao
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="if(window.location.pathname.includes('/shipper') && typeof loadContent === 'function') { loadContent('history'); return false; } else { window.location.href='/UTE_Fashion/shipper'; return false; }">
                                        <i class="fas fa-history me-2"></i>Lịch sử
                                    </a></li>
                                </ul>
                            </th:block>
                        </th:block>
                    </li>
                    <li class="nav-item ms-3" th:if="${session.currentUser == null}">
                        <a class="btn btn-outline-primary btn-sm" th:href="@{/login}">
                            <i class="fas fa-sign-in-alt me-1"></i> Đăng nhập
                        </a>
                    </li>
                    <li class="nav-item dropdown ms-3" th:if="${session.currentUser != null}">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span th:text="${session.currentUser.fullName}"></span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" th:href="@{/profile}"><i class="fas fa-user me-2"></i>Thông tin cá nhân</a></li>
                            <li><a class="dropdown-item" th:href="@{/wishlist}"><i class="fas fa-heart me-2"></i>Danh sách yêu thích</a></li>
                            <li><a class="dropdown-item" th:href="@{/orders/my-orders}"><i class="fas fa-shopping-bag me-2"></i>Đơn hàng của tôi</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" th:href="@{/logout}"><i class="fas fa-sign-out-alt me-2"></i>Đăng xuất</a></li>
                        </ul>
                    </li>
                    <!-- Nút giỏ hàng với dropdown (cuối cùng) -->
                    <li class="nav-item dropdown ms-3">
                        <a class="nav-link position-relative" href="#" id="cartDropdown" role="button" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                            <i class="fas fa-shopping-cart fa-lg"></i>
                            <span th:if="${session.cartItemCount != null && session.cartItemCount > 0}" 
                                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" 
                                  th:text="${session.cartItemCount}">
                                <span class="visually-hidden">số lượng trong giỏ</span>
                            </span>
                        </a>
                        <!-- Cart Dropdown Menu -->
                        <div class="dropdown-menu dropdown-menu-end cart-dropdown p-0" aria-labelledby="cartDropdown" style="width: 380px; max-height: 500px;">
                            <div class="dropdown-header bg-dark text-white d-flex justify-content-between align-items-center">
                                <h6 class="mb-0" id="cartHeaderTitle"><i class="fas fa-shopping-cart me-2"></i>GIỎ HÀNG CỦA TÔI (0 SẢN PHẨM)</h6>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="dropdown"></button>
                            </div>
                            
                            <!-- Loading State -->
                            <div id="cartLoading" class="text-center p-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            
                            <!-- Empty Cart -->
                            <div id="cartEmpty" class="text-center p-4" style="display: none;">
                                <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Giỏ hàng của bạn đang trống</p>
                            </div>
                            
                            <!-- Cart Items -->
                            <div id="cartItemsContainer" class="cart-items" style="max-height: 300px; overflow-y: auto; display: none;">
                                <!-- Cart items sẽ được load bằng JavaScript -->
                            </div>
                            
                            <!-- Cart Summary -->
                            <div id="cartSummary" class="p-3 bg-light" style="display: none;">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="fw-bold">TẠM TÍNH:</span>
                                    <span id="cartTotalAmount" class="text-danger fw-bold fs-5">0₫</span>
                                </div>
                                <a th:href="@{/cart}" class="btn btn-dark w-100 mb-2">
                                    <i class="fas fa-shopping-cart me-2"></i>XEM GIỎ HÀNG
                                </a>
                                <a th:href="@{/checkout}" class="btn btn-white w-100">
                                    <i class="fas fa-credit-card me-2"></i>THANH TOÁN
                                </a>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main content -->
    <div layout:fragment="content"></div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container text-center">
            <p class="mb-0">
                <i class="fas fa-heart text-danger"></i> 
                UTE Fashion &copy; 2025 - Dự án Spring Boot
            </p>
            <p class="mb-0 mt-2">
                <small>Spring Boot + Thymeleaf + Bootstrap + JPA + WebSocket + SQL Server + Thymeleaf Layout Dialect</small>
            </p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Cart Dropdown Hover Script -->
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const cartDropdown = document.getElementById('cartDropdown');
            if (cartDropdown) {
                const cartDropdownElement = cartDropdown.parentElement;
                let timeoutId;
                let isDropdownShown = false;
                
                // Function để load cart data từ API
                function loadCartData() {
                    const apiUrl = /*[[@{/cart/api/mini-cart}]]*/ '/cart/api/mini-cart';
                    fetch(apiUrl)
                        .then(response => response.json())
                        .then(data => updateCartUI(data))
                        .catch(error => {
                            console.error('Error loading cart:', error);
                            showEmptyCart();
                        });
                }
                
                // Function để cập nhật UI
                function updateCartUI(cartData) {
                    document.getElementById('cartLoading').style.display = 'none';
                    
                    if (!cartData.cartItems || cartData.cartItems.length === 0) {
                        showEmptyCart();
                        return;
                    }
                    
                    const itemCount = cartData.cartItems.length;
                    document.getElementById('cartHeaderTitle').innerHTML = `<i class="fas fa-shopping-cart me-2"></i>GIỎ HÀNG CỦA TÔI (${itemCount} SẢN PHẨM)`;
                    
                    document.getElementById('cartEmpty').style.display = 'none';
                    document.getElementById('cartItemsContainer').style.display = 'block';
                    document.getElementById('cartSummary').style.display = 'block';
                    
                    let itemsHTML = '';
                    cartData.cartItems.forEach(item => {
                        const imageUrl = item.productImage || 'https://cdn.hstatic.net/products/200000182297/1.10_b8c81da853bd47bcb8dfe0addedfdd69_master.jpg';
                        const formattedTotal = new Intl.NumberFormat('vi-VN').format(item.totalPrice) + '₫';
                        
                        // Build variant info string
                        let variantInfo = '';
                        if (item.variantSize || item.variantColor) {
                            variantInfo = '<p class="mb-0 text-muted" style="font-size: 11px;">';
                            if (item.variantSize) {
                                variantInfo += `Size: <strong>${item.variantSize}</strong>`;
                            }
                            if (item.variantColor) {
                                variantInfo += item.variantSize ? ' / ' : '';
                                variantInfo += `<strong>${item.variantColor}</strong>`;
                            }
                            variantInfo += '</p>';
                        }
                        
                        let brandInfo = '';
                        if (item.brandName) {
                            brandInfo = `<p class="mb-0 text-muted" style="font-size: 11px;">Thương hiệu: <strong>${item.brandName}</strong></p>`;
                        }
                        
                        itemsHTML += `
                            <div class="cart-item d-flex p-3 border-bottom">
                                <img src="${imageUrl}" alt="${item.productName}" class="rounded" style="width: 80px; height: 100px; object-fit: cover;">
                                <div class="ms-3 flex-grow-1">
                                    <button type="button" class="btn-close float-end" style="font-size: 10px;" onclick="removeCartItem(${item.cartItemId})"></button>
                                    <h6 class="mb-1" style="font-size: 14px;">${item.productName}</h6>
                                    ${variantInfo}
                                    ${brandInfo}
                                    <p class="mb-0" style="font-size: 12px;">Số lượng: <strong>${item.quantity}</strong></p>
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <span class="text-danger fw-bold">${formattedTotal}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    document.getElementById('cartItemsContainer').innerHTML = itemsHTML;
                    const formattedTotal = new Intl.NumberFormat('vi-VN').format(cartData.totalAmount) + '₫';
                    document.getElementById('cartTotalAmount').textContent = formattedTotal;
                }
                
                function showEmptyCart() {
                    document.getElementById('cartLoading').style.display = 'none';
                    document.getElementById('cartEmpty').style.display = 'block';
                    document.getElementById('cartItemsContainer').style.display = 'none';
                    document.getElementById('cartSummary').style.display = 'none';
                    document.getElementById('cartHeaderTitle').innerHTML = '<i class="fas fa-shopping-cart me-2"></i>GIỎ HÀNG CỦA TÔI (0 SẢN PHẨM)';
                }
                
                // Khi HOVER vào icon giỏ hàng (không cần click)
                cartDropdownElement.addEventListener('mouseenter', function(e) {
                    e.preventDefault();
                    clearTimeout(timeoutId);
                    
                    if (!isDropdownShown) {
                        const dropdown = new bootstrap.Dropdown(cartDropdown, { autoClose: false });
                        dropdown.show();
                        isDropdownShown = true;
                        loadCartData();
                    }
                });
                
                // Khi rời chuột khỏi dropdown
                cartDropdownElement.addEventListener('mouseleave', function() {
                    timeoutId = setTimeout(function() {
                        const dropdown = bootstrap.Dropdown.getInstance(cartDropdown);
                        if (dropdown) {
                            dropdown.hide();
                            isDropdownShown = false;
                        }
                    }, 300);
                });
                
                // Ngăn chặn click vào dropdown từ việc đóng dropdown
                const dropdownMenu = cartDropdown.nextElementSibling;
                dropdownMenu.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
        });
        
        // Function xóa item khỏi cart
        function removeCartItem(cartItemId) {
            if (confirm('Bạn có chắc muốn xóa sản phẩm này?')) {
                // Use Thymeleaf URL building in template, then pass to JS
                const baseUrl = /*[[@{/cart/items/}]]*/ '/cart/items/';
                window.location.href = baseUrl + cartItemId + '/delete';
            }
        }
    </script>
    
    <!-- Page specific scripts -->
    <th:block layout:fragment="scripts"></th:block>
</body>
</html>
