<!DOCTYPE html>
<html
  lang="vi"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layout/default}"
>
  <head>
    <title>Chọn phương thức thanh toán</title>
    <th:block layout:fragment="styles">
      <style>
        .payment-card {
          transition: all 0.3s ease;
          border: 2px solid #dee2e6;
        }
        .payment-card:hover {
          transform: translateY(-5px);
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
          border-color: #0d6efd;
        }
        .payment-icon {
          font-size: 2.5rem;
          margin-bottom: 1rem;
        }

        /* Carrier Selection Styles */
        .carrier-option {
          cursor: pointer;
          display: block;
        }
        .carrier-radio {
          display: none;
        }
        .carrier-card {
          border: 2px solid #e0e0e0;
          border-radius: 8px;
          padding: 15px 20px;
          background: #fff;
          transition: all 0.3s ease;
        }
        .carrier-card:hover {
          border-color: #0d6efd;
          box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
        }
        .carrier-radio:checked + .carrier-card {
          border-color: #0d6efd;
          background: #f0f7ff;
          box-shadow: 0 2px 8px rgba(13, 110, 253, 0.2);
        }

        @keyframes shake {
          0%,
          100% {
            transform: translateX(0);
          }
          10%,
          30%,
          50%,
          70%,
          90% {
            transform: translateX(-5px);
          }
          20%,
          40%,
          60%,
          80% {
            transform: translateX(5px);
          }
        }
      </style>
    </th:block>
  </head>
  <body>
    <div class="container mt-5" layout:fragment="content">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a th:href="@{/cart}" class="text-decoration-none">Giỏ hàng</a>
          </li>
          <li class="breadcrumb-item">
            <a th:href="@{/checkout}" class="text-decoration-none"
              >Thông tin vận chuyển</a
            >
          </li>
          <li class="breadcrumb-item active" aria-current="page">
            Phương thức thanh toán
          </li>
        </ol>
      </nav>

      <h2 class="mb-4 fw-bold">PHƯƠNG THỨC THANH TOÁN</h2>

      <!-- Success Message -->
      <div
        th:if="${successMessage}"
        class="alert alert-success alert-dismissible fade show"
        role="alert"
      >
        <i class="fas fa-check-circle me-2"></i>
        <span th:text="${successMessage}"></span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>

      <!-- Error Message -->
      <div
        th:if="${errorMessage}"
        class="alert alert-danger alert-dismissible fade show"
        role="alert"
      >
        <i class="fas fa-exclamation-circle me-2"></i>
        <span th:text="${errorMessage}"></span>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>

      <div class="row">
        <!-- Left: Carrier, Coupon, Payment Methods -->
        <div class="col-md-7">
          <!-- Chọn nhà vận chuyển -->
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3 fw-bold">
                <i class="fas fa-truck me-2 text-primary"></i>Chọn loại vận
                chuyển
              </h5>
              <form
                th:action="@{/payment/select-carrier}"
                method="post"
                id="carrierForm"
              >
                <!-- Carrier Options as Cards -->
                <div class="row g-3">
                  <div class="col-12" th:each="carrier : ${carriers}">
                    <label class="carrier-option w-100">
                      <input
                        type="radio"
                        name="carrierId"
                        th:value="${carrier.id}"
                        th:checked="${selectedCarrierId != null and selectedCarrierId == carrier.id}"
                        class="carrier-radio"
                        onchange="this.form.submit()"
                        required
                      />
                      <div class="carrier-card">
                        <div
                          class="d-flex justify-content-between align-items-center"
                        >
                          <div>
                            <h6
                              class="mb-1 fw-bold"
                              th:text="${carrier.carrierName}"
                            ></h6>
                            <small class="text-muted"
                              >Thời gian: 2-3 ngày</small
                            >
                          </div>
                          <div class="text-end">
                            <div
                              class="text-primary fw-bold fs-5"
                              th:text="${#numbers.formatDecimal(carrier.defaultShippingFee, 0, 'COMMA', 0, 'POINT')} + '₫'"
                            ></div>
                          </div>
                        </div>
                      </div>
                    </label>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <!-- Nhập mã giảm giá (Coupon) -->
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">
                <i class="fas fa-tag me-2"></i>Mã giảm giá (Coupon)
              </h5>

              <!-- Hiển thị coupon đã áp dụng -->
              <div
                th:if="${appliedCouponCode != null}"
                class="alert alert-success d-flex justify-content-between align-items-center"
              >
                <span>
                  <i class="fas fa-check-circle me-2"></i>
                  Đã áp dụng:
                  <strong th:text="${appliedCouponCode}"></strong> (Giảm
                  <strong
                    th:text="${#numbers.formatDecimal(couponDiscount, 0, 'COMMA', 0, 'POINT')} + '₫'"
                  ></strong
                  >)
                </span>
                <form
                  th:action="@{/payment/remove-coupon}"
                  method="post"
                  class="d-inline"
                >
                  <button type="submit" class="btn btn-sm btn-outline-danger">
                    Xóa
                  </button>
                </form>
              </div>

              <!-- Form chọn coupon -->
              <div th:if="${appliedCouponCode == null}">
                <!-- Dropdown chọn coupon có sẵn -->
                <div
                  class="mb-3"
                  th:if="${availableCoupons != null and !availableCoupons.isEmpty()}"
                >
                  <label class="form-label">Chọn mã giảm giá:</label>
                  <form th:action="@{/payment/apply-coupon}" method="post">
                    <div class="row">
                      <div class="col-md-9">
                        <select name="couponCode" class="form-select" required>
                          <option value="">-- Chọn mã giảm giá --</option>
                          <option
                            th:each="coupon : ${availableCoupons}"
                            th:value="${coupon.couponCode}"
                            th:text="${coupon.couponCode + ' - Giảm ' + 
                                                              (coupon.discountType == 'PERCENTAGE' ? 
                                                               coupon.discountValue + '%' : 
                                                               #numbers.formatDecimal(coupon.discountValue, 0, 'COMMA', 0, 'POINT') + '₫') + 
                                                              ' (Đơn tối thiểu: ' + 
                                                              #numbers.formatDecimal(coupon.minOrderValue, 0, 'COMMA', 0, 'POINT') + '₫)'}"
                          ></option>
                        </select>
                      </div>
                      <div class="col-md-3">
                        <button type="submit" class="btn btn-success w-100">
                          Áp dụng
                        </button>
                      </div>
                    </div>
                  </form>
                </div>

                <!-- Hoặc nhập mã thủ công -->
                <form th:action="@{/payment/apply-coupon}" method="post">
                  <label class="form-label">Hoặc nhập mã:</label>
                  <div class="row">
                    <div class="col-md-9">
                      <input
                        type="text"
                        name="couponCode"
                        class="form-control"
                        placeholder="Nhập mã giảm giá"
                        required
                      />
                    </div>
                    <div class="col-md-3">
                      <button type="submit" class="btn btn-success w-100">
                        Áp dụng
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <!-- Mã khuyến mãi (Promotion) -->
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <h5 class="card-title mb-3">
                <i class="fas fa-gift me-2"></i>Mã khuyến mãi (Promotion)
              </h5>

              <!-- Hiển thị promotion đã áp dụng -->
              <div
                th:if="${appliedPromotionId != null}"
                class="alert alert-success d-flex justify-content-between align-items-center"
              >
                <span>
                  <i class="fas fa-check-circle me-2"></i>
                  Đã áp dụng khuyến mãi (Giảm
                  <strong
                    th:text="${#numbers.formatDecimal(promotionDiscount, 0, 'COMMA', 0, 'POINT')} + '₫'"
                  ></strong
                  >)
                </span>
                <form
                  th:action="@{/payment/remove-promotion}"
                  method="post"
                  class="d-inline"
                >
                  <button type="submit" class="btn btn-sm btn-outline-danger">
                    Xóa
                  </button>
                </form>
              </div>

              <!-- Form chọn promotion -->
              <div th:if="${appliedPromotionId == null}">
                <div
                  th:if="${availablePromotions != null and !availablePromotions.isEmpty()}"
                >
                  <label class="form-label">Chọn khuyến mãi:</label>
                  <form th:action="@{/payment/apply-promotion}" method="post">
                    <div class="row">
                      <div class="col-md-9">
                        <select name="promotionId" class="form-select" required>
                          <option value="">-- Chọn khuyến mãi --</option>
                          <option
                            th:each="promo : ${availablePromotions}"
                            th:value="${promo.id}"
                            th:text="${promo.promotionName + ' - Giảm ' + 
                                                              (promo.discountType.name() == 'PERCENTAGE' ? 
                                                               promo.discountValue + '%' : 
                                                               #numbers.formatDecimal(promo.discountValue, 0, 'COMMA', 0, 'POINT') + '₫') + 
                                                              ' (Đơn tối thiểu: ' + 
                                                              #numbers.formatDecimal(promo.minOrderValue, 0, 'COMMA', 0, 'POINT') + '₫)'}"
                          ></option>
                        </select>
                      </div>
                      <div class="col-md-3">
                        <button type="submit" class="btn btn-primary w-100">
                          Áp dụng
                        </button>
                      </div>
                    </div>
                  </form>
                </div>
                <div
                  th:if="${availablePromotions == null or availablePromotions.isEmpty()}"
                  class="text-muted"
                >
                  <small>Hiện không có khuyến mãi nào.</small>
                </div>
              </div>
            </div>
          </div>

          <!-- Chọn phương thức thanh toán -->
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title mb-4">
                <i class="fas fa-credit-card me-2"></i>Phương thức thanh toán
              </h5>
              <div class="row">
                <div class="col-md-6 mb-3" th:each="method : ${paymentMethods}">
                  <div class="card payment-card h-100">
                    <div class="card-body text-center">
                      <!-- Icon for COD -->
                      <div
                        class="payment-icon"
                        th:if="${method.methodCode == 'COD'}"
                      >
                        <i class="fas fa-money-bill-wave text-success"></i>
                      </div>

                      <!-- Icon for SePay QR -->
                      <div
                        class="payment-icon"
                        th:if="${method.methodCode == 'SEPAY_QR'}"
                      >
                        <i class="fas fa-qrcode text-primary"></i>
                      </div>

                      <!-- Icon for COIN -->
                      <div
                        class="payment-icon"
                        th:if="${method.methodCode == 'COIN'}"
                      >
                        <i class="fas fa-coins text-warning"></i>
                      </div>

                      <h6
                        class="card-title"
                        th:text="${method.methodName}"
                      ></h6>
                      <p
                        class="card-text text-muted small"
                        th:text="${method.description}"
                      ></p>

                      <!-- Hiển thị số xu hiện có cho COIN -->
                      <div th:if="${method.methodCode == 'COIN'}" class="mb-2">
                        <small class="text-info">
                          <i class="fas fa-wallet me-1"></i>
                          Số xu hiện có:
                          <strong
                            th:text="${#numbers.formatDecimal(userCoins, 0, 'COMMA', 0, 'POINT')}"
                          ></strong>
                          xu
                        </small>
                      </div>

                      <!-- COD Form -->
                      <form
                        th:if="${method.methodCode == 'COD'}"
                        th:action="@{/payment/confirm-cod}"
                        method="post"
                      >
                        <button type="submit" class="btn btn-success w-100">
                          <i class="fas fa-check-circle"></i> Chọn
                        </button>
                      </form>

                      <!-- SePay QR Form -->
                      <form
                        th:if="${method.methodCode == 'SEPAY_QR'}"
                        th:action="@{/payment/sepay-qr/create}"
                        method="post"
                      >
                        <button type="submit" class="btn btn-primary w-100">
                          <i class="fas fa-qrcode"></i> Chọn
                        </button>
                      </form>

                      <!-- COIN Form -->
                      <form
                        th:if="${method.methodCode == 'COIN'}"
                        th:action="@{/payment/confirm-coin}"
                        method="post"
                      >
                        <button
                          type="submit"
                          class="btn btn-warning w-100 text-white"
                        >
                          <i class="fas fa-coins"></i> Thanh toán bằng xu
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: Order Summary -->
        <div class="col-md-5">
          <div class="card shadow-sm sticky-top" style="top: 20px">
            <div class="card-body">
              <h5 class="card-title mb-4">
                <i class="fas fa-receipt me-2"></i>Chi tiết thanh toán
              </h5>

              <!-- Subtotal -->
              <div class="d-flex justify-content-between mb-2">
                <span>Tạm tính:</span>
                <span
                  th:text="${subtotal != null && subtotal > 0 ? (#numbers.formatDecimal(subtotal, 0, 'COMMA', 0, 'POINT') + '₫') : '0₫'}"
                ></span>
              </div>

              <!-- Shipping Fee -->
              <div class="d-flex justify-content-between mb-2">
                <span>Phí vận chuyển:</span>
                <span
                  th:if="${shippingFee != null}"
                  th:text="${#numbers.formatDecimal(shippingFee, 0, 'COMMA', 0, 'POINT')} + '₫'"
                ></span>
                <span th:if="${shippingFee == null}" class="text-muted"
                  >Chưa chọn</span
                >
              </div>

              <!-- Coupon Discount -->
              <div
                th:if="${couponDiscount != null}"
                class="d-flex justify-content-between mb-2 text-success"
              >
                <span> <i class="fas fa-tag me-1"></i>Giảm (Coupon): </span>
                <span
                  th:text="'-' + ${#numbers.formatDecimal(couponDiscount, 0, 'COMMA', 0, 'POINT')} + '₫'"
                ></span>
              </div>

              <!-- Promotion Discount -->
              <div
                th:if="${promotionDiscount != null}"
                class="d-flex justify-content-between mb-2 text-success"
              >
                <span> <i class="fas fa-gift me-1"></i>Giảm (Promotion): </span>
                <span
                  th:text="'-' + ${#numbers.formatDecimal(promotionDiscount, 0, 'COMMA', 0, 'POINT')} + '₫'"
                ></span>
              </div>

              <!-- Total Discount -->
              <div
                th:if="${totalDiscount != null and totalDiscount > 0}"
                class="d-flex justify-content-between mb-2 text-success fw-bold"
              >
                <span> <i class="fas fa-percent me-1"></i>Tổng giảm: </span>
                <span
                  th:text="'-' + ${#numbers.formatDecimal(totalDiscount, 0, 'COMMA', 0, 'POINT')} + '₫'"
                ></span>
              </div>

              <hr />

              <!-- Final Total -->
              <div class="d-flex justify-content-between">
                <h5 class="mb-0">Tổng cộng:</h5>
                <h5
                  class="mb-0 text-danger"
                  th:text="${#numbers.formatDecimal(finalTotal, 0, 'COMMA', 0, 'POINT')} + '₫'"
                ></h5>
              </div>

              <hr />

              <div class="alert alert-info small mb-0">
                <i class="fas fa-info-circle me-1"></i>
                Vui lòng chọn nhà vận chuyển và phương thức thanh toán để hoàn
                tất đơn hàng.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Back Button -->
      <a th:href="@{/checkout}" class="btn btn-secondary mt-3">
        <i class="fas fa-arrow-left"></i> Quay lại thông tin giao hàng
      </a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Toast Container -->
    <div
      style="position: fixed; top: 80px; right: 20px; z-index: 9999"
      id="toast-container"
    ></div>

    <script>
      // Show toast notification
      function showToast(message, type = "warning") {
        const toastContainer = document.getElementById("toast-container");

        // Icon based on type
        const icons = {
          warning: '<i class="fas fa-exclamation-triangle"></i>',
          success: '<i class="fas fa-check-circle"></i>',
          error: '<i class="fas fa-times-circle"></i>',
          info: '<i class="fas fa-info-circle"></i>',
        };

        // Colors based on type
        const colors = {
          warning: "#ffc107",
          success: "#28a745",
          error: "#dc3545",
          info: "#17a2b8",
        };

        const toastId = "toast-" + Date.now();
        const toast = document.createElement("div");
        toast.id = toastId;
        toast.className =
          "alert alert-" + type + " alert-dismissible fade show";
        toast.style.cssText = `
                min-width: 300px;
                margin-bottom: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border-left: 4px solid ${colors[type]};
                animation: slideInRight 0.3s ease-out;
            `;
        toast.innerHTML = `
                <strong>${icons[type]}</strong> ${message}
            `;

        toastContainer.appendChild(toast);

        // Auto remove after 2s
        setTimeout(() => {
          toast.style.animation = "slideOutRight 0.3s ease-out";
          setTimeout(() => {
            if (toast.parentElement) {
              toast.remove();
            }
          }, 300);
        }, 2000);
      }

      // Add animation keyframes
      const style = document.createElement("style");
      style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(100%);
                    opacity: 0;
                }
            }
        `;
      document.head.appendChild(style);

      // Validation: Bắt buộc chọn carrier trước khi thanh toán
      document.addEventListener("DOMContentLoaded", function () {
        // Get all payment method forms
        const paymentForms = document.querySelectorAll(
          'form[action*="/payment/confirm"], form[action*="/payment/sepay"]'
        );

        paymentForms.forEach((form) => {
          form.addEventListener("submit", function (e) {
            // Check if carrier is selected
            const carrierSelected = document.querySelector(
              'input[name="carrierId"]:checked'
            );

            if (!carrierSelected) {
              e.preventDefault();

              // Highlight carrier section
              const carrierCard = document.querySelector(
                ".card.shadow-sm.mb-4"
              );
              carrierCard.style.border = "2px solid #dc3545";
              carrierCard.style.animation = "shake 0.5s";

              // Show toast instead of alert
              showToast(
                "Vui lòng chọn nhà vận chuyển trước khi thanh toán!",
                "warning"
              );

              // Scroll to carrier section
              carrierCard.scrollIntoView({
                behavior: "smooth",
                block: "center",
              });

              // Remove highlight after 3s
              setTimeout(() => {
                carrierCard.style.border = "";
                carrierCard.style.animation = "";
              }, 3000);

              return false;
            }
          });
        });
      });
    </script>
  </body>
</html>
