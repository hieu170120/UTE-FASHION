<!DOCTYPE html>
<html lang="vi"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title>Thanh to√°n</title>
</head>
<body>

<div class="container mt-5" layout:fragment="content">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/}" class="text-decoration-none">Gi·ªè h√†ng</a></li>
            <li class="breadcrumb-item active" aria-current="page">Th√¥ng tin v·∫≠n chuy·ªÉn</li>
            <li class="breadcrumb-item text-muted">Ph∆∞∆°ng th·ª©c thanh to√°n</li>
        </ol>
    </nav>
    
    <h2 class="mb-4 fw-bold">THANH TO√ÅN</h2>

    <!-- Error Message -->
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fas fa-exclamation-circle me-2"></i>
        <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="row">
        <!-- Form th√¥ng tin giao h√†ng -->
        <div class="col-md-7">
            <form th:action="@{/checkout}" th:object="${orderDTO}" method="post">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-4">
                            <i class="fas fa-shipping-fast me-2"></i>Th√¥ng tin giao h√†ng
                        </h5>
                    <div class="mb-3">
                        <label for="recipientName" class="form-label">H·ªç v√† t√™n</label>
                        <input type="text" class="form-control" id="recipientName" th:field="*{recipientName}" required>
                        <div class="text-danger small mt-1" th:if="${#fields.hasErrors('recipientName')}" th:errors="*{recipientName}"></div>
                    </div>
                    <div class="mb-3">
                        <label for="phoneNumber" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="tel" class="form-control" id="phoneNumber" th:field="*{phoneNumber}" required>
                        <div class="text-danger small mt-1" th:if="${#fields.hasErrors('phoneNumber')}" th:errors="*{phoneNumber}"></div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" th:field="*{email}">
                    </div>
                    <div class="mb-3">
                        <label for="shippingAddress" class="form-label">ƒê·ªãa ch·ªâ giao h√†ng</label>
                        <input type="text" class="form-control" id="shippingAddress" th:field="*{shippingAddress}" required>
                        <div class="text-danger small mt-1" th:if="${#fields.hasErrors('shippingAddress')}" th:errors="*{shippingAddress}"></div>
                    </div>
                    <div class="mb-3">
                        <label for="city" class="form-label">T·ªânh/Th√†nh ph·ªë <span class="text-danger">*</span></label>
                        <select class="form-select" id="city" name="city" required>
                            <option value="">-- Ch·ªçn t·ªânh/th√†nh ph·ªë --</option>
                        </select>
                        <input type="hidden" th:field="*{city}" id="cityHidden">
                        <div class="text-danger small mt-1" th:if="${#fields.hasErrors('city')}" th:errors="*{city}"></div>
                    </div>
                    <div class="mb-3">
                        <label for="district" class="form-label">Qu·∫≠n/Huy·ªán <span class="text-danger">*</span></label>
                        <select class="form-select" id="district" name="district" required disabled>
                            <option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>
                        </select>
                        <input type="hidden" th:field="*{district}" id="districtHidden">
                        <div class="text-danger small mt-1" th:if="${#fields.hasErrors('district')}" th:errors="*{district}"></div>
                    </div>
                    <div class="mb-3">
                        <label for="ward" class="form-label">Ph∆∞·ªùng/X√£</label>
                        <select class="form-select" id="ward" name="ward" disabled>
                            <option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>
                        </select>
                        <input type="hidden" th:field="*{ward}" id="wardHidden">
                    </div>
                    <div class="mb-3">
                        <label for="postalCode" class="form-label">M√£ b∆∞u ƒëi·ªán</label>
                        <input type="text" class="form-control" id="postalCode" th:field="*{postalCode}">
                    </div>
                        <div class="mb-3">
                            <label for="customerNotes" class="form-label">Ghi ch√∫</label>
                            <textarea class="form-control" id="customerNotes" th:field="*{customerNotes}" rows="3" placeholder="Ghi ch√∫ v·ªÅ ƒë∆°n h√†ng (t√πy ch·ªçn)"></textarea>
                        </div>
                    </div>
                </div>
                
               
                
                <!-- N√∫t ti·∫øp t·ª•c -->
                <button type="submit" class="btn btn-dark btn-lg w-100" style="border-radius: 25px;">
                    <i class="fas fa-arrow-right me-2"></i>Ti·∫øp t·ª•c ƒë·∫øn ph∆∞∆°ng th·ª©c thanh to√°n
                </button>
            </form>
        </div>
        
        <!-- T√≥m t·∫Øt ƒë∆°n h√†ng -->
        <div class="col-md-5">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-shopping-bag me-2"></i>ƒê∆°n h√†ng c·ªßa b·∫°n
                    </h5>
                    
                    <!-- Danh s√°ch s·∫£n ph·∫©m -->
                    <div class="mb-3" style="max-height: 400px; overflow-y: auto;">
                        <div th:if="${cart == null || cart.cartItems == null || cart.cartItems.isEmpty()}" class="text-center text-muted p-3">
                            <i class="fas fa-shopping-cart fa-2x mb-2"></i>
                            <p>Gi·ªè h√†ng tr·ªëng</p>
                        </div>
                        <div class="d-flex align-items-center mb-3 pb-3 border-bottom" th:each="item : ${cart.cartItems}" th:if="${cart != null && cart.cartItems != null}">
                            <img th:src="${item.productImage}" alt="Product"
                                 class="rounded" style="width: 60px; height: 75px; object-fit: cover;">
                            <div class="ms-3 flex-grow-1">
                                <h6 class="mb-1" style="font-size: 14px;" th:text="${item.productName}"></h6>
                                <p class="mb-0 text-muted" style="font-size: 12px;">
                                    <span th:if="${item.variantSize != null}">
                                        Size: <strong th:text="${item.variantSize}"></strong>
                                    </span>
                                    <span th:if="${item.variantColor != null}">
                                        / <strong th:text="${item.variantColor}"></strong>
                                    </span>
                                </p>
                                <p class="mb-0" style="font-size: 13px;">
                                    <span>S·ªë l∆∞·ª£ng: </span>
                                    <strong th:text="${item.quantity}"></strong>
                                </p>
                            </div>
                            <div class="text-end">
                                <p class="mb-0 fw-bold text-danger" th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'COMMA', 0, 'POINT')} + '‚Ç´'"></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- T·ªïng ti·ªÅn -->
                    <hr>
                    <div class="d-flex justify-content-between">
                        <h5 class="mb-0">T·∫°m t√≠nh:</h5>
                        <h5 class="mb-0 text-danger" th:text="${cart != null ? (#numbers.formatDecimal(cart.totalAmount, 0, 'COMMA', 0, 'POINT') + '‚Ç´') : '0‚Ç´'}"></h5>
                    </div>
                    <p class="text-muted small mt-2 mb-0">
                        <i class="fas fa-info-circle me-1"></i>
                        Ph√≠ v·∫≠n chuy·ªÉn v√† khuy·∫øn m√£i s·∫Ω ƒë∆∞·ª£c t√≠nh ·ªü b∆∞·ªõc ti·∫øp theo
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script src="/UTE_Fashion/static/js/tracking.js"></script>
    <script>
        // API ƒê·ªãa ch·ªâ Vi·ªát Nam (Public API)
        const BASE_API = 'https://provinces.open-api.vn/api';
        
        document.addEventListener('DOMContentLoaded', async function() {
            await loadProvinces();
            
            // üìä Track checkout cho t·∫•t c·∫£ s·∫£n ph·∫©m trong gi·ªè h√†ng
            const cart = /*[[${cart}]]*/ null;
            console.log('üìä Cart:', cart);
            
            let productIds = [];
            if (cart && cart.cartItems && Array.isArray(cart.cartItems)) {
                productIds = cart.cartItems
                    .filter(item => item && item.productId)
                    .map(item => item.productId);
            }
            
            console.log('üìä Checkout page loaded');
            console.log('üìä Product IDs in cart:', productIds);
            
            // Track t·ª´ng s·∫£n ph·∫©m (ƒë·ªÉ track cho m·ªói shop)
            if (productIds.length > 0) {
                // G·ªçi API ƒë·ªÉ l·∫•y danh s√°ch unique shop IDs t·ª´ product IDs
                trackCheckoutByProducts(productIds);
            } else {
                console.warn('‚ö†Ô∏è No products found in cart');
            }
        });
        
        // Track checkout cho nhi·ªÅu s·∫£n ph·∫©m
        async function trackCheckoutByProducts(productIds) {
            try {
                // L·∫•y context path t·ª´ URL hi·ªán t·∫°i
                const contextPath = window.location.pathname.split('/')[1];
                const apiUrl = `/${contextPath}/api/analytics/track/checkout-batch`;
                
                console.log('üì° Calling API:', apiUrl);
                console.log('üì¶ Payload:', { productIds: productIds });
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productIds: productIds })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Checkout tracked successfully!', result);
                } else {
                    const msg = await response.text();
                    console.error('‚ùå Failed:', msg);
                }
            } catch (err) {
                console.error('‚ùå Error:', err);
            }
        }
        
        // Load danh s√°ch t·ªânh/th√†nh ph·ªë
        async function loadProvinces() {
            try {
                const response = await fetch(`${BASE_API}/p/`);
                const provinces = await response.json();
                
                const citySelect = document.getElementById('city');
                citySelect.innerHTML = '<option value="">-- Ch·ªçn t·ªânh/th√†nh ph·ªë --</option>';
                
                provinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province.code;
                    option.textContent = province.name;
                    option.setAttribute('data-name', province.name);
                    citySelect.appendChild(option);
                });
            } catch (error) {
                console.error('L·ªói khi load t·ªânh/th√†nh ph·ªë:', error);
            }
        }
        
        // Khi ch·ªçn t·ªânh/th√†nh ph·ªë
        document.getElementById('city').addEventListener('change', async function() {
            const provinceCode = this.value;
            const provinceName = this.options[this.selectedIndex]?.getAttribute('data-name');
            
            // C·∫≠p nh·∫≠t hidden input
            document.getElementById('cityHidden').value = provinceName || '';
            
            // Reset district v√† ward
            const districtSelect = document.getElementById('district');
            const wardSelect = document.getElementById('ward');
            districtSelect.innerHTML = '<option value="">-- Ch·ªçn qu·∫≠n/huy·ªán --</option>';
            wardSelect.innerHTML = '<option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>';
            districtSelect.disabled = true;
            wardSelect.disabled = true;
            document.getElementById('districtHidden').value = '';
            document.getElementById('wardHidden').value = '';
            
            if (!provinceCode) return;
            
            // Load danh s√°ch qu·∫≠n/huy·ªán
            try {
                const response = await fetch(`${BASE_API}/p/${provinceCode}?depth=2`);
                const data = await response.json();
                
                if (data.districts && data.districts.length > 0) {
                    data.districts.forEach(district => {
                        const option = document.createElement('option');
                        option.value = district.code;
                        option.textContent = district.name;
                        option.setAttribute('data-name', district.name);
                        districtSelect.appendChild(option);
                    });
                    districtSelect.disabled = false;
                }
            } catch (error) {
                console.error('L·ªói khi load qu·∫≠n/huy·ªán:', error);
            }
        });
        
        // Khi ch·ªçn qu·∫≠n/huy·ªán
        document.getElementById('district').addEventListener('change', async function() {
            const districtCode = this.value;
            const districtName = this.options[this.selectedIndex]?.getAttribute('data-name');
            
            // C·∫≠p nh·∫≠t hidden input
            document.getElementById('districtHidden').value = districtName || '';
            
            // Reset ward
            const wardSelect = document.getElementById('ward');
            wardSelect.innerHTML = '<option value="">-- Ch·ªçn ph∆∞·ªùng/x√£ --</option>';
            wardSelect.disabled = true;
            document.getElementById('wardHidden').value = '';
            
            if (!districtCode) return;
            
            // Load danh s√°ch ph∆∞·ªùng/x√£
            try {
                const response = await fetch(`${BASE_API}/d/${districtCode}?depth=2`);
                const data = await response.json();
                
                if (data.wards && data.wards.length > 0) {
                    data.wards.forEach(ward => {
                        const option = document.createElement('option');
                        option.value = ward.code;
                        option.textContent = ward.name;
                        option.setAttribute('data-name', ward.name);
                        wardSelect.appendChild(option);
                    });
                    wardSelect.disabled = false;
                }
            } catch (error) {
                console.error('L·ªói khi load ph∆∞·ªùng/x√£:', error);
            }
        });
        
        // Khi ch·ªçn ph∆∞·ªùng/x√£
        document.getElementById('ward').addEventListener('change', function() {
            const wardName = this.options[this.selectedIndex]?.getAttribute('data-name');
            document.getElementById('wardHidden').value = wardName || '';
        });
    </script>
</th:block>

</body>
</html>
