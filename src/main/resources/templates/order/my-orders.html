<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title>Đơn Hàng Của Tôi</title>
    <th:block layout:fragment="styles">
        <style>
            /* Status badges with modern gradients */
            .status-badge {
                padding: 8px 20px;
                border-radius: 24px;
                font-size: 13px;
                font-weight: 700;
                display: inline-flex;
                align-items: center;
                gap: 8px;
            }
            .status-Processing { 
                background: linear-gradient(135deg, #FCD34D 0%, #F59E0B 100%); 
                color: #78350F;
            }
            .status-Confirmed { 
                background: linear-gradient(135deg, #60A5FA 0%, #3B82F6 100%); 
                color: #fff;
            }
            .status-Shipping { 
                background: linear-gradient(135deg, #A78BFA 0%, #8B5CF6 100%); 
                color: #fff;
            }
            .status-Delivered { 
                background: linear-gradient(135deg, #34D399 0%, #10B981 100%); 
                color: #fff;
            }
            .status-Return_Requested { 
                background: linear-gradient(135deg, #FB923C 0%, #F97316 100%); 
                color: #fff;
            }
            .status-Returned { 
                background: linear-gradient(135deg, #94A3B8 0%, #64748B 100%); 
                color: #fff;
            }
            .status-Cancelled { 
                background: linear-gradient(135deg, #F87171 0%, #EF4444 100%); 
                color: #fff;
            }
            
            /* Order card styling */
            .order-card {
                border: 2px solid #e9ecef;
                border-radius: 16px;
                padding: 28px;
                margin-bottom: 30px;
                transition: all 0.3s;
                background: white;
            }
            .order-card:hover {
                border-color: #3B82F6;
                box-shadow: 0 8px 30px rgba(59, 130, 246, 0.15);
                transform: translateY(-2px);
            }
            
            /* Progress timeline for order status */
            .order-progress {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin: 24px 0;
                position: relative;
                padding: 0 20px;
            }
            .order-progress::before {
                content: '';
                position: absolute;
                top: 20px;
                left: 60px;
                right: 60px;
                height: 3px;
                background: #E5E7EB;
                z-index: 0;
            }
            .progress-step {
                display: flex;
                flex-direction: column;
                align-items: center;
                flex: 1;
                position: relative;
                z-index: 1;
            }
            .progress-step .icon {
                width: 44px;
                height: 44px;
                border-radius: 50%;
                background: #E5E7EB;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #9CA3AF;
                font-size: 18px;
                margin-bottom: 10px;
                transition: all 0.3s;
                border: 3px solid white;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .progress-step.completed .icon {
                background: #10B981;
                color: white;
            }
            .progress-step.active .icon {
                background: #3B82F6;
                color: white;
                animation: pulse-ring 2s infinite;
            }
            @keyframes pulse-ring {
                0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
                50% { box-shadow: 0 0 0 12px rgba(59, 130, 246, 0); }
            }
            .progress-step .label {
                font-size: 12px;
                text-align: center;
                color: #6B7280;
                font-weight: 600;
                max-width: 90px;
                line-height: 1.3;
            }
            .progress-step.completed .label,
            .progress-step.active .label {
                color: #1F2937;
                font-weight: 700;
            }
            .progress-step small {
                display: block;
                font-size: 10px;
                margin-top: 4px;
                text-align: center;
            }
            
            /* Action buttons */
            .action-buttons {
                display: flex;
                gap: 12px;
                flex-wrap: wrap;
            }
            
            /* Empty state */
            .empty-state {
                text-align: center;
                padding: 80px 20px;
                background: white;
                border-radius: 20px;
                border: 2px dashed #E5E7EB;
            }
            .empty-state i {
                font-size: 80px;
                color: #D1D5DB;
                margin-bottom: 24px;
            }
            
            /* Timeline for order history */
            .timeline {
                position: relative;
                padding-left: 30px;
            }
            .timeline::before {
                content: '';
                position: absolute;
                left: 8px;
                top: 0;
                bottom: 0;
                width: 2px;
                background: #E5E7EB;
            }
            .timeline-item {
                position: relative;
                padding-bottom: 20px;
            }
            .timeline-item:last-child {
                padding-bottom: 0;
            }
            .timeline-marker {
                position: absolute;
                left: -26px;
                width: 16px;
                height: 16px;
                border-radius: 50%;
                border: 3px solid white;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .timeline-content {
                background: white;
                padding: 12px 16px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            }
        </style>
    </th:block>
</head>
<body>
<div layout:fragment="content" class="container my-5">
    <h2 class="mb-4 fw-bold">
        <i class="fas fa-shopping-bag text-primary"></i> Đơn Hàng Của Tôi
    </h2>

    <!-- Flash Messages -->
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show">
        <i class="fas fa-check-circle"></i> <span th:text="${successMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
        <i class="fas fa-exclamation-circle"></i> <span th:text="${errorMessage}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Empty State -->
    <div th:if="${#lists.isEmpty(orders)}" class="empty-state">
        <i class="fas fa-shopping-bag"></i>
        <h4 class="text-muted mb-3">Bạn chưa có đơn hàng nào</h4>
        <p class="text-muted">Hãy bắt đầu mua sắm để tạo đơn hàng đầu tiên!</p>
        <a href="/products" class="btn btn-primary btn-lg mt-3">
            <i class="fas fa-shopping-cart me-2"></i> Mua Sắm Ngay
        </a>
    </div>

    <!-- Order List -->
    <div th:each="order : ${orders}" class="order-card">
        <!-- Order Header -->
        <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
                <h5 class="fw-bold mb-1">
                    <i class="fas fa-receipt text-primary me-2"></i>
                    <span th:text="${order.orderNumber}">ORD-12345</span>
                </h5>
                <small class="text-muted">
                    <i class="far fa-clock me-1"></i> 
                    <span th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}"></span>
                </small>
            </div>
            <span class="status-badge" th:classappend="'status-' + ${order.orderStatus}">
                <i class="fas" 
                   th:classappend="${order.orderStatus == 'Processing' ? 'fa-hourglass-half' :
                                    order.orderStatus == 'Confirmed' ? 'fa-check-circle' :
                                    order.orderStatus == 'Shipping' ? 'fa-truck' :
                                    order.orderStatus == 'Delivered' ? 'fa-check-double' :
                                    order.orderStatus == 'Cancelled' ? 'fa-times-circle' :
                                    order.orderStatus == 'Return_Requested' ? 'fa-undo' : 'fa-reply'}"></i>
                <span th:text="${order.orderStatus == 'Processing' ? 'Đang xử lý' :
                                order.orderStatus == 'Confirmed' ? 'Đã xử lý đơn hàng' :
                                order.orderStatus == 'Shipping' ? 'Đang giao' :
                                order.orderStatus == 'Delivered' ? 'Đã giao' :
                                order.orderStatus == 'Cancelled' ? 'Đã hủy' :
                                order.orderStatus == 'Return_Requested' ? 'Yêu cầu trả hàng' : 'Đã trả hàng'}">
                </span>
            </span>
        </div>

        <!-- Order Progress Timeline with detailed info -->
        <div th:if="${order.orderStatus != 'Cancelled' && order.orderStatus != 'Returned'}" 
             class="order-progress mb-4">
            <!-- Step 1: Processing -->
            <div class="progress-step" 
                 th:classappend="${order.orderStatus == 'Processing' ? 'active' : 
                                  (order.orderStatus == 'Confirmed' || order.orderStatus == 'Shipping' || order.orderStatus == 'Delivered' || order.orderStatus == 'Return_Requested') ? 'completed' : ''}">
                <div class="icon"><i class="fas fa-file-alt"></i></div>
                <div class="label">Đang xử lý</div>
                <small class="text-muted" th:if="${order.orderDate}" 
                       th:text="${#temporals.format(order.orderDate, 'dd/MM HH:mm')}"></small>
            </div>
            
            <!-- Step 2: Confirmed -->
            <div class="progress-step" 
                 th:classappend="${order.orderStatus == 'Confirmed' ? 'active' : 
                                  (order.orderStatus == 'Shipping' || order.orderStatus == 'Delivered' || order.orderStatus == 'Return_Requested') ? 'completed' : ''}">
                <div class="icon"><i class="fas fa-user-check"></i></div>
                <div class="label">Đã xử lý</div>
                <small class="text-muted" th:if="${order.confirmedAt}" 
                       th:text="${#temporals.format(order.confirmedAt, 'dd/MM HH:mm')}"></small>
            </div>
            
            <!-- Step 3: Shipping -->
            <div class="progress-step" 
                 th:classappend="${order.orderStatus == 'Shipping' ? 'active' : 
                                  (order.orderStatus == 'Delivered' || order.orderStatus == 'Return_Requested') ? 'completed' : ''}">
                <div class="icon"><i class="fas fa-shipping-fast"></i></div>
                <div class="label">Đang giao</div>
                <small class="text-muted" th:if="${order.shippedAt}" 
                       th:text="${#temporals.format(order.shippedAt, 'dd/MM HH:mm')}"></small>
            </div>
            
            <!-- Step 4: Delivered -->
            <div class="progress-step" 
                 th:classappend="${order.orderStatus == 'Delivered' || order.orderStatus == 'Return_Requested' ? 'completed' : ''}">
                <div class="icon"><i class="fas fa-box-open"></i></div>
                <div class="label">Đã giao</div>
                <small class="text-muted" th:if="${order.deliveredAt}" 
                       th:text="${#temporals.format(order.deliveredAt, 'dd/MM HH:mm')}"></small>
            </div>
        </div>
        
        <!-- Cancelled Timeline -->
        <div th:if="${order.orderStatus == 'Cancelled'}" class="alert alert-danger d-flex align-items-center mb-4">
            <i class="fas fa-times-circle fa-2x me-3"></i>
            <div>
                <strong>Đơn hàng đã bị hủy</strong>
                <p class="mb-0 small" th:if="${order.cancelledAt}">
                    Thời gian: <span th:text="${#temporals.format(order.cancelledAt, 'dd/MM/yyyy HH:mm')}"></span>
                </p>
            </div>
        </div>
        
        <!-- Return Requested Timeline -->
        <div th:if="${order.orderStatus == 'Return_Requested'}" class="alert alert-warning d-flex align-items-center mb-4">
            <i class="fas fa-undo fa-2x me-3"></i>
            <div>
                <strong>Đã yêu cầu trả hàng</strong>
                <p class="mb-0 small">Vui lòng chờ admin xét duyệt yêu cầu của bạn</p>
            </div>
        </div>
        
        <!-- Returned Timeline -->
        <div th:if="${order.orderStatus == 'Returned'}" class="alert alert-secondary d-flex align-items-center mb-4">
            <i class="fas fa-reply fa-2x me-3"></i>
            <div>
                <strong>Đã trả hàng thành công</strong>
                <p class="mb-0 small">Yêu cầu trả hàng của bạn đã được chấp nhận</p>
            </div>
        </div>

        <hr>
        
        <!-- Order History Details (Expandable) -->
        <div class="mb-3">
            <button class="btn btn-sm btn-outline-info" type="button" 
                    th:data-bs-target="'#orderHistory' + ${order.id}" 
                    data-bs-toggle="collapse">
                <i class="fas fa-history me-1"></i> Xem lịch sử đơn hàng
            </button>
        </div>
        
        <div class="collapse" th:id="'orderHistory' + ${order.id}">
            <div class="card card-body mb-3 bg-light">
                <h6 class="fw-bold mb-3"><i class="fas fa-clock-rotate-left me-2"></i>Lịch sử theo dõi</h6>
                <div class="timeline">
                    <!-- Delivered -->
                    <div th:if="${order.deliveredAt}" class="timeline-item">
                        <div class="timeline-marker bg-success"></div>
                        <div class="timeline-content">
                            <strong>Đã giao hàng</strong>
                            <p class="text-muted small mb-0" th:text="${#temporals.format(order.deliveredAt, 'dd/MM/yyyy HH:mm:ss')}"></p>
                        </div>
                    </div>
                    
                    <!-- Shipped -->
                    <div th:if="${order.shippedAt}" class="timeline-item">
                        <div class="timeline-marker bg-primary"></div>
                        <div class="timeline-content">
                            <strong>Đang giao hàng</strong>
                            <p class="text-muted small mb-1" th:text="${#temporals.format(order.shippedAt, 'dd/MM/yyyy HH:mm:ss')}"></p>
                            <p class="text-muted small mb-0" th:if="${order.shipperName}">
                                Shipper: <strong th:text="${order.shipperName}"></strong>
                                <span th:if="${order.shipperPhone}" th:text="'(' + ${order.shipperPhone} + ')'"></span>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Confirmed -->
                    <div th:if="${order.confirmedAt}" class="timeline-item">
                        <div class="timeline-marker bg-info"></div>
                        <div class="timeline-content">
                            <strong>Đơn hàng đã được xác nhận</strong>
                            <p class="text-muted small mb-0" th:text="${#temporals.format(order.confirmedAt, 'dd/MM/yyyy HH:mm:ss')}"></p>
                            <p class="text-muted small mb-0" th:if="${order.carrierName}">
                                Vận chuyển: <strong th:text="${order.carrierName}"></strong>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Created -->
                    <div th:if="${order.orderDate}" class="timeline-item">
                        <div class="timeline-marker bg-secondary"></div>
                        <div class="timeline-content">
                            <strong>Đơn hàng được tạo</strong>
                            <p class="text-muted small mb-0" th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm:ss')}"></p>
                        </div>
                    </div>
                    
                    <!-- Cancelled -->
                    <div th:if="${order.cancelledAt}" class="timeline-item">
                        <div class="timeline-marker bg-danger"></div>
                        <div class="timeline-content">
                            <strong>Đơn hàng bị hủy</strong>
                            <p class="text-muted small mb-0" th:text="${#temporals.format(order.cancelledAt, 'dd/MM/yyyy HH:mm:ss')}"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <hr>

        <!-- Order Details -->
        <div class="row">
            <div class="col-md-7">
                <p class="mb-2"><strong><i class="fas fa-user me-2 text-primary"></i>Người nhận:</strong> 
                   <span th:text="${order.recipientName}"></span></p>
                <p class="mb-2"><strong><i class="fas fa-map-marker-alt me-2 text-primary"></i>Địa chỉ:</strong> 
                   <span th:text="${order.shippingAddress}"></span></p>
                <p class="mb-2"><strong><i class="fas fa-phone me-2 text-primary"></i>SĐT:</strong> 
                   <span th:text="${order.phoneNumber}"></span></p>
                   
                <!-- Shipping Info -->
                <p class="mb-2" th:if="${order.carrierName}">
                    <strong><i class="fas fa-truck me-2 text-primary"></i>Đơn vị vận chuyển:</strong> 
                    <span th:text="${order.carrierName}"></span>
                </p>
                <p class="mb-2" th:if="${order.shipperName}">
                    <strong><i class="fas fa-user-tie me-2 text-primary"></i>Shipper:</strong> 
                    <span th:text="${order.shipperName}"></span>
                    <span th:if="${order.shipperPhone}" class="text-muted">
                        (<i class="fas fa-phone-alt"></i> <span th:text="${order.shipperPhone}"></span>)
                    </span>
                </p>
                
                <!-- Payment Info -->
                <p class="mb-2" th:if="${order.paymentMethod}">
                    <strong><i class="fas fa-credit-card me-2 text-primary"></i>Thanh toán:</strong> 
                    <span th:text="${order.paymentMethod}"></span>
                    <span th:if="${order.paymentStatus}" 
                          class="badge ms-2"
                          th:classappend="${order.paymentStatus == 'Paid' ? 'bg-success' : 'bg-warning'}">
                        <span th:text="${order.paymentStatus == 'Paid' ? 'Đã thanh toán' : 'Chưa thanh toán'}"></span>
                    </span>
                </p>
            </div>
            <div class="col-md-5 text-end">
                <div class="p-3 bg-light rounded">
                    <p class="mb-2 text-muted">Tạm tính:</p>
                    <p class="mb-2" th:text="${#numbers.formatDecimal(order.totalAmount - (order.shippingFee ?: 0), 0, 'COMMA', 0, 'POINT')} + ' ₫'"></p>
                    
                    <p class="mb-2 text-muted" th:if="${order.shippingFee}">Phí vận chuyển:</p>
                    <p class="mb-2" th:if="${order.shippingFee}" th:text="${#numbers.formatDecimal(order.shippingFee, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></p>
                    
                    <hr class="my-2">
                    <p class="mb-1"><strong>Tổng cộng:</strong></p>
                    <h4 class="text-danger fw-bold mb-0" 
                        th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'">
                    </h4>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons mt-4">
            <!-- DEBUG: Hiển thị trạng thái hiện tại -->
            <small class="text-muted d-block mb-2">
                Trạng thái hiện tại: <strong th:text="${order.orderStatus}"></strong>
            </small>
            
            <!-- Nút Hủy Đơn (chỉ khi Processing hoặc Confirmed) -->
            <form th:if="${order.orderStatus == 'Processing' || order.orderStatus == 'Confirmed'}"
                  th:action="@{/orders/{id}/cancel(id=${order.id})}" method="post" class="d-inline">
                <button type="submit" class="btn btn-danger" 
                        onclick="return confirm('Bạn có chắc muốn hủy đơn hàng này?')">
                    <i class="fas fa-times-circle me-2"></i> Hủy Đơn
                </button>
            </form>

            <!-- Nút Trả Hàng (chỉ khi Delivered) -->
            <button th:if="${order.orderStatus == 'Delivered'}" 
                    type="button" class="btn btn-warning" 
                    data-bs-toggle="modal" 
                    th:data-bs-target="'#returnModal' + ${order.id}">
                <i class="fas fa-undo me-2"></i> Yêu Cầu Trả Hàng
            </button>

            <!-- Nút Chi Tiết -->
            <a th:href="@{/orders/{id}/detail(id=${order.id})}" class="btn btn-outline-primary">
                <i class="fas fa-eye me-2"></i> Chi Tiết
            </a>
        </div>

        <!-- Modal Trả Hàng -->
        <div class="modal fade" th:id="'returnModal' + ${order.id}" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-undo me-2 text-warning"></i>
                            Yêu Cầu Trả Hàng
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form th:action="@{/orders/{id}/request-return(id=${order.id})}" method="post">
                        <div class="modal-body">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Đơn hàng: <strong th:text="${order.orderNumber}"></strong>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    Lý do trả hàng <span class="text-danger">*</span>
                                </label>
                                <textarea name="reason" class="form-control" rows="4" 
                                          placeholder="Vui lòng cho biết lý do bạn muốn trả hàng..." 
                                          required></textarea>
                            </div>
                            <small class="text-muted">
                                <i class="fas fa-lightbulb me-1"></i>
                                Yêu cầu sẽ được gửi đến admin để xem xét.
                            </small>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-2"></i>Đóng
                            </button>
                            <button type="submit" class="btn btn-warning">
                                <i class="fas fa-paper-plane me-2"></i> Gửi Yêu Cầu
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
