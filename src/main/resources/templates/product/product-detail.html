
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/default}">

<head>
    <title th:text="${product.productName}">Product Detail</title>
    <th:block layout:fragment="styles">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
        <style>
            /* --- General & Typography --- */
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            }
            .breadcrumb { background-color: transparent; font-size: 14px; }
            .product-details h2 { font-size: 20px; font-weight: normal; text-transform: uppercase; margin-bottom: 8px; }
            .product-details .product-meta { font-size: 14px; color: #888; margin-bottom: 20px; }
            .option-label { font-weight: bold; margin-bottom: 10px; display: block; font-size: 16px; }
            .size-guide-link { display: block; margin-top: 10px; font-size: 14px; color: #000; text-decoration: none; }
            .size-guide-link:hover { text-decoration: underline; }

            /* --- MODIFIED: Image Gallery for Lazy Loading --- */
            .thumbnail-list {
                display: flex;
                flex-direction: column;
                gap: 10px;
                max-height: 500px;
                overflow-y: auto;
            }
            .thumbnail-item img {
                width: 100%;
                height: auto;
                cursor: pointer;
                border: 2px solid transparent;
                transition: border-color 0.2s, opacity 0.4s ease; /* Added opacity transition */
                opacity: 0; /* Initially hidden for fade-in */
                background-color: #f0f0f0;
            }
            .thumbnail-item img.loaded { opacity: 1; }
            .thumbnail-item img.active, .thumbnail-item img:hover {
                border-color: #000;
            }
            .main-image img {
                width: 100%;
                height: auto;
                object-fit: contain;
                transition: opacity 0.4s ease; /* Added opacity transition */
                opacity: 0; /* Initially hidden for fade-in */
                background-color: #f0f0f0;
            }
            .main-image img.loaded { opacity: 1; }

            /* --- Pricing --- */
            .product-price .sale-price { font-size: 28px; font-weight: bold; color: #e60023; }
            .product-price .original-price { font-size: 20px; color: #888; margin-left: 10px; }
            .product-price .discount-badge { background-color: #e60023; color: white; font-size: 14px; font-weight: bold; padding: 4px 8px; border-radius: 4px; margin-left: 10px; vertical-align: middle; }

            /* --- Size & Color Options --- */
            .size-options, .color-options { display: flex; flex-wrap: wrap; gap: 10px; }
            .size-option { border: 1px solid #ccc; padding: 8px 16px; cursor: pointer; background-color: #fff; transition: border-color 0.2s; position: relative; }
            .size-option.out-of-stock { background-color: #f2f2f2; color: #ccc; cursor: not-allowed; text-decoration: line-through; }
            .size-option:not(.out-of-stock):hover { border-color: #000; }
            .size-option.active { border-color: #000; }
            .size-option.active::after { content: ''; display: block; width: 15px; height: 15px; background-image: url('https://img.icons8.com/ios-filled/50/000000/checkmark--v1.png'); background-size: contain; background-repeat: no-repeat; position: absolute; top: -1px; right: -1px; }
            .color-option { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 1px solid #ccc; padding: 2px; transition: border-color 0.2s; display: flex; justify-content: center; align-items: center; }
            .color-option.out-of-stock { cursor: not-allowed; opacity: 0.4; }
            .color-option:not(.out-of-stock):hover { border-color: #000; }
            .color-option.active { border-color: #000; border-width: 2px; }
            .color-swatch { width: 100%; height: 100%; border-radius: 50%; display: block; }

            /* --- Quantity & Action Buttons --- */
            .quantity-selector { display: flex; border: 1px solid #ccc; width: 150px; height: 40px; align-items: center; }
            .quantity-selector button { background-color: transparent; border: none; font-size: 20px; cursor: pointer; padding: 0 15px; color: #555; height: 100%; }
            .quantity-selector input { width: 100%; border: none; text-align: center; font-size: 16px; font-weight: bold; -moz-appearance: textfield; }
            .quantity-selector input::-webkit-outer-spin-button, .quantity-selector input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
            .action-buttons .btn { width: 100%; padding: 12px; font-size: 16px; font-weight: bold; text-transform: uppercase; border-radius: 0; border-width: 2px; transition: background-color 0.2s, color 0.2s; }
            .btn-add-to-cart { background-color: #fff; color: #000; border: 2px solid #000; }
            .btn-add-to-cart:hover { background-color: #f0f0f0; color: #000; }
            .btn-buy-now { background-color: #000; color: #fff; border: 2px solid #000; }
            .btn-buy-now:hover { background-color: #333; border-color: #333; color: #fff; }

            /* --- Product Description & Reviews --- */
            .product-description { margin-top: 30px; font-size: 14px; line-height: 1.6; }
            .review-section { margin-top: 40px; }
            .review-summary { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
            .review-summary .total-reviews { font-size: 16px; color: #555; }
            .star-rating { color: #ffc107; }
            .star-rating .bi-star { color: #e4e5e9; }
            .btn-write-review { font-weight: bold; }
            #review-form-container { background-color: #f8f9fa; padding: 20px; border: 1px solid #dee2e6; border-radius: 5px; margin-top: 20px; }
            .review-item { border-bottom: 1px solid #eee; padding: 15px 0; }
            .review-author { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
            .review-author img { width: 40px; height: 40px; border-radius: 50%; }
            .review-author span { font-weight: bold; }
            .review-meta { font-size: 12px; color: #888; }
            .review-content .review-title { font-weight: bold; margin: 10px 0 5px; }
            .rating-input-group { display: flex; flex-direction: row-reverse; justify-content: flex-end; }
            .rating-input-group > input { display: none; }
            .rating-input-group > label { font-size: 2rem; color: #e4e5e9; cursor: pointer; }
            .rating-input-group > input:checked ~ label, .rating-input-group > label:hover, .rating-input-group > label:hover ~ label { color: #ffc107; }
        </style>
    </th:block>
</head>

<body>

	<div class="container" layout:fragment="content">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a th:href="@{/}">TRANG CHỦ</a></li>
				<li class="breadcrumb-item"><a th:href="@{/products}">TẤT CẢ SẢN PHẨM</a></li>
				<li class="breadcrumb-item active" aria-current="page" th:text="${product.productName.toUpperCase()}"></li>
			</ol>
		</nav>

    <div class="row">
        <!-- MODIFIED: Product Image Gallery for Lazy Loading -->
        <div class="col-md-7">
             <div class="row">
                    <div class="col-md-2 order-md-1">
                        <div class="thumbnail-list">
                            <div class="thumbnail-item" th:each="image, iterStat : ${product.images}">
                                <img class="lazy-image"
                                     src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                                     th:data-src="${image.imageUrl}"
                                     th:alt="${product.productName + ' thumbnail ' + iterStat.index}"
                                     th:classappend="${iterStat.index == 0} ? 'active'"
                                     th:onclick="'changeMainImage(this)'">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-10 order-md-2">
                        <div class="main-image">
                            <img id="mainProductImage"
                                 class="lazy-image"
                                 th:if="${!#lists.isEmpty(product.images)}"
                                 src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                                 th:data-src="${product.images[0].imageUrl}"
                                 th:alt="${product.productName}">
                            <img id="mainProductImagePlaceholder"
                                 th:if="${#lists.isEmpty(product.images)}"
                                 src="https://via.placeholder.com/500" alt="No Image Available">
                        </div>
                    </div>
                </div>
        </div>

        <div class="col-md-5 product-details">
            <h2 th:text="${product.productName}"></h2>
            <p class="product-meta">
                Thương hiệu: <span th:text="${brand != null ? brand.brandName : 'N/A'}"></span> | Mã SP: <span th:text="${product.sku}"></span>
            </p>

            <div class="my-3 product-price d-flex align-items-center">
                <span class="sale-price" th:text="${#numbers.formatDecimal(product.salePrice, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
                <span class="original-price text-decoration-line-through" th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
                <span class="discount-badge" th:if="${product.price > 0}" th:text="'-' + ${#numbers.formatInteger(((product.price - product.salePrice) * 100) / product.price, 0)} + '%'"></span>
            </div>

            <!-- Size & Color Options -->
            <div class="mb-4">
                <label class="option-label">Kích thước</label>
                <div class="size-options">
                    <span th:each="size : ${availableSizes}"
                          th:text="${size.sizeName}"
                          th:classappend="${!#lists.contains(variants, size) ? 'out-of-stock' : ''}"
                          th:attr="data-size=${size.sizeName}"
                          th:onclick="${!#lists.contains(variants, size)} ? null : 'selectSize(this)'">
                    </span>
                </div>
                 <a href="#" class="size-guide-link">HƯỚNG DẪN CHỌN SIZE</a>
            </div>
             <div class="mb-4">
                <label class="option-label">Màu sắc</label>
                <div class="color-options">
                     <span th:each="color : ${availableColors}"
                           class="color-option"
                           th:classappend="${!#lists.contains(variants, color) ? 'out-of-stock' : ''}"
                           th:attr="data-color=${color.colorName}"
                           th:onclick="${!#lists.contains(variants, color)} ? null : 'selectColor(this)'">
                        <span class="color-swatch" th:style="'background-color:' + ${color.colorCode}"></span>
                    </span>
                </div>
            </div>

            <!-- Quantity -->
            <div class="mb-4">
                <label class="option-label">Số lượng</label>
                 <div class="quantity-selector">
                    <button type="button" onclick="this.nextElementSibling.stepDown()">-</button>
                    <input type="number" id="quantity" class="form-control text-center" value="1" min="1">
                    <button type="button" onclick="this.previousElementSibling.stepUp()">+</button>
                </div>
                 <p id="stock-info" class="mt-2 text-danger" style="display: none;">Hết hàng</p>
            </div>

            <div class="d-grid gap-2 mt-4 action-buttons">
                <button class="btn btn-add-to-cart" type="button" onclick="addToCart()">THÊM VÀO GIỎ</button>
                <button class="btn btn-buy-now" type="button">MUA NGAY</button>
            </div>

            <div class="mt-4 product-description" th:utext="${product.description}"></div>
        </div>
    </div>
    
    <!-- Product Reviews Section -->
    <div class="row review-section">
        <div class="col-12">
            <hr>
            <h3 class="mb-3">Đánh giá sản phẩm</h3>
            <div class="review-summary"></div>
            <div sec:authorize="!isAuthenticated()">
                <div class="alert alert-info">Vui lòng <a th:href="@{/login}">đăng nhập</a> để viết đánh giá.</div>
            </div>
            <div sec:authorize="isAuthenticated()">
                <div th:if="${#lists.isEmpty(eligibleOrders)}">
                    <div class="alert alert-warning">Bạn chỉ có thể đánh giá sản phẩm này sau khi đã mua và đơn hàng được giao thành công.</div>
                </div>
                <div th:unless="${#lists.isEmpty(eligibleOrders)}">
                    <button class="btn btn-primary btn-write-review mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#review-form-container">Viết đánh giá</button>
                    <div class="collapse" id="review-form-container">
                        <form id="review-form"></form>
                    </div>
                </div>
            </div>
            <div id="reviews-list" class="mt-4"></div>
            <button id="load-more-reviews" class="btn btn-outline-secondary mt-3" style="display: none;">Xem thêm</button>
        </div>
    </div>

    <!-- Similar Products -->
    <div class="row mt-5">
        <div class="col-12">
            <h3 class="text-center mb-4">SẢN PHẨM TƯƠNG TỰ</h3>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        // Your existing review logic can go here

        // --- MODIFIED: Lazy Loading and Image Gallery Logic ---
        document.addEventListener('DOMContentLoaded', function () {
            // --- Review logic setup (as before) ---
            // ... (Your review fetching and form submission logic would be here)

            // --- Image Lazy Loading Logic ---
            const lazyImageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const src = img.dataset.src;

                        if (!src) {
                            observer.unobserve(img);
                            return;
                        }

                        img.src = src; // Start loading the image

                        img.onload = () => {
                            img.classList.add('loaded'); // Apply fade-in effect
                        };
                        
                        img.onerror = () => {
                             console.error('Image failed to load:', src);
                             img.classList.add('loaded'); // Show the container even if image fails
                        };

                        observer.unobserve(img); // Job done, stop observing
                    }
                });
            }, { rootMargin: "0px 0px 200px 0px" }); // Start loading 200px before viewport

            const imagesToLoad = document.querySelectorAll('.lazy-image');
            imagesToLoad.forEach(image => {
                lazyImageObserver.observe(image);
            });
        });

        // --- MODIFIED: Image Change Function ---
        function changeMainImage(thumbnailElement) {
            // Get the full-res source from the data attribute, which is always correct
            const newImageSrc = thumbnailElement.dataset.src;
            if (!newImageSrc) return;
            
            const mainImage = document.getElementById('mainProductImage');
            if (mainImage && mainImage.src !== newImageSrc) {
                mainImage.src = newImageSrc;
                // If the main image wasn't loaded yet, the observer will handle the 'loaded' class.
                // If it was already loaded, this just swaps the src.
            }
            
            // Update the 'active' class on thumbnails
            document.querySelectorAll('.thumbnail-list .lazy-image').forEach(img => img.classList.remove('active'));
            thumbnailElement.classList.add('active');
        }

        // --- Other functions (selectSize, selectColor, addToCart) ---
        function selectSize(element) {
            document.querySelectorAll('.size-option').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        }
        
        function selectColor(element) {
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
        }
        
        function addToCart() {
            console.log('Add to cart clicked');
        }
    </script>
</th:block>
</body>
</html>
