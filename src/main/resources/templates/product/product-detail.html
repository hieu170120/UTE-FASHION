<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	layout:decorate="~{layout/default}">

<head>
<title th:text="${product.productName}">Product Detail</title>
<th:block layout:fragment="styles">
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
	<style>
/* --- General & Typography --- */
body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
		"Helvetica Neue", Arial, sans-serif;
}

.breadcrumb {
	background-color: transparent;
	font-size: 14px;
}

.product-details h2 {
	font-size: 20px;
	font-weight: normal;
	text-transform: uppercase;
	margin-bottom: 8px;
}

.product-details .product-meta {
	font-size: 14px;
	color: #888;
	margin-bottom: 20px;
}

.option-label {
	font-weight: bold;
	margin-bottom: 10px;
	display: block;
	font-size: 16px;
}

.size-guide-link {
	display: block;
	margin-top: 10px;
	font-size: 14px;
	color: #000;
	text-decoration: none;
}

.size-guide-link:hover {
	text-decoration: underline;
}

/* --- MODIFIED: Image Gallery for Lazy Loading --- */
.thumbnail-list {
	display: flex;
	flex-direction: column;
	gap: 10px;
	max-height: 500px;
	overflow-y: auto;
}

.thumbnail-list.loading-state {
	/* Chiều cao giả định cho thumbnail list khi đang tải */
	min-height: 100px;
}

.thumbnail-item img {
	width: 100%;
	height: auto;
	cursor: pointer;
	border: 2px solid transparent;
	transition: border-color 0.2s, opacity 0.4s ease;
	/* Added opacity transition */
	opacity: 0; /* Initially hidden for fade-in */
	background-color: #f0f0f0;
}

.thumbnail-item img.loaded {
	opacity: 1;
}

.thumbnail-item img.active, .thumbnail-item img:hover {
	border-color: #000;
}

.main-image img {
	width: 100%;
	height: auto;
	object-fit: contain;
	transition: opacity 0.4s ease; /* Added opacity transition */
	opacity: 0; /* Initially hidden for fade-in */
	background-color: #f0f0f0;
}

.main-image img.loaded {
	opacity: 1;
}

.main-image-placeholder {
	min-height: 400px; /* Giả định chiều cao ảnh chính */
	background-color: #f0f0f0;
	display: flex;
	justify-content: center;
	align-items: center;
}

/* --- Pricing --- */
.product-price .sale-price {
	font-size: 28px;
	font-weight: bold;
	color: #e60023;
}

.product-price .original-price {
	font-size: 20px;
	color: #888;
	margin-left: 10px;
}

.product-price .discount-badge {
	background-color: #e60023;
	color: white;
	font-size: 14px;
	font-weight: bold;
	padding: 4px 8px;
	border-radius: 4px;
	margin-left: 10px;
	vertical-align: middle;
}

/* --- Size & Color Options --- */
.size-options, .color-options {
	display: flex;
	flex-wrap: wrap;
	gap: 10px;
	min-height: 40px;
}

.size-option {
	border: 1px solid #ccc;
	padding: 8px 16px;
	cursor: pointer;
	background-color: #fff;
	transition: border-color 0.2s;
	position: relative;
}

.size-option.out-of-stock {
	background-color: #f2f2f2;
	color: #ccc;
	cursor: not-allowed;
	text-decoration: line-through;
}

.size-option:not(.out-of-stock):hover {
	border-color: #000;
}

.size-option.active {
	border-color: #000;
}

.size-option.active::after {
	content: '';
	display: block;
	width: 15px;
	height: 15px;
	background-image:
		url('https://img.icons8.com/ios-filled/50/000000/checkmark--v1.png');
	background-size: contain;
	background-repeat: no-repeat;
	position: absolute;
	top: -1px;
	right: -1px;
}

.color-option {
	width: 32px;
	height: 32px;
	border-radius: 50%;
	cursor: pointer;
	border: 1px solid #ccc;
	padding: 2px;
	transition: border-color 0.2s;
	display: flex;
	justify-content: center;
	align-items: center;
}

.color-option.out-of-stock {
	cursor: not-allowed;
	opacity: 0.4;
}

.color-option:not(.out-of-stock):hover {
	border-color: #000;
}

.color-option.active {
	border-color: #000;
	border-width: 2px;
}

.color-swatch {
	width: 100%;
	height: 100%;
	border-radius: 50%;
	display: block;
}

/* --- Quantity & Action Buttons --- */
.quantity-selector {
	display: flex;
	border: 1px solid #ccc;
	width: 150px;
	height: 40px;
	align-items: center;
}

.quantity-selector button {
	background-color: transparent;
	border: none;
	font-size: 20px;
	cursor: pointer;
	padding: 0 15px;
	color: #555;
	height: 100%;
}

.quantity-selector input {
	width: 100%;
	border: none;
	text-align: center;
	font-size: 16px;
	font-weight: bold;
	-moz-appearance: textfield;
}

.quantity-selector input::-webkit-outer-spin-button, .quantity-selector input::-webkit-inner-spin-button
	{
	-webkit-appearance: none;
	margin: 0;
}

.action-buttons .btn {
	width: 100%;
	padding: 12px;
	font-size: 16px;
	font-weight: bold;
	text-transform: uppercase;
	border-radius: 0;
	border-width: 2px;
	transition: background-color 0.2s, color 0.2s;
}

.btn-add-to-cart {
	background-color: #fff;
	color: #000;
	border: 2px solid #000;
}

.btn-add-to-cart:hover {
	background-color: #f0f0f0;
	color: #000;
}

.btn-buy-now {
	background-color: #000;
	color: #fff;
	border: 2px solid #000;
}

.btn-buy-now:hover {
	background-color: #333;
	border-color: #333;
	color: #fff;
}

/* Loading Spinner Style */
.spinner-container {
	display: flex;
	justify-content: center;
	align-items: center;
	min-height: 100px;
}
</style>
</th:block>
</head>

<body>

	<div class="container" layout:fragment="content">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a th:href="@{/}">TRANG CHỦ</a></li>
				<li class="breadcrumb-item"><a th:href="@{/products}">TẤT
						CẢ SẢN PHẨM</a></li>
				<li class="breadcrumb-item active" aria-current="page"
					th:text="${product.productName.toUpperCase()}"></li>
			</ol>
		</nav>

		<div class="row">
			<div class="col-md-7">
				<div class="row">
					<div class="col-md-2 order-md-1">
						<div id="thumbnail-list" class="thumbnail-list loading-state">
							<div class="spinner-container">
								<div class="spinner-border spinner-border-sm" role="status">
									<span class="visually-hidden">Loading images...</span>
								</div>
							</div>
						</div>
					</div>
					<div class="col-md-10 order-md-2">
						<div class="main-image">
							<div id="main-image-placeholder" class="main-image-placeholder">
								<div class="spinner-border text-primary" role="status">
									<span class="visually-hidden">Loading main image...</span>
								</div>
							</div>
							<img id="mainProductImage" style="display: none;"
								alt="Main image">
						</div>
					</div>
				</div>
			</div>

			<div class="col-md-5 product-details">
				<h2 th:text="${product.productName}"></h2>
				<p class="product-meta">
					Thương hiệu: <span
						th:text="${brand != null ? brand.brandName : 'N/A'}"></span> | Mã
					SP: <span th:text="${product.sku}"></span>
				</p>

				<div class="my-3 product-price d-flex align-items-center">
					<span class="sale-price"
						th:text="${#numbers.formatDecimal(product.salePrice, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
					<span class="original-price text-decoration-line-through"
						th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
					<span class="discount-badge"
						th:if="${product.price > 0 and product.salePrice < product.price}"
						th:text="'-' + ${#numbers.formatInteger(((product.price - product.salePrice) * 100) / product.price, 0)} + '%'"></span>
				</div>

				<div class="mb-4">
					<label class="option-label">Kích thước</label>
					<div id="size-options-container" class="size-options">
						<div class="spinner-border spinner-border-sm text-secondary"
							role="status">
							<span class="visually-hidden">Loading sizes...</span>
						</div>
					</div>
					<a href="#" class="size-guide-link">HƯỚNG DẪN CHỌN SIZE</a>
				</div>
				<div class="mb-4">
					<label class="option-label">Màu sắc</label>
					<div id="color-options-container" class="color-options">
						<div class="spinner-border spinner-border-sm text-secondary"
							role="status">
							<span class="visually-hidden">Loading colors...</span>
						</div>
					</div>
				</div>

				<div class="mb-4">
					<label class="option-label">Số lượng</label>
					<div class="quantity-selector">
						<button type="button" onclick="this.nextElementSibling.stepDown()">-</button>
						<input type="number" id="quantity"
							class="form-control text-center" value="1" min="1">
						<button type="button"
							onclick="this.previousElementSibling.stepUp()">+</button>
					</div>
					<p id="stock-info" class="mt-2 text-danger" style="display: none;">Hết
						hàng</p>
				</div>

				<div class="d-grid gap-2 mt-4 action-buttons">
					<button class="btn btn-add-to-cart" type="button"
						onclick="addToCart()">THÊM VÀO GIỎ</button>
					<button class="btn btn-buy-now" type="button"
						onclick="buyNow()">MUA NGAY</button>
				</div>

				<div class="mt-4 product-description"
					th:utext="${product.description}"></div>
			</div>
		</div>

		<div class="row review-section">
			<div class="col-12">
				<hr>
				<h3 class="mb-3">Đánh giá sản phẩm</h3>
				<div class="review-summary">
					<div class="star-rating h4 mb-0">
						<th:block
							th:with="rating=${product.averageRating != null ? product.averageRating : 0}">
							<i th:each="i : ${#numbers.sequence(1, 5)}"
								th:class="${i <= rating} ? 'bi bi-star-fill' : (${i - 1 < rating} ? 'bi bi-star-half' : 'bi bi-star')"></i>
						</th:block>
					</div>
					<!--                <span class="total-reviews" th:text="${product.totalReviews} + ' đánh giá'"></span>-->
					<button class="btn btn-sm btn-outline-dark btn-write-review"
						onclick="toggleReviewForm()">VIẾT ĐÁNH GIÁ</button>
				</div>

				<div id="review-form-container" style="display: none;">
					<form id="review-form" th:action="@{/api/reviews}" method="post">
						<h5 class="mb-3">Viết đánh giá của bạn</h5>
						<input type="hidden" name="productId" th:value="${product.id}">
						<div class="mb-3">
							<label for="rating" class="form-label">Đánh giá sao:</label>
							<div class="rating-input-group">
								<input type="radio" id="star5" name="rating" value="5" /><label
									for="star5" title="Tuyệt vời">★</label> <input type="radio"
									id="star4" name="rating" value="4" /><label for="star4"
									title="Rất tốt">★</label> <input type="radio" id="star3"
									name="rating" value="3" /><label for="star3"
									title="Bình thường">★</label> <input type="radio" id="star2"
									name="rating" value="2" /><label for="star2" title="Kém">★</label>
								<input type="radio" id="star1" name="rating" value="1" /><label
									for="star1" title="Rất tệ">★</label>
							</div>
						</div>
						<div class="mb-3">
							<label for="title" class="form-label">Tiêu đề đánh giá:</label> <input
								type="text" class="form-control" id="title" name="title"
								required>
						</div>
						<div class="mb-3">
							<label for="content" class="form-label">Nội dung:</label>
							<textarea class="form-control" id="content" name="content"
								rows="3" required></textarea>
						</div>
						<button type="submit" class="btn btn-dark">Gửi Đánh Giá</button>
						<button type="button" class="btn btn-secondary"
							onclick="toggleReviewForm()">Hủy</button>
					</form>
				</div>

				<div id="review-list" class="mt-4">
					<div class="review-item" th:each="review : ${reviewPage.content}">
						<div class="review-author">
							<img src="https://via.placeholder.com/40" alt="Avatar"> <span
								th:text="${review.userFullName ?: 'Khách hàng'}"></span> <span
								class="review-meta"
								th:text="${#temporals.format(review.reviewDate, 'dd-MM-yyyy HH:mm')}"></span>
						</div>
						<div class="star-rating">
							<i th:each="i : ${#numbers.sequence(1, 5)}"
								th:class="${i <= review.rating} ? 'bi bi-star-fill' : 'bi bi-star'"></i>
						</div>
						<div class="review-content">
							<p class="review-title" th:text="${review.title}"></p>
							<p th:text="${review.content}"></p>
						</div>
					</div>
					<div th:if="${reviewPage.totalElements == 0}"
						class="text-center text-muted py-3">Chưa có đánh giá nào cho
						sản phẩm này.</div>
				</div>

				<nav aria-label="Review page navigation"
					th:if="${reviewPage.totalPages > 1}" class="mt-4">
					<ul class="pagination justify-content-center">
						<li class="page-item"
							th:classappend="${reviewPage.first} ? 'disabled'"><a
							class="page-link" href="#"
							onclick="loadReviews(reviewPage.number - 1); return false;">&laquo;</a>
						</li>
						<li class="page-item"
							th:each="pageNumber : ${#numbers.sequence(0, reviewPage.totalPages - 1)}"
							th:classappend="${pageNumber == reviewPage.number} ? 'active'">
							<a class="page-link" href="#" th:text="${pageNumber + 1}"
							th:onclick="'loadReviews(' + ${pageNumber} + '); return false;'">
						</a>
						</li>
						<li class="page-item"
							th:classappend="${reviewPage.last} ? 'disabled'"><a
							class="page-link" href="#"
							onclick="loadReviews(reviewPage.number + 1); return false;">&raquo;</a>
						</li>
					</ul>
				</nav>

			</div>
		</div>
	</div>

	<th:block layout:fragment="scripts">
		<script th:inline="javascript">
        /*<![CDATA[*/
        const productId = /*[[${product.id}]]*/ null;
        const csrfToken = /*[[${_csrf.token}]]*/ '';
        const csrfHeader = /*[[${_csrf.headerName}]]*/ '';
        // Biến toàn cục để lưu trữ tất cả biến thể đã tải
        let productVariants = [];
        let uniqueSizes = [];
        let uniqueColors = [];
        let selectedSize = null;
        let selectedColor = null;
        /*]]>*/

        // --- HÀM XỬ LÝ ẢNH ---
        const changeMainImage = (thumbnailEl) => {
            const mainImage = document.getElementById('mainProductImage');
            document.querySelectorAll('.thumbnail-item img').forEach(img => img.classList.remove('active'));
            thumbnailEl.classList.add('active');

            // Ẩn ảnh cũ và hiện placeholder
            mainImage.style.display = 'none';
            document.getElementById('main-image-placeholder').style.display = 'flex';

            // Tạo một đối tượng Image để tải ảnh mới
            const newImage = new Image();
            newImage.onload = function() {
                mainImage.src = newImage.src;
                mainImage.classList.add('loaded');
                mainImage.style.display = 'block';
                document.getElementById('main-image-placeholder').style.display = 'none';
            };
            newImage.onerror = function() {
                 mainImage.src = 'https://via.placeholder.com/500?text=Error';
                 mainImage.classList.add('loaded');
                 mainImage.style.display = 'block';
                 document.getElementById('main-image-placeholder').style.display = 'none';
                 console.error("Failed to load image:", thumbnailEl.dataset.src);
            };

            // Bắt đầu tải ảnh mới
            newImage.src = thumbnailEl.dataset.src;
        };

        const loadProductImages = () => {
            const thumbnailList = document.getElementById('thumbnail-list');
            const mainImage = document.getElementById('mainProductImage');

            fetch(/*[[@{/api/products/{productId}/images(productId=${product.id})}]]*/).then(res => res.json()).then(images => {
                thumbnailList.innerHTML = '';
                thumbnailList.classList.remove('loading-state');
                
                if (images && images.length > 0) {
                    images.forEach((img, index) => {
                        const activeClass = index === 0 ? 'active' : '';
                        const thumbnailHtml = `
                            <div class="thumbnail-item">
                                <img class="lazy-image"
                                     src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                                     data-src="${img.imageUrl}"
                                     alt="Thumbnail ${index}"
                                     class="${activeClass}"
                                     onclick="changeMainImage(this)">
                            </div>`;
                        thumbnailList.innerHTML += thumbnailHtml;
                    });
                    
                    // Lazy load the thumbnail images
                    const lazyImages = thumbnailList.querySelectorAll('.lazy-image');
                    lazyImages.forEach(lazyImage => {
                        const image = new Image();
                        image.onload = () => {
                            lazyImage.src = lazyImage.dataset.src;
                            lazyImage.classList.add('loaded');
                        };
                        image.src = lazyImage.dataset.src;
                    });

                    // Set initial main image
                    const firstImageSrc = images[0].imageUrl;
                    mainImage.src = firstImageSrc;
                    mainImage.classList.add('loaded');
                    mainImage.style.display = 'block';
                    document.getElementById('main-image-placeholder').style.display = 'none';
                    
                } else {
                    mainImage.src = 'https://via.placeholder.com/500';
                    mainImage.classList.add('loaded');
                    mainImage.style.display = 'block';
                    document.getElementById('main-image-placeholder').style.display = 'none';
                    thumbnailList.innerHTML = '<div class="text-muted p-2">No images</div>';
                }
            }).catch(err => {
                console.error("Error loading product images:", err);
                thumbnailList.innerHTML = '<div class="text-danger p-2">Lỗi tải ảnh.</div>';
                document.getElementById('main-image-placeholder').innerHTML = '<span class="text-danger">Lỗi tải ảnh.</span>';
            });
        };

        // --- HÀM XỬ LÝ BIẾN THỂ (SIZE/COLOR) ---
        const updateVariantOptions = () => {
            const sizeContainer = document.getElementById('size-options-container');
            const colorContainer = document.getElementById('color-options-container');
            
            // Xóa nội dung cũ
            sizeContainer.innerHTML = '';
            colorContainer.innerHTML = '';

            // 1. Lọc và lưu trữ các giá trị size và color duy nhất
            uniqueSizes = [...new Set(productVariants.map(v => v.sizeName))].filter(s => s).sort();
            uniqueColors = [...new Set(productVariants.map(v => ({ name: v.colorName, code: v.colorCode })))].filter(c => c.name);

            // 2. Render Size Options
            uniqueSizes.forEach(sizeName => {
                const isActive = sizeName === selectedSize ? 'active' : '';
                
                // Kiểm tra xem size này có variant nào hợp lệ (còn hàng hoặc không cần color) không
                const isAvailable = productVariants.some(v => v.sizeName === sizeName && v.stock > 0);
                const isOutOfStock = !isAvailable ? 'out-of-stock' : '';
                
                sizeContainer.innerHTML += `
                    <span class="size-option ${isActive} ${isOutOfStock}"
                          data-size="${sizeName}"
                          onclick="${isOutOfStock ? '' : 'selectSize(this)'}">
                        ${sizeName}
                    </span>`;
            });

            // 3. Render Color Options
            const renderedColors = new Set();
            uniqueColors.forEach(color => {
                if(renderedColors.has(color.name)) return;
                renderedColors.add(color.name);

                const isActive = color.name === selectedColor ? 'active' : '';

                // Kiểm tra xem color này có variant nào hợp lệ (còn hàng hoặc không cần size) không
                const isAvailable = productVariants.some(v => v.colorName === color.name && v.stock > 0);
                const isOutOfStock = !isAvailable ? 'out-of-stock' : '';

                colorContainer.innerHTML += `
                    <span class="color-option ${isActive} ${isOutOfStock}"
                          data-color="${color.name}"
                          onclick="${isOutOfStock ? '' : 'selectColor(this)'}">
                        <span class="color-swatch" style="background-color:${color.code};"></span>
                    </span>`;
            });
            
            // Nếu không có size/color nào, hiển thị thông báo "Hết hàng"
            if (uniqueSizes.length === 0 && uniqueColors.length === 0 && productVariants.length > 0) {
                 sizeContainer.innerHTML = '<p class="text-muted">Không có tùy chọn kích thước.</p>';
                 colorContainer.innerHTML = '<p class="text-muted">Không có tùy chọn màu sắc.</p>';
            } else if (productVariants.length === 0) {
                 sizeContainer.innerHTML = '<p class="text-danger">Sản phẩm hiện đang hết hàng.</p>';
                 colorContainer.innerHTML = '<p class="text-danger">Sản phẩm hiện đang hết hàng.</p>';
            }

            // Cập nhật trạng thái sau khi render xong
            updateSelectionStatus();
        };
        
        const selectSize = (el) => {
            const newSize = el.dataset.size;
            if (selectedSize === newSize) {
                selectedSize = null; // Bỏ chọn
            } else {
                selectedSize = newSize;
            }
            // Xóa active class cũ và thêm vào cái mới (nếu có)
            document.querySelectorAll('.size-option').forEach(s => s.classList.remove('active'));
            if (selectedSize) {
                el.classList.add('active');
            }
            updateSelectionStatus();
        };

        const selectColor = (el) => {
            const newColor = el.dataset.color;
            if (selectedColor === newColor) {
                selectedColor = null; // Bỏ chọn
            } else {
                selectedColor = newColor;
            }
            // Xóa active class cũ và thêm vào cái mới (nếu có)
            document.querySelectorAll('.color-option').forEach(c => c.classList.remove('active'));
            if (selectedColor) {
                el.classList.add('active');
            }
            updateSelectionStatus();
        };

        const updateSelectionStatus = () => {
            const stockInfo = document.getElementById('stock-info');
            const quantityInput = document.getElementById('quantity');
            const addToCartBtn = document.querySelector('.btn-add-to-cart');
            const buyNowBtn = document.querySelector('.btn-buy-now');

            // 1. Kiểm tra xem đã chọn đủ Size và Color (nếu chúng tồn tại)
            const isSizeRequired = uniqueSizes.length > 0;
            const isColorRequired = uniqueColors.length > 0;
            
            if ((isSizeRequired && !selectedSize) || (isColorRequired && !selectedColor)) {
                stockInfo.innerText = "Vui lòng chọn đủ Kích thước và Màu sắc.";
                stockInfo.style.display = 'block';
                quantityInput.max = 1;
                quantityInput.value = 1;
                quantityInput.disabled = true;
                addToCartBtn.disabled = true;
                buyNowBtn.disabled = true;
                return;
            }

            // 2. Tìm biến thể khớp với lựa chọn
            const selectedVariant = productVariants.find(v => 
                (v.sizeName === selectedSize || !isSizeRequired) &&
                (v.colorName === selectedColor || !isColorRequired)
            );

            if (selectedVariant && selectedVariant.stock > 0) {
                stockInfo.style.display = 'none';
                quantityInput.max = selectedVariant.stock;
                quantityInput.value = 1;
                quantityInput.disabled = false;
                addToCartBtn.disabled = false;
                buyNowBtn.disabled = false;
                // Có thể cập nhật SKU ở đây nếu cần (ex: document.getElementById('sku-display').innerText = selectedVariant.sku;)
            } else {
                stockInfo.innerText = "Hết hàng hoặc không tồn tại.";
                stockInfo.style.display = 'block';
                quantityInput.max = 1;
                quantityInput.value = 1;
                quantityInput.disabled = true;
                addToCartBtn.disabled = true;
                buyNowBtn.disabled = true;
            }
        };


        const loadProductVariants = () => {
            fetch(/*[[@{/api/products/{productId}/variants(productId=${product.id})}]]*/)
                .then(res => res.json())
                .then(variants => {
                    productVariants = variants.map(v => ({
                        id: v.id,
                        sku: v.sku,
                        sizeName: v.size?.sizeName || null,
                        colorName: v.color?.colorName || null,
                        colorCode: v.color?.colorCode || null,
                        stock: v.stockQuantity || 0
                    }));
                    updateVariantOptions();
                })
                .catch(err => {
                    console.error("Error loading product variants:", err);
                    document.getElementById('size-options-container').innerHTML =
                        '<p class="text-danger">Lỗi tải kích thước.</p>';
                    document.getElementById('color-options-container').innerHTML =
                        '<p class="text-danger">Lỗi tải màu sắc.</p>';
                });
        };


        // --- HÀM CHUNG ---
        const toggleReviewForm = () => {
            const form = document.getElementById('review-form-container');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        };
        
        const addToCart = () => {
            // 1. Kiểm tra xem đã chọn đủ size và color chưa
            const isSizeRequired = uniqueSizes.length > 0;
            const isColorRequired = uniqueColors.length > 0;
            
            if ((isSizeRequired && !selectedSize) || (isColorRequired && !selectedColor)) {
                alert('Vui lòng chọn đủ Kích thước và Màu sắc!');
                return;
            }
            
            // 2. Tìm variant ID
            const selectedVariant = productVariants.find(v => 
                (v.sizeName === selectedSize || !isSizeRequired) &&
                (v.colorName === selectedColor || !isColorRequired)
            );
            
            if (!selectedVariant) {
                alert('Không tìm thấy sản phẩm với lựa chọn này!');
                return;
            }
            
            if (selectedVariant.stock <= 0) {
                alert('Sản phẩm đã hết hàng!');
                return;
            }
            
            // 3. Lấy số lượng
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            
            if (quantity > selectedVariant.stock) {
                alert(`Chỉ còn ${selectedVariant.stock} sản phẩm trong kho!`);
                return;
            }
            
            // 4. Gửi AJAX request để thêm vào giỏ (không redirect)
            const contextPath = /*[[@{/}]]*/ '/';
            const formData = new FormData();
            formData.append('productId', productId);
            formData.append('variantId', selectedVariant.id);
            formData.append('quantity', quantity);
            formData.append('_csrf', csrfToken);
            
            fetch(contextPath + 'cart/items', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    
                    // Có thể cập nhật số lượng giỏ hàng trên header nếu có
                } else {
                    alert('Có lỗi xảy ra, vui lòng thử lại!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra, vui lòng thử lại!');
            });
        };
        
        const buyNow = () => {
            // 1. Kiểm tra xem đã chọn đủ size và color chưa
            const isSizeRequired = uniqueSizes.length > 0;
            const isColorRequired = uniqueColors.length > 0;
            
            if ((isSizeRequired && !selectedSize) || (isColorRequired && !selectedColor)) {
                alert('Vui lòng chọn đủ Kích thước và Màu sắc!');
                return;
            }
            
            // 2. Tìm variant ID
            const selectedVariant = productVariants.find(v => 
                (v.sizeName === selectedSize || !isSizeRequired) &&
                (v.colorName === selectedColor || !isColorRequired)
            );
            
            if (!selectedVariant) {
                alert('Không tìm thấy sản phẩm với lựa chọn này!');
                return;
            }
            
            if (selectedVariant.stock <= 0) {
                alert('Sản phẩm đã hết hàng!');
                return;
            }
            
            // 3. Lấy số lượng
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            
            if (quantity > selectedVariant.stock) {
                alert(`Chỉ còn ${selectedVariant.stock} sản phẩm trong kho!`);
                return;
            }
            
            // 4. Gửi AJAX request và redirect đến checkout
            const contextPath = /*[[@{/}]]*/ '/';
            const formData = new FormData();
            formData.append('productId', productId);
            formData.append('variantId', selectedVariant.id);
            formData.append('quantity', quantity);
            formData.append('buyNow', 'true');
            formData.append('_csrf', csrfToken);
            
            fetch(contextPath + 'cart/items', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.redirect) {
                    // Redirect đến checkout
                    window.location.href = contextPath.replace(/\/$/, '') + data.redirect;
                } else {
                    alert('Có lỗi xảy ra, vui lòng thử lại!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra, vui lòng thử lại!');
            });
        }
        
        // --- DOMContentLoaded ---
        document.addEventListener("DOMContentLoaded", function () {
            // Khởi tạo tải ảnh và biến thể
            loadProductImages();
            loadProductVariants();
        });
    </script>
	</th:block>
</body>
</html>