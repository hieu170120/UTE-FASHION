<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	layout:decorate="~{layout/default}">

<head>
<title th:text="${product.productName}">Product Detail</title>
<th:block layout:fragment="styles">
	<link rel="stylesheet"
		href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
	<style>
/* --- General & Typography --- */
body {
	font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
		"Helvetica Neue", Arial, sans-serif;
}

.breadcrumb {
	background-color: transparent;
	font-size: 14px;
}

.product-details h2 {
	font-size: 20px;
	font-weight: normal;
	text-transform: uppercase;
	margin-bottom: 8px;
}

.product-details .product-meta {
	font-size: 14px;
	color: #888;
	margin-bottom: 20px;
}

.option-label {
	font-weight: bold;
	margin-bottom: 10px;
	display: block;
	font-size: 16px;
}

.size-guide-link {
	display: block;
	margin-top: 10px;
	font-size: 14px;
	color: #000;
	text-decoration: none;
}

.size-guide-link:hover {
	text-decoration: underline;
}

/* --- MODIFIED: Image Gallery for Lazy Loading --- */
.thumbnail-list {
	display: flex;
	flex-direction: column;
	gap: 10px;
	max-height: 500px;
	overflow-y: auto;
}

.thumbnail-list.loading-state {
	/* Chiều cao giả định cho thumbnail list khi đang tải */
	min-height: 100px;
}

.thumbnail-item img {
	width: 100%;
	height: auto;
	cursor: pointer;
	border: 2px solid transparent;
	transition: border-color 0.2s, opacity 0.4s ease;
	/* Added opacity transition */
	opacity: 0; /* Initially hidden for fade-in */
	background-color: #f0f0f0;
}

.thumbnail-item img.loaded {
	opacity: 1;
}

.thumbnail-item img.active, .thumbnail-item img:hover {
	border-color: #000;
}

.main-image img {
	width: 100%;
	height: auto;
	object-fit: contain;
	transition: opacity 0.4s ease; /* Added opacity transition */
	opacity: 0; /* Initially hidden for fade-in */
	background-color: #f0f0f0;
}

.main-image img.loaded {
	opacity: 1;
}

.main-image-placeholder {
	min-height: 400px; /* Giả định chiều cao ảnh chính */
	background-color: #f0f0f0;
	display: flex;
	justify-content: center;
	align-items: center;
}

/* --- Pricing --- */
.product-price .sale-price {
	font-size: 28px;
	font-weight: bold;
	color: #e60023;
}

.product-price .original-price {
	font-size: 20px;
	color: #888;
	margin-left: 10px;
}

.product-price .discount-badge {
	background-color: #e60023;
	color: white;
	font-size: 14px;
	font-weight: bold;
	padding: 4px 8px;
	border-radius: 4px;
	margin-left: 10px;
	vertical-align: middle;
}

/* --- Size & Color Options --- */
.size-options, .color-options {
	display: flex;
	flex-wrap: wrap;
	gap: 10px;
	min-height: 40px;
}

.size-option {
	border: 1px solid #ccc;
	padding: 8px 16px;
	cursor: pointer;
	background-color: #fff;
	transition: border-color 0.2s;
	position: relative;
}

.size-option.out-of-stock {
	background-color: #f2f2f2;
	color: #ccc;
	cursor: not-allowed;
	text-decoration: line-through;
}

.size-option:not(.out-of-stock):hover {
	border-color: #000;
}

.size-option.active {
	border-color: #000;
}

.size-option.active::after {
	content: '';
	display: block;
	width: 15px;
	height: 15px;
	background-image:
		url('https://img.icons8.com/ios-filled/50/000000/checkmark--v1.png');
	background-size: contain;
	background-repeat: no-repeat;
	position: absolute;
	top: -1px;
	right: -1px;
}

.color-option {
	width: 32px;
	height: 32px;
	border-radius: 50%;
	cursor: pointer;
	border: 1px solid #ccc;
	padding: 2px;
	transition: border-color 0.2s;
	display: flex;
	justify-content: center;
	align-items: center;
}

.color-option.out-of-stock {
	cursor: not-allowed;
	opacity: 0.4;
}

.color-option:not(.out-of-stock):hover {
	border-color: #000;
}

.color-option.active {
	border-color: #000;
	border-width: 2px;
}

.color-swatch {
	width: 100%;
	height: 100%;
	border-radius: 50%;
	display: block;
}

/* --- Quantity & Action Buttons --- */
.quantity-selector {
	display: flex;
	border: 1px solid #ccc;
	width: 150px;
	height: 40px;
	align-items: center;
}

.quantity-selector button {
	background-color: transparent;
	border: none;
	font-size: 20px;
	cursor: pointer;
	padding: 0 15px;
	color: #555;
	height: 100%;
}

.quantity-selector input {
	width: 100%;
	border: none;
	text-align: center;
	font-size: 16px;
	font-weight: bold;
	-moz-appearance: textfield;
}

.quantity-selector input::-webkit-outer-spin-button, .quantity-selector input::-webkit-inner-spin-button
	{
	-webkit-appearance: none;
	margin: 0;
}

.action-buttons .btn {
	width: 100%;
	padding: 12px;
	font-size: 16px;
	font-weight: bold;
	text-transform: uppercase;
	border-radius: 0;
	border-width: 2px;
	transition: background-color 0.2s, color 0.2s;
}

.btn-add-to-cart {
	background-color: #fff;
	color: #000;
	border: 2px solid #000;
}

.btn-add-to-cart:hover {
	background-color: #f0f0f0;
	color: #000;
}

.btn-buy-now {
	background-color: #000;
	color: #fff;
	border: 2px solid #000;
}

.btn-buy-now:hover {
	background-color: #333;
	border-color: #333;
	color: #fff;
}

/* Loading Spinner Style */
.spinner-container {
	display: flex;
	justify-content: center;
	align-items: center;
	min-height: 100px;
}

/* ===== REVIEW SECTION STYLES ===== */
.review-section {
	margin-top: 40px;
	padding: 20px 0;
}

.review-header-compact {
	padding: 30px;
	background: white;
	border: 1px solid #e0e0e0;
	border-radius: 8px;
	margin-bottom: 20px;
}

.review-header-compact h4 {
	font-size: 1.2rem;
	font-weight: 700;
	color: #1a1a1a;
}

.overall-rating {
	padding: 15px;
}

.rating-number {
	font-size: 3rem;
	font-weight: 700;
	color: #1a1a1a;
	display: inline;
}

.rating-text {
	font-size: 1.5rem;
	color: #666;
	display: inline;
}

.star-rating-summary {
	color: #ffc107;
	font-size: 1.2rem;
	margin: 10px 0;
}

.review-count {
	font-size: 0.85rem;
	color: #666;
	margin-top: 8px;
}

.rating-breakdown {
	padding: 10px 0;
}

.rating-bar {
	display: flex;
	align-items: center;
	gap: 10px;
	margin-bottom: 8px;
	font-size: 0.9rem;
}

.rating-stars {
	color: #ffc107;
	font-size: 0.85rem;
	min-width: 80px;
}

.progress-bar-container {
	flex: 1;
}

.rating-bar .progress {
	height: 8px;
	background-color: #f0f0f0;
	border-radius: 10px;
}

.rating-percent {
	min-width: 50px;
	text-align: right;
	color: #666;
	font-size: 0.85rem;
}

.rating-count {
	min-width: 40px;
	text-align: right;
	color: #999;
	font-size: 0.85rem;
}

.btn-write-review-compact {
	background: #1a1a1a;
	color: white;
	border: 2px solid #1a1a1a;
	padding: 10px 30px;
	font-weight: 600;
	border-radius: 8px;
	transition: all 0.3s ease;
	font-size: 0.95rem;
}

.btn-write-review-compact:hover {
	background: white;
	color: #1a1a1a;
}

/* Review Form */
#review-form-container {
	background: #f8f9fa;
	padding: 30px;
	border-radius: 12px;
	margin-bottom: 30px;
	border: 2px solid #e0e0e0;
}

#review-form-container h5 {
	font-weight: 700;
	color: #1a1a1a;
	margin-bottom: 25px;
}

.rating-input-group {
	display: flex;
	flex-direction: row-reverse;
	justify-content: flex-end;
	gap: 5px;
	font-size: 2.5rem;
}

.rating-input-group input[type="radio"] {
	display: none;
}

.rating-input-group label {
	cursor: pointer;
	color: #ddd;
	transition: all 0.3s ease;
}

.rating-input-group label:hover,
.rating-input-group label:hover ~ label,
.rating-input-group input[type="radio"]:checked ~ label {
	color: #d4af37;
	transform: scale(1.1);
}

.upload-area {
	border: 3px dashed #e0e0e0;
	border-radius: 12px;
	padding: 30px;
	text-align: center;
	cursor: pointer;
	transition: all 0.3s ease;
	background: #f5f5f5;
	margin-top: 10px;
}

.upload-area:hover {
	border-color: #1a1a1a;
	background: white;
}

.upload-area i {
	font-size: 2.5rem;
	color: #1a1a1a;
	margin-bottom: 10px;
	display: block;
}

.upload-area input[type="file"] {
	display: none;
}

.preview-container {
	display: grid;
	grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
	gap: 10px;
	margin-top: 15px;
}

.preview-item {
	position: relative;
	border-radius: 8px;
	overflow: hidden;
	aspect-ratio: 1;
	border: 2px solid #e0e0e0;
}

.preview-item img,
.preview-item video {
	width: 100%;
	height: 100%;
	object-fit: cover;
}

.preview-item .remove-btn {
	position: absolute;
	top: 5px;
	right: 5px;
	background: rgba(0,0,0,0.7);
	color: white;
	border: none;
	border-radius: 50%;
	width: 25px;
	height: 25px;
	cursor: pointer;
	display: flex;
	align-items: center;
	justify-content: center;
	font-size: 12px;
	transition: all 0.3s ease;
}

.preview-item .remove-btn:hover {
	background: #dc3545;
	transform: scale(1.1);
}

.char-counter {
	text-align: right;
	font-size: 0.85rem;
	color: #666;
	margin-top: 5px;
}

/* Review List */
.review-list-compact {
	padding: 20px;
	background: white;
	border: 1px solid #e0e0e0;
	border-radius: 8px;
}

.review-list-header {
	font-size: 1rem;
	font-weight: 600;
	padding-bottom: 15px;
	border-bottom: 2px solid #e0e0e0;
	margin-bottom: 20px;
}

.review-item {
	padding: 20px 0;
	border-bottom: 1px solid #f0f0f0;
	margin-bottom: 0;
}

.review-item:last-child {
	border-bottom: none;
}

.review-author {
	display: flex;
	align-items: center;
	gap: 12px;
	margin-bottom: 12px;
}

.review-author img {
	width: 45px;
	height: 45px;
	border-radius: 50%;
	border: 2px solid #e0e0e0;
}

.review-author-name {
	font-weight: 600;
	color: #1a1a1a;
	font-size: 1rem;
}

.review-meta {
	color: #888;
	font-size: 0.85rem;
}

.review-verified {
	color: #28a745;
	font-size: 0.85rem;
	font-weight: 600;
	margin-left: 10px;
}

.review-content {
	margin-top: 12px;
}

.review-title {
	font-weight: 600;
	color: #1a1a1a;
	margin-bottom: 8px;
}

.review-images {
	display: grid;
	grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
	gap: 10px;
	margin-top: 15px;
}

.review-images img,
.review-images video {
	width: 100%;
	height: 100px;
	object-fit: cover;
	border-radius: 8px;
	cursor: pointer;
	border: 2px solid #e0e0e0;
	transition: all 0.3s ease;
}

.review-images img:hover {
	transform: scale(1.05);
	border-color: #1a1a1a;
}

.video-thumbnail:hover {
	opacity: 0.8;
}

.video-thumbnail video {
	width: 100%;
	height: 100px;
	object-fit: cover;
	border-radius: 8px;
	border: 2px solid #e0e0e0;
}
</style>
</th:block>
</head>

<body>

	<div class="container" layout:fragment="content">
		<nav aria-label="breadcrumb">
			<ol class="breadcrumb">
				<li class="breadcrumb-item"><a th:href="@{/}">TRANG CHỦ</a></li>
				<li class="breadcrumb-item"><a th:href="@{/products}">TẤT
						CẢ SẢN PHẨM</a></li>
				<li class="breadcrumb-item active" aria-current="page"
					th:text="${product.productName.toUpperCase()}"></li>
			</ol>
		</nav>

		<div class="row">
			<div class="col-md-7">
				<div class="row">
					<div class="col-md-2 order-md-1">
						<div id="thumbnail-list" class="thumbnail-list loading-state">
							<div class="spinner-container">
								<div class="spinner-border spinner-border-sm" role="status">
									<span class="visually-hidden">Loading images...</span>
								</div>
							</div>
						</div>
					</div>
					<div class="col-md-10 order-md-2">
						<div class="main-image">
							<div id="main-image-placeholder" class="main-image-placeholder">
								<div class="spinner-border text-primary" role="status">
									<span class="visually-hidden">Loading main image...</span>
								</div>
							</div>
							<img id="mainProductImage" style="display: none;"
								alt="Main image">
						</div>
					</div>
				</div>
			</div>

			<div class="col-md-5 product-details">
				<h2 th:text="${product.productName}"></h2>
				<p class="product-meta">
					Thương hiệu: <span
						th:text="${brand != null ? brand.brandName : 'N/A'}"></span> | Mã
					SP: <span th:text="${product.sku}"></span>
				</p>

				<div class="my-3 product-price d-flex align-items-center">
					<span class="sale-price"
						th:text="${#numbers.formatDecimal(product.salePrice, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
					<span class="original-price text-decoration-line-through"
						th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
					<span class="discount-badge"
						th:if="${product.price > 0 and product.salePrice < product.price}"
						th:text="'-' + ${#numbers.formatInteger(((product.price - product.salePrice) * 100) / product.price, 0)} + '%'"></span>
				</div>

				<div class="mb-4">
					<label class="option-label">Kích thước</label>
					<div id="size-options-container" class="size-options">
						<div class="spinner-border spinner-border-sm text-secondary"
							role="status">
							<span class="visually-hidden">Loading sizes...</span>
						</div>
					</div>
					<a href="#" class="size-guide-link">HƯỚNG DẪN CHỌN SIZE</a>
				</div>
				<div class="mb-4">
					<label class="option-label">Màu sắc</label>
					<div id="color-options-container" class="color-options">
						<div class="spinner-border spinner-border-sm text-secondary"
							role="status">
							<span class="visually-hidden">Loading colors...</span>
						</div>
					</div>
				</div>

				<div class="mb-4">
					<label class="option-label">Số lượng</label>
					<div class="quantity-selector">
						<button type="button" onclick="this.nextElementSibling.stepDown()">-</button>
						<input type="number" id="quantity"
							class="form-control text-center" value="1" min="1">
						<button type="button"
							onclick="this.previousElementSibling.stepUp()">+</button>
					</div>
					<p id="stock-info" class="mt-2 text-danger" style="display: none;">Hết
						hàng</p>
				</div>

				<div class="d-grid gap-2 mt-4 action-buttons">
					<button class="btn btn-add-to-cart" type="button"
						onclick="addToCart()">THÊM VÀO GIỎ</button>
					<button class="btn btn-buy-now" type="button"
						onclick="buyNow()">MUA NGAY</button>
				</div>

				<div class="mt-4 product-description"
					th:utext="${product.description}"></div>
			</div>
		</div>

		<!-- Review Section -->
		<div class="row review-section">
			<div class="col-12">
				<!-- Review Header with Summary -->
				<div class="review-header-compact">
					<h4 class="mb-4">Đánh giá sản phẩm</h4>
					
					<div class="row align-items-center mb-4">
						<!-- Left: Overall Rating -->
						<div class="col-md-3 text-center">
							<div class="overall-rating">
								<div class="rating-number" th:text="${ratingStats.totalReviews > 0 ? #numbers.formatDecimal(ratingStats.averageRating, 1, 1) : '0.0'}">0.0</div>
								<div class="rating-text">/5</div>
								<div class="star-rating-summary">
									<th:block th:with="rating=${ratingStats.averageRating}">
										<i th:each="i : ${#numbers.sequence(1, 5)}"
											th:class="${i <= rating} ? 'bi bi-star-fill' : 'bi bi-star'"></i>
									</th:block>
								</div>
								<div class="review-count" th:text="'Dựa trên ' + ${ratingStats.totalReviews} + ' đánh giá'">Dựa trên 0 đánh giá</div>
							</div>
						</div>
						
						<!-- Middle: Rating Breakdown -->
						<div class="col-md-6">
							<div class="rating-breakdown">
								<div class="rating-bar" th:each="star : ${#numbers.sequence(5, 1)}">
									<div class="rating-stars">
										<i th:each="i : ${#numbers.sequence(1, star)}" class="bi bi-star-fill"></i>
									</div>
									<div class="progress-bar-container">
										<div class="progress">
											<div class="progress-bar bg-warning" role="progressbar" 
												th:style="'width: ' + ${ratingStats.getRatingPercentage(star)} + '%'">
											</div>
										</div>
									</div>
									<div class="rating-percent">
										<span th:text="${#numbers.formatDecimal(ratingStats.getRatingPercentage(star), 1, 1)} + '%'">0.0%</span>
									</div>
									<div class="rating-count">
										(<span th:text="${ratingStats.getRatingCount(star)}">0</span>)
									</div>
								</div>
							</div>
						</div>
						
						<!-- Right: Write Review Button -->
						<div class="col-md-3 text-center">
							<button class="btn btn-write-review-compact" onclick="toggleReviewForm()">
								<i class="bi bi-pencil-square"></i> Viết đánh giá
							</button>
						</div>
					</div>
				</div>

				<!-- Review Body -->
				<div class="review-body">
					<!-- Review Form -->
					<div id="review-form-container" style="display: none;">
						<h5><i class="bi bi-chat-left-text"></i> Viết đánh giá của bạn</h5>
						<div id="reviewAlertContainer"></div>
						
						<form id="review-form">
							<input type="hidden" id="reviewProductId" name="productId" th:value="${product.id}">

							<!-- Rating -->
							<div class="mb-4">
								<label class="form-label">Đánh giá sao <span class="text-danger">*</span></label>
								<div class="rating-input-group">
									<input type="radio" id="star5" name="rating" value="5" required />
									<label for="star5" title="Tuyệt vời">★</label>
									<input type="radio" id="star4" name="rating" value="4" />
									<label for="star4" title="Rất tốt">★</label>
									<input type="radio" id="star3" name="rating" value="3" />
									<label for="star3" title="Bình thường">★</label>
									<input type="radio" id="star2" name="rating" value="2" />
									<label for="star2" title="Kém">★</label>
									<input type="radio" id="star1" name="rating" value="1" />
									<label for="star1" title="Rất tệ">★</label>
								</div>
							</div>

							<!-- Title -->
							<div class="mb-3">
								<label for="reviewTitle" class="form-label">Tiêu đề đánh giá</label>
								<input type="text" class="form-control" id="reviewTitle" name="title" 
									placeholder="Tóm tắt đánh giá của bạn..." maxlength="100">
							</div>

							<!-- Comment -->
							<div class="mb-3">
								<label for="reviewComment" class="form-label">Nội dung <span class="text-danger">*</span></label>
								<textarea class="form-control" id="reviewComment" name="comment" 
									placeholder="Chia sẻ trải nghiệm của bạn về sản phẩm... (tối thiểu 50 ký tự)"
									minlength="50" rows="4" required></textarea>
								<div class="char-counter">
									<span id="charCount">0</span> / 50 ký tự tối thiểu
								</div>
							</div>

							<!-- Image Upload -->
							<div class="mb-3">
								<label class="form-label">Thêm ảnh (Tùy chọn)</label>
								<div class="upload-area" id="imageUploadArea">
									<i class="bi bi-cloud-upload"></i>
									<p class="mb-0"><strong>Nhấp để tải ảnh lên</strong></p>
									<small class="text-muted">JPG, PNG, GIF - Tối đa 5 ảnh</small>
									<input type="file" id="imageInput" accept="image/*" multiple>
								</div>
								<div id="imagePreview" class="preview-container"></div>
							</div>

							<!-- Video Upload -->
							<div class="mb-3">
								<label class="form-label">Thêm video (Tùy chọn)</label>
								<div class="upload-area" id="videoUploadArea">
									<i class="bi bi-camera-video"></i>
									<p class="mb-0"><strong>Nhấp để tải video lên</strong></p>
									<small class="text-muted">MP4, MOV, AVI - Tối đa 2 video</small>
									<input type="file" id="videoInput" accept="video/*" multiple>
								</div>
								<div id="videoPreview" class="preview-container"></div>
							</div>

							<!-- Buttons -->
							<div class="d-flex gap-2">
								<button type="submit" class="btn btn-dark" id="submitReviewBtn">
									<i class="bi bi-send"></i> Gửi đánh giá
								</button>
								<button type="button" class="btn btn-secondary" onclick="toggleReviewForm()">
									<i class="bi bi-x-circle"></i> Hủy
								</button>
							</div>
						</form>
					</div>

					<!-- Review List -->
					<div class="review-list-compact">
						<div class="d-flex justify-content-between align-items-center review-list-header">
							<span>Đánh giá <span th:text="${reviewPage.totalElements}">2</span></span>
							<select class="form-select form-select-sm" style="width: auto;">
								<option selected>Mới nhất</option>
								<option>Cũ nhất</option>
							</select>
						</div>
						
						<div id="review-list">
						<div class="review-item" th:each="review : ${reviewPage.content}">
							<div class="review-author">
								<img th:src="${review.userAvatar != null ? review.userAvatar : 'https://ui-avatars.com/api/?name=' + review.userFullName}" 
									alt="Avatar">
								<div>
									<div class="review-author-name" th:text="${review.userFullName ?: 'Khách hàng'}"></div>
									<div class="review-meta">
										<span th:text="${#temporals.format(review.createdAt, 'dd/MM/yyyy')}"></span>
										<span class="review-verified" th:if="${review.isVerifiedPurchase}">
											<i class="bi bi-patch-check-fill"></i> Đã mua hàng
										</span>
									</div>
								</div>
							</div>
							
							<div class="star-rating" style="color: #d4af37; margin-bottom: 10px;">
								<i th:each="i : ${#numbers.sequence(1, 5)}"
									th:class="${i <= review.rating} ? 'bi bi-star-fill' : 'bi bi-star'"></i>
							</div>
							
							<div class="review-content">
								<p class="review-title" th:if="${review.title}" th:text="${review.title}"></p>
								<p th:text="${review.comment}"></p>
								
								<!-- Review Images/Videos -->
								<div class="review-images" th:if="${review.imageUrls != null and !review.imageUrls.isEmpty()} or ${review.videoUrls != null and !review.videoUrls.isEmpty()}">
									<img th:each="imgUrl : ${review.imageUrls}" 
										th:src="${imgUrl}" 
										alt="Review image"
										style="cursor: pointer;"
										th:data-url="${imgUrl}"
										onclick="openMediaModal(this.dataset.url, 'image')"
										title="Nhấp để phóng to">
									<div th:each="vidUrl : ${review.videoUrls}" class="video-thumbnail" style="position: relative; cursor: pointer;"
										th:data-url="${vidUrl}"
										onclick="openMediaModal(this.dataset.url, 'video')"
										title="Nhấp để xem video">
										<video th:src="${vidUrl}" style="pointer-events: none;"></video>
										<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; color: white; text-shadow: 0 0 10px rgba(0,0,0,0.8);">
											<i class="bi bi-play-circle-fill"></i>
										</div>
									</div>
								</div>
								</div>
							</div>
							
							<div th:if="${reviewPage.totalElements == 0}" 
								class="text-center text-muted py-5">
								<i class="bi bi-chat-left-text" style="font-size: 3rem;"></i>
								<p class="mt-3">Chưa có đánh giá nào cho sản phẩm này.</p>
								<p>Hãy là người đầu tiên đánh giá!</p>
							</div>
							</div>
						</div>

					<!-- Pagination -->
					<nav aria-label="Review pagination" th:if="${reviewPage.totalPages > 1}" class="mt-4">
						<ul class="pagination justify-content-center">
							<li class="page-item" th:classappend="${reviewPage.first} ? 'disabled'">
								<a class="page-link" href="#" onclick="loadReviews(0); return false;">&laquo;</a>
							</li>
							<li class="page-item"
								th:each="pageNumber : ${#numbers.sequence(0, reviewPage.totalPages - 1)}"
								th:classappend="${pageNumber == reviewPage.number} ? 'active'">
								<a class="page-link" href="#" th:text="${pageNumber + 1}"
									th:onclick="'loadReviews(' + ${pageNumber} + '); return false;'"></a>
							</li>
							<li class="page-item" th:classappend="${reviewPage.last} ? 'disabled'">
								<a class="page-link" href="#" 
									th:onclick="'loadReviews(' + ${reviewPage.totalPages - 1} + '); return false;'">&raquo;</a>
							</li>
						</ul>
					</nav>
				</div>
			</div>
		</div>
		
		<!-- Lightbox Modal for Images/Videos -->
		<div class="modal fade" id="mediaModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered modal-xl">
				<div class="modal-content bg-dark">
					<div class="modal-header border-0">
						<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
					</div>
					<div class="modal-body text-center p-0">
						<img id="modalImage" src="" class="img-fluid" style="max-height: 80vh; display: none;" alt="Review image">
						<video id="modalVideo" controls class="w-100" style="max-height: 80vh; display: none;">
							<source src="" type="video/mp4">
						</video>
					</div>
				</div>
			</div>
		</div>
	</div>

	<th:block layout:fragment="scripts">
		<script th:inline="javascript">
        /*<![CDATA[*/
        const productId = /*[[${product.id}]]*/ null;
        const csrfToken = /*[[${_csrf.token}]]*/ '';
        const csrfHeader = /*[[${_csrf.headerName}]]*/ '';
        // Biến toàn cục để lưu trữ tất cả biến thể đã tải
        let productVariants = [];
        let uniqueSizes = [];
        let uniqueColors = [];
        let selectedSize = null;
        let selectedColor = null;
        /*]]>*/

        // --- HÀM XỬ LÝ ẢNH ---
        const changeMainImage = (thumbnailEl) => {
            const mainImage = document.getElementById('mainProductImage');
            document.querySelectorAll('.thumbnail-item img').forEach(img => img.classList.remove('active'));
            thumbnailEl.classList.add('active');

            // Ẩn ảnh cũ và hiện placeholder
            mainImage.style.display = 'none';
            document.getElementById('main-image-placeholder').style.display = 'flex';

            // Tạo một đối tượng Image để tải ảnh mới
            const newImage = new Image();
            newImage.onload = function() {
                mainImage.src = newImage.src;
                mainImage.classList.add('loaded');
                mainImage.style.display = 'block';
                document.getElementById('main-image-placeholder').style.display = 'none';
            };
            newImage.onerror = function() {
                 mainImage.src = 'https://via.placeholder.com/500?text=Error';
                 mainImage.classList.add('loaded');
                 mainImage.style.display = 'block';
                 document.getElementById('main-image-placeholder').style.display = 'none';
                 console.error("Failed to load image:", thumbnailEl.dataset.src);
            };

            // Bắt đầu tải ảnh mới
            newImage.src = thumbnailEl.dataset.src;
        };

        const loadProductImages = () => {
            const thumbnailList = document.getElementById('thumbnail-list');
            const mainImage = document.getElementById('mainProductImage');

            fetch(/*[[@{/api/products/{productId}/images(productId=${product.id})}]]*/).then(res => res.json()).then(images => {
                thumbnailList.innerHTML = '';
                thumbnailList.classList.remove('loading-state');
                
                if (images && images.length > 0) {
                    images.forEach((img, index) => {
                        const activeClass = index === 0 ? 'active' : '';
                        const thumbnailHtml = `
                            <div class="thumbnail-item">
                                <img class="lazy-image"
                                     src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                                     data-src="${img.imageUrl}"
                                     alt="Thumbnail ${index}"
                                     class="${activeClass}"
                                     onclick="changeMainImage(this)">
                            </div>`;
                        thumbnailList.innerHTML += thumbnailHtml;
                    });
                    
                    // Lazy load the thumbnail images
                    const lazyImages = thumbnailList.querySelectorAll('.lazy-image');
                    lazyImages.forEach(lazyImage => {
                        const image = new Image();
                        image.onload = () => {
                            lazyImage.src = lazyImage.dataset.src;
                            lazyImage.classList.add('loaded');
                        };
                        image.src = lazyImage.dataset.src;
                    });

                    // Set initial main image
                    const firstImageSrc = images[0].imageUrl;
                    mainImage.src = firstImageSrc;
                    mainImage.classList.add('loaded');
                    mainImage.style.display = 'block';
                    document.getElementById('main-image-placeholder').style.display = 'none';
                    
                } else {
                    mainImage.src = 'https://via.placeholder.com/500';
                    mainImage.classList.add('loaded');
                    mainImage.style.display = 'block';
                    document.getElementById('main-image-placeholder').style.display = 'none';
                    thumbnailList.innerHTML = '<div class="text-muted p-2">No images</div>';
                }
            }).catch(err => {
                console.error("Error loading product images:", err);
                thumbnailList.innerHTML = '<div class="text-danger p-2">Lỗi tải ảnh.</div>';
                document.getElementById('main-image-placeholder').innerHTML = '<span class="text-danger">Lỗi tải ảnh.</span>';
            });
        };

        // --- HÀM XỬ LÝ BIẾN THỂ (SIZE/COLOR) ---
        const updateVariantOptions = () => {
            const sizeContainer = document.getElementById('size-options-container');
            const colorContainer = document.getElementById('color-options-container');
            
            // Xóa nội dung cũ
            sizeContainer.innerHTML = '';
            colorContainer.innerHTML = '';

            // 1. Lọc và lưu trữ các giá trị size và color duy nhất
            uniqueSizes = [...new Set(productVariants.map(v => v.sizeName))].filter(s => s).sort();
            uniqueColors = [...new Set(productVariants.map(v => ({ name: v.colorName, code: v.colorCode })))].filter(c => c.name);

            // 2. Render Size Options
            uniqueSizes.forEach(sizeName => {
                const isActive = sizeName === selectedSize ? 'active' : '';
                
                // Kiểm tra xem size này có variant nào hợp lệ (còn hàng hoặc không cần color) không
                const isAvailable = productVariants.some(v => v.sizeName === sizeName && v.stock > 0);
                const isOutOfStock = !isAvailable ? 'out-of-stock' : '';
                
                sizeContainer.innerHTML += `
                    <span class="size-option ${isActive} ${isOutOfStock}"
                          data-size="${sizeName}"
                          onclick="${isOutOfStock ? '' : 'selectSize(this)'}">
                        ${sizeName}
                    </span>`;
            });

            // 3. Render Color Options
            const renderedColors = new Set();
            uniqueColors.forEach(color => {
                if(renderedColors.has(color.name)) return;
                renderedColors.add(color.name);

                const isActive = color.name === selectedColor ? 'active' : '';

                // Kiểm tra xem color này có variant nào hợp lệ (còn hàng hoặc không cần size) không
                const isAvailable = productVariants.some(v => v.colorName === color.name && v.stock > 0);
                const isOutOfStock = !isAvailable ? 'out-of-stock' : '';

                colorContainer.innerHTML += `
                    <span class="color-option ${isActive} ${isOutOfStock}"
                          data-color="${color.name}"
                          onclick="${isOutOfStock ? '' : 'selectColor(this)'}">
                        <span class="color-swatch" style="background-color:${color.code};"></span>
                    </span>`;
            });
            
            // Nếu không có size/color nào, hiển thị thông báo "Hết hàng"
            if (uniqueSizes.length === 0 && uniqueColors.length === 0 && productVariants.length > 0) {
                 sizeContainer.innerHTML = '<p class="text-muted">Không có tùy chọn kích thước.</p>';
                 colorContainer.innerHTML = '<p class="text-muted">Không có tùy chọn màu sắc.</p>';
            } else if (productVariants.length === 0) {
                 sizeContainer.innerHTML = '<p class="text-danger">Sản phẩm hiện đang hết hàng.</p>';
                 colorContainer.innerHTML = '<p class="text-danger">Sản phẩm hiện đang hết hàng.</p>';
            }

            // Cập nhật trạng thái sau khi render xong
            updateSelectionStatus();
        };
        
        const selectSize = (el) => {
            const newSize = el.dataset.size;
            if (selectedSize === newSize) {
                selectedSize = null; // Bỏ chọn
            } else {
                selectedSize = newSize;
            }
            // Xóa active class cũ và thêm vào cái mới (nếu có)
            document.querySelectorAll('.size-option').forEach(s => s.classList.remove('active'));
            if (selectedSize) {
                el.classList.add('active');
            }
            updateSelectionStatus();
        };

        const selectColor = (el) => {
            const newColor = el.dataset.color;
            if (selectedColor === newColor) {
                selectedColor = null; // Bỏ chọn
            } else {
                selectedColor = newColor;
            }
            // Xóa active class cũ và thêm vào cái mới (nếu có)
            document.querySelectorAll('.color-option').forEach(c => c.classList.remove('active'));
            if (selectedColor) {
                el.classList.add('active');
            }
            updateSelectionStatus();
        };

        const updateSelectionStatus = () => {
            const stockInfo = document.getElementById('stock-info');
            const quantityInput = document.getElementById('quantity');
            const addToCartBtn = document.querySelector('.btn-add-to-cart');
            const buyNowBtn = document.querySelector('.btn-buy-now');

            // 1. Kiểm tra xem đã chọn đủ Size và Color (nếu chúng tồn tại)
            const isSizeRequired = uniqueSizes.length > 0;
            const isColorRequired = uniqueColors.length > 0;
            
            if ((isSizeRequired && !selectedSize) || (isColorRequired && !selectedColor)) {
                stockInfo.innerText = "Vui lòng chọn đủ Kích thước và Màu sắc.";
                stockInfo.style.display = 'block';
                quantityInput.max = 1;
                quantityInput.value = 1;
                quantityInput.disabled = true;
                addToCartBtn.disabled = true;
                buyNowBtn.disabled = true;
                return;
            }

            // 2. Tìm biến thể khớp với lựa chọn
            const selectedVariant = productVariants.find(v => 
                (v.sizeName === selectedSize || !isSizeRequired) &&
                (v.colorName === selectedColor || !isColorRequired)
            );

            if (selectedVariant && selectedVariant.stock > 0) {
                stockInfo.style.display = 'none';
                quantityInput.max = selectedVariant.stock;
                quantityInput.value = 1;
                quantityInput.disabled = false;
                addToCartBtn.disabled = false;
                buyNowBtn.disabled = false;
                // Có thể cập nhật SKU ở đây nếu cần (ex: document.getElementById('sku-display').innerText = selectedVariant.sku;)
            } else {
                stockInfo.innerText = "Hết hàng hoặc không tồn tại.";
                stockInfo.style.display = 'block';
                quantityInput.max = 1;
                quantityInput.value = 1;
                quantityInput.disabled = true;
                addToCartBtn.disabled = true;
                buyNowBtn.disabled = true;
            }
        };


        const loadProductVariants = () => {
            fetch(/*[[@{/api/products/{productId}/variants(productId=${product.id})}]]*/)
                .then(res => res.json())
                .then(variants => {
                    productVariants = variants.map(v => ({
                        id: v.id,
                        sku: v.sku,
                        sizeName: v.size?.sizeName || null,
                        colorName: v.color?.colorName || null,
                        colorCode: v.color?.colorCode || null,
                        stock: v.stockQuantity || 0
                    }));
                    updateVariantOptions();
                })
                .catch(err => {
                    console.error("Error loading product variants:", err);
                    document.getElementById('size-options-container').innerHTML =
                        '<p class="text-danger">Lỗi tải kích thước.</p>';
                    document.getElementById('color-options-container').innerHTML =
                        '<p class="text-danger">Lỗi tải màu sắc.</p>';
                });
        };


        // --- HÀM CHUNG ---
        const toggleReviewForm = () => {
            const form = document.getElementById('review-form-container');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        };
        
        // --- REVIEW UPLOAD FUNCTIONALITY ---
        let uploadedImageUrls = [];
        let uploadedVideoUrls = [];
        
        // Character counter
        const reviewComment = document.getElementById('reviewComment');
        if (reviewComment) {
            reviewComment.addEventListener('input', function() {
                const count = this.value.length;
                document.getElementById('charCount').textContent = count;
                document.getElementById('charCount').style.color = count >= 50 ? '#28a745' : '#666';
            });
        }
        
        // Image upload handlers
        const imageUploadArea = document.getElementById('imageUploadArea');
        const imageInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');
        
        if (imageUploadArea && imageInput) {
            imageUploadArea.addEventListener('click', () => imageInput.click());
            
            imageInput.addEventListener('change', async function(e) {
                const files = Array.from(e.target.files);
                if (files.length + uploadedImageUrls.length > 5) {
                    showReviewAlert('Bạn chỉ có thể tải lên tối đa 5 ảnh', 'warning');
                    return;
                }
                await uploadReviewFiles(files, 'image');
                imageInput.value = ''; // Reset input
            });
        }
        
        // Video upload handlers
        const videoUploadArea = document.getElementById('videoUploadArea');
        const videoInput = document.getElementById('videoInput');
        const videoPreview = document.getElementById('videoPreview');
        
        if (videoUploadArea && videoInput) {
            videoUploadArea.addEventListener('click', () => videoInput.click());
            
            videoInput.addEventListener('change', async function(e) {
                const files = Array.from(e.target.files);
                if (files.length + uploadedVideoUrls.length > 2) {
                    showReviewAlert('Bạn chỉ có thể tải lên tối đa 2 video', 'warning');
                    return;
                }
                await uploadReviewFiles(files, 'video');
                videoInput.value = ''; // Reset input
            });
        }
        
        // Upload files to Cloudinary
        async function uploadReviewFiles(files, type) {
            const formData = new FormData();
            files.forEach(file => formData.append('files', file));
            
            // IMPORTANT: Add CSRF token to FormData for multipart uploads
            const csrfToken = /*[[${_csrf.token}]]*/ '';
            if (csrfToken) {
                formData.append('_csrf', csrfToken);
            }
            
            try {
                showReviewAlert(`Đang tải ${type === 'image' ? 'ảnh' : 'video'} lên...`, 'info');
                
                const token = localStorage.getItem('token');
                const contextPath = /*[[@{/}]]*/ '/';
                
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                const response = await fetch(`${contextPath}api/v1/reviews/upload/${type}s`, {
                    method: 'POST',
                    headers: headers,
                    credentials: 'include', // Important for session cookies
                    body: formData
                });
                
                if (response.status === 401 || response.status === 403) {
                    showReviewAlert('Bạn cần đăng nhập để tải lên file', 'warning');
                    const contextPath = /*[[@{/}]]*/ '/';
                    setTimeout(() => {
                        window.location.href = `${contextPath}login?redirect=${encodeURIComponent(window.location.pathname)}`;
                    }, 1500);
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('Upload failed');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    if (type === 'image') {
                        uploadedImageUrls = uploadedImageUrls.concat(result.urls);
                        displayReviewPreviews(result.urls, 'image');
                    } else {
                        uploadedVideoUrls = uploadedVideoUrls.concat(result.urls);
                        displayReviewPreviews(result.urls, 'video');
                    }
                    showReviewAlert(`Tải ${type === 'image' ? 'ảnh' : 'video'} lên thành công!`, 'success');
                } else {
                    showReviewAlert(result.message || 'Tải lên thất bại', 'danger');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showReviewAlert(`Lỗi khi tải ${type === 'image' ? 'ảnh' : 'video'} lên`, 'danger');
            }
        }
        
        // Display previews
        function displayReviewPreviews(urls, type) {
            const previewContainer = type === 'image' ? imagePreview : videoPreview;
            
            urls.forEach(url => {
                const item = document.createElement('div');
                item.className = 'preview-item';
                
                if (type === 'image') {
                    item.innerHTML = `
                        <img src="${url}" alt="Preview">
                        <button type="button" class="remove-btn" onclick="removeReviewFile('${url}', 'image')">
                            <i class="bi bi-x"></i>
                        </button>
                    `;
                } else {
                    item.innerHTML = `
                        <video src="${url}" muted></video>
                        <button type="button" class="remove-btn" onclick="removeReviewFile('${url}', 'video')">
                            <i class="bi bi-x"></i>
                        </button>
                    `;
                }
                
                previewContainer.appendChild(item);
            });
        }
        
        // Remove file
        window.removeReviewFile = function(url, type) {
            if (type === 'image') {
                uploadedImageUrls = uploadedImageUrls.filter(u => u !== url);
                imagePreview.innerHTML = '';
                displayReviewPreviews(uploadedImageUrls, 'image');
            } else {
                uploadedVideoUrls = uploadedVideoUrls.filter(u => u !== url);
                videoPreview.innerHTML = '';
                displayReviewPreviews(uploadedVideoUrls, 'video');
            }
        };
        
        // Submit review form
        const reviewForm = document.getElementById('review-form');
        if (reviewForm) {
            reviewForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const submitBtn = document.getElementById('submitReviewBtn');
                const originalBtnText = submitBtn.innerHTML;
                
                // Get form data
                const rating = document.querySelector('input[name="rating"]:checked');
                if (!rating) {
                    showReviewAlert('Vui lòng chọn đánh giá sao', 'warning');
                    return;
                }
                
                const reviewData = {
                    productId: parseInt(document.getElementById('reviewProductId').value),
                    orderId: null, // Optional: set to null if reviewing without purchase
                    rating: parseInt(rating.value),
                    title: document.getElementById('reviewTitle').value,
                    comment: document.getElementById('reviewComment').value,
                    imageUrls: uploadedImageUrls,
                    videoUrls: uploadedVideoUrls
                };
                
                // Show loading
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Đang gửi...';
                
                try {
                    const token = localStorage.getItem('token');
                    const contextPath = /*[[@{/}]]*/ '/';
                    const csrfToken = /*[[${_csrf.token}]]*/ '';
                    const csrfHeader = /*[[${_csrf.headerName}]]*/ '';
                    
                    const headers = {
                        'Content-Type': 'application/json'
                    };
                    
                    // Add CSRF token for session-based auth
                    if (csrfToken && csrfHeader) {
                        headers[csrfHeader] = csrfToken;
                    }
                    
                    // Add JWT token if available
                    if (token) {
                        headers['Authorization'] = `Bearer ${token}`;
                    }
                    
                    const response = await fetch(`${contextPath}api/v1/reviews`, {
                        method: 'POST',
                        headers: headers,
                        credentials: 'include', // Important for session cookies
                        body: JSON.stringify(reviewData)
                    });
                    
                    if (response.ok) {
                        showReviewAlert('Đánh giá của bạn đã được gửi thành công! Đang chờ duyệt.', 'success');
                        reviewForm.reset();
                        uploadedImageUrls = [];
                        uploadedVideoUrls = [];
                        imagePreview.innerHTML = '';
                        videoPreview.innerHTML = '';
                        document.getElementById('charCount').textContent = '0';
                        
                        // Hide form after 2 seconds
                        setTimeout(() => {
                            toggleReviewForm();
                            location.reload();
                        }, 2000);
                    } else if (response.status === 401 || response.status === 403) {
                        // Not authenticated - redirect to login
                        showReviewAlert('Bạn cần đăng nhập để đánh giá sản phẩm', 'warning');
                        setTimeout(() => {
                            window.location.href = `${contextPath}login?redirect=${encodeURIComponent(window.location.pathname)}`;
                        }, 1500);
                    } else {
                        const error = await response.text();
                        showReviewAlert(error || 'Có lỗi xảy ra khi gửi đánh giá', 'danger');
                    }
                } catch (error) {
                    console.error('Submit error:', error);
                    showReviewAlert('Có lỗi xảy ra: ' + error.message, 'danger');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalBtnText;
                }
            });
        }
        
        // Show review alert
        function showReviewAlert(message, type) {
            const alertContainer = document.getElementById('reviewAlertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
        
        const addToCart = () => {
            // 1. Kiểm tra xem đã chọn đủ size và color chưa
            const isSizeRequired = uniqueSizes.length > 0;
            const isColorRequired = uniqueColors.length > 0;
            
            if ((isSizeRequired && !selectedSize) || (isColorRequired && !selectedColor)) {
                alert('Vui lòng chọn đủ Kích thước và Màu sắc!');
                return;
            }
            
            // 2. Tìm variant ID
            const selectedVariant = productVariants.find(v => 
                (v.sizeName === selectedSize || !isSizeRequired) &&
                (v.colorName === selectedColor || !isColorRequired)
            );
            
            if (!selectedVariant) {
                alert('Không tìm thấy sản phẩm với lựa chọn này!');
                return;
            }
            
            if (selectedVariant.stock <= 0) {
                alert('Sản phẩm đã hết hàng!');
                return;
            }
            
            // 3. Lấy số lượng
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            
            if (quantity > selectedVariant.stock) {
                alert(`Chỉ còn ${selectedVariant.stock} sản phẩm trong kho!`);
                return;
            }
            
            // 4. Gửi AJAX request để thêm vào giỏ (không redirect)
            const contextPath = /*[[@{/}]]*/ '/';
            const formData = new FormData();
            formData.append('productId', productId);
            formData.append('variantId', selectedVariant.id);
            formData.append('quantity', quantity);
            formData.append('_csrf', csrfToken);
            
            fetch(contextPath + 'cart/items', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    
                    // Có thể cập nhật số lượng giỏ hàng trên header nếu có
                } else {
                    alert('Có lỗi xảy ra, vui lòng thử lại!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra, vui lòng thử lại!');
            });
        };
        
        const buyNow = () => {
            // 1. Kiểm tra xem đã chọn đủ size và color chưa
            const isSizeRequired = uniqueSizes.length > 0;
            const isColorRequired = uniqueColors.length > 0;
            
            if ((isSizeRequired && !selectedSize) || (isColorRequired && !selectedColor)) {
                alert('Vui lòng chọn đủ Kích thước và Màu sắc!');
                return;
            }
            
            // 2. Tìm variant ID
            const selectedVariant = productVariants.find(v => 
                (v.sizeName === selectedSize || !isSizeRequired) &&
                (v.colorName === selectedColor || !isColorRequired)
            );
            
            if (!selectedVariant) {
                alert('Không tìm thấy sản phẩm với lựa chọn này!');
                return;
            }
            
            if (selectedVariant.stock <= 0) {
                alert('Sản phẩm đã hết hàng!');
                return;
            }
            
            // 3. Lấy số lượng
            const quantity = parseInt(document.getElementById('quantity').value) || 1;
            
            if (quantity > selectedVariant.stock) {
                alert(`Chỉ còn ${selectedVariant.stock} sản phẩm trong kho!`);
                return;
            }
            
            // 4. Gửi AJAX request và redirect đến checkout
            const contextPath = /*[[@{/}]]*/ '/';
            const formData = new FormData();
            formData.append('productId', productId);
            formData.append('variantId', selectedVariant.id);
            formData.append('quantity', quantity);
            formData.append('buyNow', 'true');
            formData.append('_csrf', csrfToken);
            
            fetch(contextPath + 'cart/items', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.redirect) {
                    // Redirect đến checkout
                    window.location.href = contextPath.replace(/\/$/, '') + data.redirect;
                } else {
                    alert('Có lỗi xảy ra, vui lòng thử lại!');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra, vui lòng thử lại!');
            });
        }
        
        // --- LIGHTBOX FUNCTIONS ---
        function openMediaModal(url, type) {
            if (typeof bootstrap === 'undefined') {
                console.error('Bootstrap is not loaded');
                return;
            }
            
            const modalEl = document.getElementById('mediaModal');
            if (!modalEl) {
                console.error('Modal element not found');
                return;
            }
            
            const modal = new bootstrap.Modal(modalEl);
            const modalImage = document.getElementById('modalImage');
            const modalVideo = document.getElementById('modalVideo');
            
            if (type === 'image') {
                modalImage.src = url;
                modalImage.style.display = 'block';
                modalVideo.style.display = 'none';
                if (modalVideo) modalVideo.pause();
            } else {
                modalVideo.querySelector('source').src = url;
                modalVideo.load();
                modalVideo.style.display = 'block';
                modalImage.style.display = 'none';
            }
            
            modal.show();
        }
        
        // --- DOMContentLoaded ---
        document.addEventListener("DOMContentLoaded", function () {
            // Khởi tạo tải ảnh và biến thể
            loadProductImages();
            loadProductVariants();
            
            // Clean up when modal closes
            const mediaModal = document.getElementById('mediaModal');
            if (mediaModal) {
                mediaModal.addEventListener('hidden.bs.modal', function() {
                    const modalVideo = document.getElementById('modalVideo');
                    if (modalVideo) {
                        modalVideo.pause();
                        const source = modalVideo.querySelector('source');
                        if (source) source.src = '';
                    }
                    const modalImage = document.getElementById('modalImage');
                    if (modalImage) modalImage.src = '';
                });
            }
        });
    </script>
	</th:block>
</body>
</html>