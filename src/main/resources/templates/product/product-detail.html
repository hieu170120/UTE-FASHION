<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/default}">

<head>
    <meta name="product-id" th:content="${product.id}"/>
    <title th:text="${product.productName}">Product Detail</title>
    <th:block layout:fragment="styles">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
        <!-- CORRECTED PATH -->
        <link rel="stylesheet" th:href="@{/static/css/product-detail.css}">
        <link rel="stylesheet" th:href="@{/static/css/chat-popup.css}">
    </th:block>
</head>

<body>

<div class="container" layout:fragment="content">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a th:href="@{/}">TRANG CHỦ</a></li>
            <li class="breadcrumb-item"><a th:href="@{/products}">TẤT CẢ SẢN PHẨM</a></li>
            <li class="breadcrumb-item active" aria-current="page"
                th:text="${product.productName.toUpperCase()}"></li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-md-7">
            <div class="row">
                <div class="col-md-2 order-md-1">
                    <div id="thumbnail-list" class="thumbnail-list loading-state">
                        <div class="spinner-container">
                            <div class="spinner-border spinner-border-sm" role="status">
                                <span class="visually-hidden">Loading images...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-10 order-md-2">
                    <div class="main-image">
                        <div id="main-image-placeholder" class="main-image-placeholder">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading main image...</span>
                            </div>
                        </div>
                        <img id="mainProductImage" style="display: none;" alt="Main image">
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-5 product-details">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <h2 th:text="${product.productName}"></h2>
                </div>
                <button class="wishlist-btn" id="wishlistBtn" onclick="toggleWishlist()" title="Thêm vào yêu thích">
                    <i class="bi bi-heart" id="wishlistIcon"></i>
                </button>
            </div>
            <p class="product-meta">
                Thương hiệu: <span th:text="${product.brandName != null ? product.brandName : 'N/A'}"></span>
                | Mã SP: <span th:text="${product.sku}"></span>
            </p>

            <div class="my-3 product-price d-flex align-items-center">
                <span class="sale-price"
                      th:text="${#numbers.formatDecimal(product.salePrice, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
                <span class="original-price text-decoration-line-through"
                      th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
                <span class="discount-badge"
                      th:if="${product.price > 0 and product.salePrice < product.price}"
                      th:text="'-' + ${#numbers.formatInteger(((product.price - product.salePrice) * 100) / product.price, 0)} + '%'"></span>
            </div>

            <div class="mb-4">
                <label class="option-label">Kích thước</label>
                <div id="size-options-container" class="size-options">
                    <div class="spinner-border spinner-border-sm text-secondary" role="status">
                        <span class="visually-hidden">Loading sizes...</span>
                    </div>
                </div>
                <a href="#" class="size-guide-link">HƯỚNG DẪN CHỌN SIZE</a>
            </div>
            <div class="mb-4">
                <label class="option-label">Màu sắc</label>
                <div id="color-options-container" class="color-options">
                    <div class="spinner-border spinner-border-sm text-secondary" role="status">
                        <span class="visually-hidden">Loading colors...</span>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <label class="option-label">Số lượng</label>
                <div class="quantity-selector">
                    <button type="button" onclick="this.nextElementSibling.stepDown()">-</button>
                    <input type="number" id="quantity" class="form-control text-center" value="1" min="1">
                    <button type="button" onclick="this.previousElementSibling.stepUp()">+</button>
                </div>
                <p id="stock-info" class="mt-2 text-danger" style="display: none;">Hết hàng</p>
            </div>

            <div class="d-grid gap-2 mt-4 action-buttons">
                <button class="btn btn-add-to-cart" type="button" onclick="addToCart()">THÊM VÀO GIỎ</button>
                <button class="btn btn-buy-now" type="button" onclick="buyNow()">MUA NGAY</button>
            </div>

            <div class="mt-4 product-description" th:utext="${product.description}"></div>

            <div class="row my-4">
                <div class="col-12">
                    <div class="shop-card">
                        <div class="shop-info">
                            <img th:src="${shop.logoUrl != null ? shop.logoUrl : 'https://ui-avatars.com/api/?name=' + product.shopName + '&background=random'}"
                                 alt="Shop Logo" class="shop-logo">
                            <div>
                                <div class="shop-label">Cung cấp bởi</div>
                                <div class="shop-name" th:text="${product.shopName}">Tên Shop</div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-dark btn-contact-shop" id="contact-shop-btn"
                                th:attr="data-shop-id=${shop.id}, data-shop-name=${shop.shopName}"
                                sec:authorize="isAuthenticated()">
                            <i class="bi bi-chat-dots-fill"></i> Liên hệ Shop
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Section -->
    <div class="row review-section">
		<div class="col-12">
				<!-- Review Header with Summary -->
				<div class="review-header-compact">
					<h4 class="mb-4">Đánh giá sản phẩm</h4>

					<div class="row align-items-center mb-4">
						<!-- Left: Overall Rating -->
						<div class="col-md-3 text-center">
							<div class="overall-rating">
								<div class="rating-number"
									th:text="${ratingStats.totalReviews > 0 ? #numbers.formatDecimal(ratingStats.averageRating, 1, 1) : '0.0'}">0.0</div>
								<div class="rating-text">/5</div>
								<div class="star-rating-summary">
									<th:block th:with="rating=${ratingStats.averageRating}">
										<i th:each="i : ${#numbers.sequence(1, 5)}"
											th:class="${i <= rating} ? 'bi bi-star-fill' : 'bi bi-star'"></i>
									</th:block>
								</div>
								<div class="review-count"
									th:text="'Dựa trên ' + ${ratingStats.totalReviews} + ' đánh giá'">Dựa
									trên 0 đánh giá</div>
							</div>
						</div>

						<!-- Middle: Rating Breakdown -->
						<div class="col-md-6">
							<div class="rating-breakdown">
								<div class="rating-bar"
									th:each="star : ${#numbers.sequence(5, 1)}">
									<div class="rating-stars">
										<i th:each="i : ${#numbers.sequence(1, star)}"
											class="bi bi-star-fill"></i>
									</div>
									<div class="progress-bar-container">
										<div class="progress">
											<div class="progress-bar bg-warning" role="progressbar"
												th:style="'width: ' + ${ratingStats.getRatingPercentage(star)} + '%'">
											</div>
										</div>
									</div>
									<div class="rating-percent">
										<span
											th:text="${#numbers.formatDecimal(ratingStats.getRatingPercentage(star), 1, 1)} + '%'">0.0%</span>
									</div>
									<div class="rating-count">
										(<span th:text="${ratingStats.getRatingCount(star)}">0</span>)
									</div>
								</div>
							</div>
						</div>

						<!-- Right: Write Review Button -->
						<div class="col-md-3 text-center">
							<button class="btn btn-write-review-compact"
								onclick="toggleReviewForm()">
								<i class="bi bi-pencil-square"></i> Viết đánh giá
							</button>
						</div>
					</div>
				</div>

				<!-- Review Body -->
				<div class="review-body">
					<!-- Review Form -->
					<div id="review-form-container" style="display: none;">
						<h5>
							<i class="bi bi-chat-left-text"></i> Viết đánh giá của bạn
						</h5>
						<div id="reviewAlertContainer"></div>

						<form id="review-form">
							<input type="hidden" id="reviewProductId" name="productId"
								th:value="${product.id}">

							<!-- Rating -->
							<div class="mb-4">
								<label class="form-label">Đánh giá sao <span
									class="text-danger">*</span></label>
								<div class="rating-input-group">
									<input type="radio" id="star5" name="rating" value="5" required />
									<label for="star5" title="Tuyệt vời">★</label> <input
										type="radio" id="star4" name="rating" value="4" /> <label
										for="star4" title="Rất tốt">★</label> <input type="radio"
										id="star3" name="rating" value="3" /> <label for="star3"
										title="Bình thường">★</label> <input type="radio" id="star2"
										name="rating" value="2" /> <label for="star2" title="Kém">★</label>
									<input type="radio" id="star1" name="rating" value="1" /> <label
										for="star1" title="Rất tệ">★</label>
								</div>
							</div>

							<!-- Title -->
							<div class="mb-3">
								<label for="reviewTitle" class="form-label">Tiêu đề đánh
									giá</label> <input type="text" class="form-control" id="reviewTitle"
									name="title" placeholder="Tóm tắt đánh giá của bạn..."
									maxlength="100">
							</div>

							<!-- Comment -->
							<div class="mb-3">
								<label for="reviewComment" class="form-label">Nội dung <span
									class="text-danger">*</span></label>
								<textarea class="form-control" id="reviewComment" name="comment"
									placeholder="Chia sẻ trải nghiệm của bạn về sản phẩm... (tối thiểu 50 ký tự)"
									minlength="50" rows="4" required></textarea>
								<div class="char-counter">
									<span id="charCount">0</span> / 50 ký tự tối thiểu
								</div>
							</div>

							<!-- Image Upload -->
							<div class="mb-3">
								<label class="form-label">Thêm ảnh (Tùy chọn)</label>
								<div class="upload-area" id="imageUploadArea">
									<i class="bi bi-cloud-upload"></i>
									<p class="mb-0">
										<strong>Nhấp để tải ảnh lên</strong>
									</p>
									<small class="text-muted">JPG, PNG, GIF - Tối đa 5 ảnh</small>
									<input type="file" id="imageInput" accept="image/*" multiple>
								</div>
								<div id="imagePreview" class="preview-container"></div>
							</div>

							<!-- Video Upload -->
							<div class="mb-3">
								<label class="form-label">Thêm video (Tùy chọn)</label>
								<div class="upload-area" id="videoUploadArea">
									<i class="bi bi-camera-video"></i>
									<p class="mb-0">
										<strong>Nhấp để tải video lên</strong>
									</p>
									<small class="text-muted">MP4, MOV, AVI - Tối đa 2
										video</small> <input type="file" id="videoInput" accept="video/*"
										multiple>
								</div>
								<div id="videoPreview" class="preview-container"></div>
							</div>

							<!-- Buttons -->
							<div class="d-flex gap-2">
								<button type="submit" class="btn btn-dark" id="submitReviewBtn">
									<i class="bi bi-send"></i> Gửi đánh giá
								</button>
								<button type="button" class="btn btn-secondary"
									onclick="toggleReviewForm()">
									<i class="bi bi-x-circle"></i> Hủy
								</button>
							</div>
						</form>
					</div>

					<!-- Review List -->
					<div class="review-list-compact">
						<div
							class="d-flex justify-content-between align-items-center review-list-header">
							<span>Đánh giá <span th:text="${reviewPage.totalElements}">2</span></span>
							<select class="form-select form-select-sm" style="width: auto;">
								<option selected>Mới nhất</option>
								<option>Cũ nhất</option>
							</select>
						</div>

						<div id="review-list">
							<div class="review-item" th:each="review : ${reviewPage.content}">
								<div class="review-author">
									<img
										th:src="${review.userAvatar != null ? review.userAvatar : 'https://ui-avatars.com/api/?name=' + review.userFullName}"
										alt="Avatar">
									<div>
										<div class="review-author-name"
											th:text="${review.userFullName ?: 'Khách hàng'}"></div>
										<div class="review-meta">
											<span
												th:text="${#temporals.format(review.createdAt, 'dd/MM/yyyy')}"></span>
											<span class="review-verified"
												th:if="${review.isVerifiedPurchase}"> <i
												class="bi bi-patch-check-fill"></i> Đã mua hàng
											</span>
										</div>
									</div>
								</div>

								<div class="star-rating"
									style="color: #d4af37; margin-bottom: 10px;">
									<i th:each="i : ${#numbers.sequence(1, 5)}"
										th:class="${i <= review.rating} ? 'bi bi-star-fill' : 'bi bi-star'"></i>
								</div>

								<div class="review-content">
									<p class="review-title" th:if="${review.title}"
										th:text="${review.title}"></p>
									<p th:text="${review.comment}"></p>

									<!-- Review Images/Videos -->
									<div class="review-images"
										th:if="${review.imageUrls != null and !review.imageUrls.isEmpty()} or ${review.videoUrls != null and !review.videoUrls.isEmpty()}">
										<img th:each="imgUrl : ${review.imageUrls}" th:src="${imgUrl}"
											alt="Review image" style="cursor: pointer;"
											th:data-url="${imgUrl}"
											onclick="openMediaModal(this.dataset.url, 'image')"
											title="Nhấp để phóng to">
										<div th:each="vidUrl : ${review.videoUrls}"
											class="video-thumbnail"
											style="position: relative; cursor: pointer;"
											th:data-url="${vidUrl}"
											onclick="openMediaModal(this.dataset.url, 'video')"
											title="Nhấp để xem video">
											<video th:src="${vidUrl}" style="pointer-events: none;"></video>
											<div
												style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2rem; color: white; text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);">
												<i class="bi bi-play-circle-fill"></i>
											</div>
										</div>
									</div>
								</div>
							</div>

							<div th:if="${reviewPage.totalElements == 0}"
								class="text-center text-muted py-5">
								<i class="bi bi-chat-left-text" style="font-size: 3rem;"></i>
								<p class="mt-3">Chưa có đánh giá nào cho sản phẩm này.</p>
								<p>Hãy là người đầu tiên đánh giá!</p>
							</div>
						</div>
					</div>

					<!-- Pagination -->
					<nav aria-label="Review pagination"
						th:if="${reviewPage.totalPages > 1}" class="mt-4">
						<ul class="pagination justify-content-center">
							<li class="page-item"
								th:classappend="${reviewPage.first} ? 'disabled'"><a
								class="page-link" href="#"
								onclick="loadReviews(0); return false;">&laquo;</a></li>
							<li class="page-item"
								th:each="pageNumber : ${#numbers.sequence(0, reviewPage.totalPages - 1)}"
								th:classappend="${pageNumber == reviewPage.number} ? 'active'">
								<a class="page-link" href="#" th:text="${pageNumber + 1}"
								th:onclick="'loadReviews(' + ${pageNumber} + '); return false;'"></a>
							</li>
							<li class="page-item"
								th:classappend="${reviewPage.last} ? 'disabled'"><a
								class="page-link" href="#"
								th:onclick="'loadReviews(' + ${reviewPage.totalPages - 1} + '); return false;'">&raquo;</a>
							</li>
						</ul>
					</nav>
				</div>
			</div>
	</div>

    <!-- Lightbox Modal for Images/Videos -->
    <div class="modal fade" id="mediaModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content bg-dark">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close btn-close-white"
                            data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-0">
                    <img id="modalImage" src="" class="img-fluid"
                         style="max-height: 80vh; display: none;" alt="Review image">
                    <video id="modalVideo" controls class="w-100"
                           style="max-height: 80vh; display: none;">
                        <source src="" type="video/mp4">
                    </video>
                </div>
            </div>
        </div>
    </div>

</div>

<th:block layout:fragment="scripts">
    <script th:src="@{/static/js/tracking.js}"></script>
    <script th:src="@{/static/js/product-detail.js}"></script>

    <th:block th:if="${currentUserId != null}">
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
        <script th:src="@{/static/js/chat-popup.js}"></script>
    </th:block>

    <script th:inline="javascript">
        const currentUserId = /*[[${currentUserId}]]*/ null;
        /*<![CDATA[*/
        document.addEventListener('DOMContentLoaded', function () {
            console.log('[DEBUG] DOM is loaded. Initializing page scripts...');

            initProductDetail({
                productId: /*[[${product.id}]]*/ null,
                csrfToken: /*[[${_csrf.token}]]*/ '',
                csrfHeader: /*[[${_csrf.headerName}]]*/ '',
                contextPath: /*[[@{/}]]*/ '/',
                imagesApiUrl: /*[[@{/api/products/{productId}/images(productId=${product.id})}]]*/ '',
                variantsApiUrl: /*[[@{/api/products/{productId}/variants(productId=${product.id})}]]*/ ''
            });

            if (currentUserId && typeof initChatPopup === 'function') {
                console.log('[DEBUG] User is logged in. Initializing chat popup...');
                initChatPopup({
                    contextPath: /*[[@{/}]]*/ '/',
                    csrfToken: /*[[${_csrf.token}]]*/ '',
                    csrfHeader: /*[[${_csrf.headerName}]]*/ '',
                    currentUserId: currentUserId,
                    contactButtonId: 'contact-shop-btn'
                });
            } else {
                console.log('[DEBUG] User is not logged in or chat script not loaded. Skipping chat initialization.');
            }
        });
        /*]]>*/
    </script>
</th:block>

</body>
</html>
