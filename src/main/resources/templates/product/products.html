<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">

<head>
    <title>Sản phẩm</title>
    <th:block layout:fragment="styles">
        <!-- All styles are unchanged, copied from original file -->
        <style>
            .product-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; }
            .product-card { text-decoration: none; color: inherit; display: flex; flex-direction: column; }
            .product-card-body { padding: 1rem 0; }
            .product-card-title { font-size: 1rem; font-weight: 500; margin-bottom: 0.5rem; height: 40px; overflow: hidden; }
            .product-price { font-size: 0.9rem; }
            .container h1 { font-size: 22px; font-weight: 700; color: #000; margin: 0; }
            .d-flex.align-items-center.mb-4 { border-bottom: 1px solid #eee; padding-bottom: 10px; }
            #filterForm .btn { background-color: #000 !important; color: #fff !important; border: none !important; }
            #filterForm .btn:hover { background-color: #333 !important; }
            form.d-flex { gap: 8px; }
            form.d-flex .form-control { border-radius: 6px; border: 1px solid #ccc; padding: 6px 10px; font-size: 14px; }
            .sidebar-categories .card { border: none !important; box-shadow: none !important; background: transparent !important; margin-bottom: 20px; }
            .sidebar-categories .card-header { background: transparent !important; border: none !important; padding: 0; }
            .sidebar-categories .card-header h4 { font-size: 15px; font-weight: 700; color: #000; margin-bottom: 8px; }
            .sidebar-categories .list-group { border: none !important; }
            .sidebar-categories .list-group-item { cursor: pointer; border: none !important; background: transparent !important; padding: 4px 0; color: #777; font-size: 14px; transition: color 0.2s ease; text-decoration: none; display: block;}
            .sidebar-categories .list-group-item:hover { color: #000; }
            .sidebar-categories .list-group-item.active { font-weight: 600; color: #000 !important; background: transparent !important; }
            .pagination { display: flex; justify-content: center; list-style: none; padding-left: 0; }
            .pagination .page-item { margin: 0 3px; cursor: pointer; }
            .pagination .page-link { color: #000; border: 1px solid #ddd; padding: 6px 12px; border-radius: 4px; }
            .pagination .active .page-link { background-color: #000; color: #fff; border-color: #000; }
            .product-image-container { position: relative; overflow: hidden; background-color: #f0f0f0; height: 320px; }
            .product-image-container img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.5s ease, transform 0.4s ease; }
            .product-image-container img.loaded { opacity: 1; }
            .product-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: flex; justify-content: center; align-items: center; opacity: 0; transition: all 0.4s ease; transform: translateX(-101%); }
            .view-more-btn { background-color: transparent; color: white; border: 1px solid white; padding: 10px 25px; transform: translateY(20px); opacity: 0; transition: all 0.4s ease; }
            .view-more-btn:hover { background-color: white; color: #333; }
            .product-image-container:hover .product-overlay { transform: translateX(0); opacity: 1; }
            .product-image-container:hover .view-more-btn { transform: translateY(0); opacity: 1; }
            .product-card:hover img { transform: scale(1.05); }
            .product-image-container .sale-badge { position: absolute; top: 10px; right: 10px; background-color: #fff; color: rgb(255, 0, 0); padding: 2px 8px; font-size: 0.8rem; border: 1px solid #ccc; z-index: 5; }
            .loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.7); display: flex; justify-content: center; align-items: center; z-index: 100; min-height: 200px;}
        </style>
    </th:block>
</head>
<body>
<div class="container" layout:fragment="content">
    <!-- Carousel remains unchanged -->
    <div id="header-carousel" class="carousel slide mb-4" data-bs-ride="carousel">
        <div class="carousel-inner">
            <div class="carousel-item active"><img class="w-100" src="https://file.hstatic.net/200000182297/file/vac_fd6422cd073b44208df1c5e9432f4043.jpg" alt="Banner Image"></div>
            <div class="carousel-item"><img class="w-100" src="https://file.hstatic.net/200000182297/file/vac_fd6422cd073b44208df1c5e9432f4043.jpg" alt="Another Banner"></div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#header-carousel" data-bs-slide="prev"><span class="carousel-control-prev-icon" aria-hidden="true"></span><span class="visually-hidden">Previous</span></button>
        <button class="carousel-control-next" type="button" data-bs-target="#header-carousel" data-bs-slide="next"><span class="carousel-control-next-icon" aria-hidden="true"></span><span class="visually-hidden">Next</span></button>
    </div>

    <!-- Header with Title and Sorter/Search -->
    <div class="d-flex justify-content-between align-items-center mb-4 pt-4">
        <h1 id="page-title" th:text="${pageTitle} ?: 'Sản phẩm'"></h1>
        <form id="filterForm" class="d-flex align-items-center" onsubmit="return false;">
            <select id="sort-select" class="form-select me-3" name="sort">
                <option value="newest">Mới nhất</option>
                <option value="bestseller">Bán chạy</option>
                <option value="averageRating">Lượt đánh giá</option>
                <option value="wishList">Yêu thích nhất</option>
                <option value="price-asc">Giá thấp đến cao</option>
                <option value="price-desc">Giá cao đến thấp</option>
            </select>
            <div class="input-group">
                <input id="keyword-input" class="form-control" type="search" name="keyword" placeholder="Tìm kiếm...">
                <button class="btn btn-outline-primary" type="submit">Tìm</button>
            </div>
        </form>
    </div>

    <div class="row">
        <!-- Sidebar with Filters -->
        <div class="col-lg-3 sidebar-categories">
            <div class="card mb-4">
                <div class="card-header"><h4>Danh mục</h4></div>
                <div id="category-list" class="list-group list-group-flush">
                     <div class="d-flex justify-content-center mt-3"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>
                </div>
            </div>
            <div class="card">
                <div class="card-header"><h4>Thương hiệu</h4></div>
                <div id="brand-list" class="list-group list-group-flush">
                    <div class="d-flex justify-content-center mt-3"><div class="spinner-border spinner-border-sm" role="status"><span class="visually-hidden">Loading...</span></div></div>
                </div>
            </div>
        </div>

        <!-- Main content area for products -->
        <div class="col-lg-9">
            <div id="product-list-container" style="position: relative; min-height: 500px;">
                 <div th:fragment="productListFragment" id="product-list-fragment">
                     <div th:if="${productPage.totalElements == 0}" class="text-center"><h3>Không tìm thấy sản phẩm nào.</h3></div>
                     <div class="product-grid" th:if="${productPage.totalElements > 0}">
                         <a th:href="@{/products/{slug}(slug=${product.slug})}" class="product-card" th:each="product : ${productPage.content}" th:attr="data-product-id=${product.productId}">
                             <div class="product-image-container">
                                 <img class="product-main-image" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" th:alt="${product.productName}">
                                 <div class="sale-badge" th:if="${product.salePrice != null and product.salePrice < product.price and product.price > 0}" th:text="|-${#numbers.formatInteger(((product.price - product.salePrice) * 100.0) / product.price, 0)}%|"></div>
                                 <div class="product-overlay"><span class="view-more-btn">XEM THÊM</span></div>
                             </div>
                             <div class="product-card-body">
                                 <h5 class="product-card-title" th:text="${product.productName}"></h5>
                                 <div class="product-price">
                                     <th:block th:if="${product.salePrice != null and product.salePrice < product.price}">
                                         <span class="text-danger fw-bold" th:text="${#numbers.formatDecimal(product.salePrice, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
                                         <span class="text-muted text-decoration-line-through" th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span>
                                     </th:block>
                                     <th:block th:unless="${product.salePrice != null and product.salePrice < product.price}"><span th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + 'đ'"></span></th:block>
                                 </div>
                             </div>
                         </a>
                     </div>

                     <nav aria-label="Page navigation" th:if="${productPage.totalPages > 1}" class="mt-4">
                          <ul class="pagination justify-content-center">
                             <li class="page-item" th:classappend="${productPage.first} ? 'disabled'">
                                 <a class="page-link" href="#" th:attr="data-page=${productPage.number - 1}">&laquo;</a>
                             </li>
                             <li class="page-item" th:each="pageNumber : ${#numbers.sequence(0, productPage.totalPages - 1)}" th:classappend="${pageNumber == productPage.number} ? 'active'">
                                 <a class="page-link" href="#" th:attr="data-page=${pageNumber}" th:text="${pageNumber + 1}"></a>
                             </li>
                             <li class="page-item" th:classappend="${productPage.last} ? 'disabled'">
                                 <a class="page-link" href="#" th:attr="data-page=${productPage.number + 1}">&raquo;</a>
                             </li>
                         </ul>
                     </nav>
                 </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

        // --- STATE MANAGEMENT ---
        const state = {
            categorySlug: /*[[${currentCategory}]]*/ null,
            brandSlug: /*[[${currentBrand}]]*/ null,
            keyword: /*[[${keyword}]]*/ null,
            sort: /*[[${sort}]]*/ 'newest',
            page: /*[[${currentPage}]]*/ 0,
            size: 12,
            allCategories: [], // Cache for categories
        };

        // --- DOM ELEMENTS ---
        const productListContainer = document.getElementById('product-list-container');
        const pageTitleElement = document.getElementById('page-title');
        const mainContentContainer = document.querySelector('.container[layout:fragment="content"]');

        // --- UI & LOADING ---
        const showLoading = () => {
            if (productListContainer.querySelector('.loading-overlay')) return;
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.innerHTML = '<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>';
            productListContainer.appendChild(overlay);
        };

        const hideLoading = () => {
            const overlay = productListContainer.querySelector('.loading-overlay');
            if (overlay) overlay.remove();
        };

        // --- CORE DATA FETCHING ---
        const fetchProducts = () => {
            showLoading();
            const params = new URLSearchParams({
                page: state.page,
                size: state.size,
                sort: state.sort,
                ...(state.categorySlug && { categorySlug: state.categorySlug }),
                ...(state.brandSlug && { brandSlug: state.brandSlug }),
                ...(state.keyword && { keyword: state.keyword }),
            });

            const url = /*[[@{/products/fragments/list}]]*/ '' + `?${params.toString()}`;

            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok.');
                    return response.text();
                })
                .then(html => {
                    productListContainer.innerHTML = html;
                    updateURL();
                    setupImageLazyLoading(); // Re-run for new content
                })
                .catch(error => {
                    console.error("Error fetching products:", error);
                    productListContainer.innerHTML = '<div class="text-center text-danger">Đã xảy ra lỗi khi tải sản phẩm. Vui lòng thử lại.</div>';
                })
                .finally(hideLoading);
        };
        
        // --- URL & HISTORY ---
        const updateURL = () => {
            const params = new URLSearchParams();
            if (state.categorySlug) params.set('categorySlug', state.categorySlug);
            if (state.brandSlug) params.set('brandSlug', state.brandSlug);
            if (state.keyword) params.set('keyword', state.keyword);
            if (state.sort !== 'newest') params.set('sort', state.sort);
            if (state.page > 0) params.set('page', state.page);
            
            // Only push state if the query string is different
            const newQueryString = params.toString();
            const oldQueryString = window.location.search.substring(1);
            if (newQueryString !== oldQueryString) {
                const newUrl = window.location.pathname + (newQueryString ? '?' + newQueryString : '');
                history.pushState(state, '', newUrl);
            }
        };

        // --- EVENT HANDLING (DELEGATION) ---
        const setupEventListeners = () => {
            // Main container for delegated events
            mainContentContainer.addEventListener('click', e => {
                const link = e.target.closest('a');
                if (!link) return;

                // --- Pagination Clicks ---
                const pageLink = link.closest('.pagination a');
                if (pageLink && !pageLink.parentElement.classList.contains('disabled')) {
                    e.preventDefault();
                    const newPage = parseInt(pageLink.dataset.page);
                    if (state.page !== newPage) {
                        state.page = newPage;
                        fetchProducts();
                    }
                    return; // Stop further processing
                }

                // --- Filter Clicks (Category & Brand) ---
                const filterLink = link.closest('#category-list a, #brand-list a');
                if (filterLink) {
                    e.preventDefault();
                    const listId = filterLink.parentElement.id;
                    const slugKey = listId === 'category-list' ? 'categorySlug' : 'brandSlug';
                    const newSlug = filterLink.dataset.slug || null; // Treat empty string as null

                    if (state[slugKey] !== newSlug) {
                        state[slugKey] = newSlug;
                        state.page = 0; // Reset to first page
                        
                        // Update active state visuals
                        filterLink.parentElement.querySelector('.active')?.classList.remove('active');
                        filterLink.classList.add('active');
                        
                        if(slugKey === 'categorySlug') updatePageTitle();

                        fetchProducts();
                    }
                }
            });

            // --- Static Element Listeners ---
            document.getElementById('sort-select').addEventListener('change', e => {
                if (state.sort !== e.target.value) {
                    state.sort = e.target.value;
                    state.page = 0;
                    fetchProducts();
                }
            });

            document.getElementById('filterForm').addEventListener('submit', e => {
                e.preventDefault();
                const newKeyword = document.getElementById('keyword-input').value;
                if (state.keyword !== newKeyword) {
                    state.keyword = newKeyword;
                    state.page = 0;
                    fetchProducts();
                }
            });
        };

        // --- FILTER RENDERING ---
        const updatePageTitle = () => {
             if(state.categorySlug) {
                 const selectedCategory = state.allCategories.find(c => c.slug === state.categorySlug);
                 if(selectedCategory) pageTitleElement.textContent = selectedCategory.categoryName;
             } else {
                 pageTitleElement.textContent = 'Tất cả sản phẩm';
             }
        };

        const fetchAndRenderFilters = () => {
            const fetchData = (url, cacheKey) => {
                return fetch(url).then(res => res.ok ? res.json() : Promise.reject(`Failed: ${url}`));
            };

            Promise.all([
                fetchData(/*[[@{/api/filters/categories}]]*/'', 'cats'),
                fetchData(/*[[@{/api/filters/brands}]]*/'', 'brands')
            ])
            .then(([categories, brands]) => {
                state.allCategories = Array.isArray(categories) ? categories : [];
                renderList('category-list', state.allCategories, 'categorySlug', 'categoryName', 'Tất cả danh mục');
                renderList('brand-list', Array.isArray(brands) ? brands : [], 'brandSlug', 'brandName', 'Tất cả thương hiệu');
                updatePageTitle(); // Ensure title is correct on initial load
            })
            .catch(error => {
                console.error("Error loading filters:", error);
                document.getElementById('category-list').innerHTML = '<div class="list-group-item text-danger">Lỗi tải danh mục.</div>';
                document.getElementById('brand-list').innerHTML = '<div class="list-group-item text-danger">Lỗi tải thương hiệu.</div>';
            });
        };

        const renderList = (elementId, items, slugKey, nameKey, allText) => {
            const container = document.getElementById(elementId);
            if (!container) return;
            
            let html = `<a href="#" class="list-group-item list-group-item-action ${!state[slugKey] ? 'active' : ''}" data-slug="">${allText}</a>`;
            if (Array.isArray(items)) {
                items.forEach(item => {
                    html += `<a href="#" class="list-group-item list-group-item-action ${state[slugKey] === item.slug ? 'active' : ''}" data-slug="${item.slug}">${item[nameKey]}</a>`;
                });
            }
            container.innerHTML = html;
        };

        // --- IMAGE LAZY LOADING ---
        const setupImageLazyLoading = () => {
             let lazyImageObserver;
            let imagesToLoad = new Set();
            let processingTimeout;

            const processImageBatch = () => {
                if (imagesToLoad.size === 0) return;
                const productIds = [...imagesToLoad].map(id => parseInt(id));
                imagesToLoad.clear();

                const headers = { 'Content-Type': 'application/json' };
                if (csrfToken) headers[csrfHeader] = csrfToken;

                fetch(/*[[@{/api/products/images-for-list}]]*/ '', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(productIds)
                })
                .then(res => res.ok ? res.json() : Promise.reject('Failed to fetch images'))
                .then(imagesMap => {
                    productIds.forEach(productId => {
                        const card = productListContainer.querySelector(`.product-card[data-product-id="${productId}"]`);
                        if (!card) return;

                        const imgElement = card.querySelector('.product-main-image');
                        const images = imagesMap[productId];
                        
                        if (imgElement && images && images.length > 0) {
                            imgElement.src = images[0].imageUrl;
                            imgElement.classList.add('loaded');
                            
                            const container = imgElement.closest('.product-image-container');
                            if (container && images.length > 1) {
                                const mainSrc = images[0].imageUrl;
                                const hoverSrc = images[1].imageUrl;
                                new Image().src = hoverSrc; // Preload hover image
                                
                                container.onmouseenter = () => { imgElement.src = hoverSrc; };
                                container.onmouseleave = () => { imgElement.src = mainSrc; };
                            }
                        } else if (imgElement) {
                            imgElement.src = 'https://ih1.redbubble.net/image.4905811472.8675/bg,f8f8f8-flat,750x,075,f-pad,750x1000,f8f8f8.jpg'; // Placeholder
                            imgElement.classList.add('loaded');
                        }
                    });
                })
                .catch(error => console.error('Error fetching product images:', error));
            };

            const lazyImages = document.querySelectorAll('.product-card[data-product-id]');
            if (lazyImages.length === 0) return;

            if(lazyImageObserver) lazyImageObserver.disconnect(); // Disconnect old observer

            lazyImageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const card = entry.target;
                        const productId = card.dataset.productId;
                        imagesToLoad.add(productId);
                        observer.unobserve(card);

                        clearTimeout(processingTimeout);
                        processingTimeout = setTimeout(processImageBatch, 50); // Debounce
                    }
                });
            });

            lazyImages.forEach(img => lazyImageObserver.observe(img));
        };

        // --- INITIALIZATION ---
        const init = () => {
            // Set initial form values from state
            document.getElementById('sort-select').value = state.sort;
            document.getElementById('keyword-input').value = state.keyword || '';

            setupEventListeners();
            fetchAndRenderFilters();
            setupImageLazyLoading();
        };

        init();
    });
    </script>
</th:block>
</body>
</html>