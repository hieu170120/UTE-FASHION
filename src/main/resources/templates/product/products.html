<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="~{layout/default}">

<head>
    <title>Sản phẩm</title>
    <th:block layout:fragment="styles">
        <style>
            .product-grid {
                display: grid;
                grid-template-columns: repeat(4, 1fr); /* 4 products per row */
                gap: 1.5rem;
            }
            .product-card { text-decoration: none; color: inherit; display: flex; flex-direction: column; }
            .product-card-body { padding: 1rem 0; }
            .product-card-title { font-size: 1rem; font-weight: 500; margin-bottom: 0.5rem; height: 40px; overflow: hidden; }
            .product-price { font-size: 0.9rem; }
            .container h1 { font-size: 22px; font-weight: 700; color: #000; margin: 0; }
            .d-flex.align-items-center.mb-4 { border-bottom: 1px solid #eee; padding-bottom: 10px; }
            form.d-flex { gap: 8px; }
            form.d-flex .form-control { border-radius: 6px; border: 1px solid #ccc; padding: 6px 10px; font-size: 14px; transition: border-color 0.2s ease; }
            form.d-flex .form-control:focus { outline: none; border-color: #000; box-shadow: none; }
            form.d-flex .btn-outline-primary { color: #000; border-color: #000; border-radius: 6px; font-size: 14px; transition: all 0.2s ease; }
            form.d-flex .btn-outline-primary:hover { background-color: #000; color: #fff; }
            .sidebar-categories .card { border: none !important; box-shadow: none !important; background: transparent !important; margin-bottom: 20px; }
            .sidebar-categories .card-header { background: transparent !important; border: none !important; padding: 0; }
            .sidebar-categories .card-header h4 { font-size: 15px; font-weight: 700; color: #000; margin-bottom: 8px; }
            .sidebar-categories .list-group { border: none !important; }
            .sidebar-categories .list-group-item { border: none !important; background: transparent !important; padding: 4px 0; color: #777; font-size: 14px; transition: color 0.2s ease; }
            .sidebar-categories .list-group-item:hover { color: #000; }
            .sidebar-categories .list-group-item.active { font-weight: 600; color: #000 !important; background: transparent !important; }
            .pagination { display: flex; justify-content: center; list-style: none; padding-left: 0; }
            .pagination .page-item { margin: 0 3px; }
            .pagination .page-link { color: #000; background-color: #fff; border: 1px solid #ddd; padding: 6px 12px; border-radius: 4px; transition: all 0.2s ease; }
            .pagination .page-link:hover { background-color: #f0f0f0; }
            .pagination .active .page-link { background-color: #000; color: #fff; border-color: #000; }
            .pagination .disabled .page-link { color: #ccc; pointer-events: none; background-color: #fff; border-color: #eee; }

            /* MODIFIED: Image styles for AJAX loading */
            .product-image-container {
                position: relative;
                overflow: hidden;
                background-color: #f0f0f0; /* Placeholder background */
                height: 320px;
            }
            .product-image-container img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
                transition: transform 0.4s ease, opacity 0.3s ease;
                opacity: 0; /* Hidden until loaded */
            }
            .product-image-container img.loaded { opacity: 1; }
            .product-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: flex; justify-content: center; align-items: center; opacity: 1; transform: translateX(-101%); transition: transform 0.4s ease; }
            .view-more-btn { background-color: transparent; color: white; border: 1px solid white; padding: 10px 25px; text-decoration: none; font-size: 0.9rem; font-weight: 500; border-radius: 2px; transform: translateY(20px); opacity: 0; transition: all 0.4s ease; }
            .view-more-btn:hover { background-color: white; color: #333; }
            .product-card:hover .product-overlay { transform: translateX(0); }
            .product-card:hover .view-more-btn { transform: translateY(0); opacity: 1; }
            .product-card:hover img { transform: scale(1.05); }
            .product-image-container .sale-badge { position: absolute; top: 10px; right: 10px; background-color: #fff; color: rgb(255, 0, 0); padding: 2px 8px; font-size: 0.8rem; border: 1px solid #ccc; z-index: 5; }
        </style>
    </th:block>
</head>

<body>
    <div class="container" layout:fragment="content">
        <!-- Carousel (can be lazy loaded too) -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 th:text="${pageTitle} ?: 'Sản phẩm'"></h1>
            <div class="d-flex align-items-center">
                <form id="sortForm" class="d-flex me-3" th:action="@{/products}" method="get">
                     <select class="form-select" name="sort" onchange="this.form.submit()">
                        <option value="newest" th:selected="${sort == 'newest'}">Sản phẩm mới</option>
                        <option value="bestseller" th:selected="${sort == 'bestseller'}">Bán chạy</option>
                        <option value="toprated" th:selected="${sort == 'toprated'}">Đánh giá cao</option>
                     </select>
                    <input type="hidden" name="keyword" th:value="${keyword}" />
                </form>
                <form class="d-flex" th:action="@{/products}" method="get">
                    <input class="form-control me-2" type="search" name="keyword" placeholder="Tìm kiếm..." aria-label="Search" th:value="${keyword}">
                    <button class="btn btn-outline-primary" type="submit">Tìm</button>
                </form>
            </div>
        </div>

        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3 sidebar-categories">...</div>

            <!-- Product listing -->
            <div class="col-lg-9">
                <div th:if="${productPage.totalElements == 0}" class="text-center"><h3>Không tìm thấy.</h3></div>
                <div class="product-grid" th:if="${productPage.totalElements > 0}">
                    <!-- REWRITTEN Product Card for AJAX Loading -->
                    <a th:href="@{/products/{slug}(slug=${product.slug})}" class="product-card"
                       th:each="product : ${productPage.content}" th:attr="data-product-id=${product.id}">
                        <div class="product-image-container">
                            <!-- Image tag is now a placeholder. JS will populate it. -->
                            <img class="product-main-image" th:alt="${product.productName}">
                            <div class="sale-badge" 
                                 th:if="${product.salePrice != null and product.salePrice < product.price and product.price > 0}"
                                 th:text="|-${#numbers.formatInteger(((product.price - product.salePrice) * 100.0) / product.price, 0)}%|"></div>
                            <div class="product-overlay">
                                <span class="view-more-btn">XEM THÊM</span>
                            </div>
                        </div>
                        <div class="product-card-body">
                            <h5 class="product-card-title" th:text="${product.productName}"></h5>
                            <div class="product-price">...</div>
                        </div>
                    </a>
                </div>
                <nav aria-label="Page navigation" th:if="${productPage.totalPages > 1}" class="mt-4">...</nav>
            </div>
        </div>
    </div>

    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function () {
            // --- 1. SETUP LAZY LOADING OBSERVER ---
            const lazyImageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        const mainSrc = img.dataset.mainSrc;
                        if (!mainSrc) { observer.unobserve(img); return; }
                        
                        img.src = mainSrc;
                        const container = img.closest('.product-image-container');

                        img.onload = () => {
                            img.classList.add('loaded');
                            if (container) {
                                const hoverSrc = container.dataset.hoverSrc;
                                if (hoverSrc) {
                                    const hoverImage = new Image();
                                    hoverImage.src = hoverSrc;
                                    container.addEventListener('mouseenter', () => { img.src = hoverSrc; });
                                    container.addEventListener('mouseleave', () => { img.src = mainSrc; });
                                }
                            }
                        };
                        observer.unobserve(img);
                    }
                });
            }, { rootMargin: "0px 0px 200px 0px" });

            // --- 2. FETCH IMAGES AND POPULATE CARDS ---
            const productCards = Array.from(document.querySelectorAll('.product-card[data-product-id]'));
            const productIds = productCards.map(card => card.dataset.productId);

            if (productIds.length > 0) {
                const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');
                
                fetch('/api/products/images-for-list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(csrfToken && { [csrfHeader]: csrfToken })
                    },
                    body: JSON.stringify(productIds)
                })
                .then(response => response.ok ? response.json() : Promise.reject('Failed to fetch images'))
                .then(imagesMap => {
                    productCards.forEach(card => {
                        const productId = card.dataset.productId;
                        const images = imagesMap[productId];
                        const imgElement = card.querySelector('.product-main-image');
                        
                        if (imgElement && images && images.length > 0) {
                            imgElement.dataset.mainSrc = images[0].imageUrl;
                            imgElement.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; // Placeholder

                            const container = imgElement.closest('.product-image-container');
                            if (container && images.length > 1) {
                                container.dataset.hoverSrc = images[1].imageUrl;
                            }
                            
                            // Once data attributes are set, start observing for lazy load
                            lazyImageObserver.observe(imgElement);
                        } else if (imgElement) {
                            // Handle products with no images
                            imgElement.src = 'https://ih1.redbubble.net/image.4905811472.8675/bg,f8f8f8-flat,750x,075,f-pad,750x1000,f8f8f8.jpg';
                            imgElement.classList.add('loaded');
                        }
                    });
                })
                .catch(error => console.error('Error fetching product images:', error));
            }
        });
        </script>
    </th:block>
</body>
</html>