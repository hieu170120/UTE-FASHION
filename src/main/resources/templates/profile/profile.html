<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title>Th√¥ng tin c√° nh√¢n - UTE Fashion</title>
    <th:block layout:fragment="styles">
        <style>
            .profile-card {
                border-radius: 15px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.1);
                border: none;
            }
            
            .profile-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 15px 15px 0 0;
                padding: 2rem;
                text-align: center;
            }
            
            .profile-avatar {
                width: 120px;
                height: 120px;
                border-radius: 50%;
                border: 4px solid white;
                object-fit: cover;
                margin-bottom: 1rem;
            }
            
            .profile-info {
                padding: 2rem;
            }
            
            .info-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 0;
                border-bottom: 1px solid #f0f0f0;
            }
            
            .info-item:last-child {
                border-bottom: none;
            }
            
            .info-label {
                font-weight: 600;
                color: #333;
                min-width: 120px;
            }
            
            .info-value {
                color: #666;
                flex: 1;
                text-align: right;
            }
            
            .form-section {
                background: #f8f9fa;
                border-radius: 10px;
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }
            
            .section-title {
                color: #333;
                font-weight: 600;
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 2px solid #007bff;
            }
            
            .btn-save {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                border: none;
                border-radius: 25px;
                padding: 0.75rem 2rem;
                font-weight: 600;
                transition: all 0.3s ease;
            }
            
            .btn-save:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            }
            
            .alert {
                border-radius: 10px;
                border: none;
            }
            
            .form-control {
                border-radius: 10px;
                border: 2px solid #e9ecef;
                padding: 0.75rem 1rem;
                transition: all 0.3s ease;
            }
            
            .form-control:focus {
                border-color: #667eea;
                box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            }
            
            .form-label {
                font-weight: 600;
                color: #333;
                margin-bottom: 0.5rem;
            }
            
            .status-badge {
                padding: 0.25rem 0.75rem;
                border-radius: 15px;
                font-size: 0.8rem;
                font-weight: 600;
            }
            
            .status-active {
                background-color: #d4edda;
                color: #155724;
            }
            
            .status-inactive {
                background-color: #f8d7da;
                color: #721c24;
            }
            
            .status-verified {
                background-color: #d1ecf1;
                color: #0c5460;
            }
            
            .status-unverified {
                background-color: #fff3cd;
                color: #856404;
            }
        </style>
    </th:block>
</head>
<body>
    <div layout:fragment="content">
        <div class="container my-5">
            <!-- Alert Messages -->
            <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                <span th:text="${success}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            
            <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                <span th:text="${error}"></span>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            
            <div class="row">
                <!-- Profile Information Card -->
                <div class="col-lg-4 mb-4">
                    <div class="card profile-card">
                        <div class="profile-header">
                            <!-- Avatar Display with Debug Logging -->
                            <script th:inline="javascript">
                                console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
                                console.log("üîµ [Profile] Avatar Debug Info");
                                const avatarUrl = [[${profile.avatarUrl}]];
                                console.log("   avatarUrl from DB: " + avatarUrl);
                                console.log("   Type: " + typeof avatarUrl);
                                console.log("   Is null: " + (avatarUrl === null));
                                console.log("   Is empty: " + (avatarUrl === '' || avatarUrl === 'null'));
                                console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
                            </script>
                            
                            <!-- Show actual avatar if available, otherwise placeholder -->
                            <img th:if="${profile.avatarUrl != null && profile.avatarUrl != '' && profile.avatarUrl != 'null'}"
                                 th:src="@{${profile.avatarUrl}}" 
                                 th:alt="${profile.fullName}" 
                                 class="profile-avatar"
                                 onerror="console.error('‚ùå [Profile] Failed to load avatar from: ' + this.src);"
                                 onload="console.log('‚úÖ [Profile] Avatar loaded from: ' + this.src);">
                            
                            <!-- Show placeholder if no avatar -->
                            <img th:unless="${profile.avatarUrl != null && profile.avatarUrl != '' && profile.avatarUrl != 'null'}"
                                 th:src="@{'https://via.placeholder.com/120x120/667eea/ffffff?text=' + ${profile.username}}" 
                                 th:alt="${profile.fullName}" 
                                 class="profile-avatar">
                            
                            <h4 th:text="${profile.fullName}"></h4>
                            <p class="mb-0" th:text="'@' + ${profile.username}"></p>
                        </div>
                        <div class="profile-info">
                            <div class="info-item">
                                <span class="info-label">T√™n ƒëƒÉng nh·∫≠p:</span>
                                <span class="info-value" th:text="${profile.username}"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Email:</span>
                                <span class="info-value" th:text="${profile.email}"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">S·ªë ƒëi·ªán tho·∫°i:</span>
                                <span class="info-value" th:text="${profile.phoneNumber ?: 'Ch∆∞a c·∫≠p nh·∫≠t'}"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Tr·∫°ng th√°i:</span>
                                <span class="info-value">
                                    <span th:class="'status-badge ' + (${profile.isActive} ? 'status-active' : 'status-inactive')"
                                          th:text="${profile.isActive ? 'Ho·∫°t ƒë·ªông' : 'B·ªã kh√≥a'}"></span>
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">X√°c th·ª±c email:</span>
                                <span class="info-value">
                                    <span th:class="'status-badge ' + (${profile.isEmailVerified} ? 'status-verified' : 'status-unverified')"
                                          th:text="${profile.isEmailVerified ? 'ƒê√£ x√°c th·ª±c' : 'Ch∆∞a x√°c th·ª±c'}"></span>
                                </span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">ƒêƒÉng nh·∫≠p cu·ªëi:</span>
                                <span class="info-value" th:text="${#temporals.format(profile.lastLogin, 'dd/MM/yyyy HH:mm')}"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Ng√†y t·∫°o:</span>
                                <span class="info-value" th:text="${#temporals.format(profile.createdAt, 'dd/MM/yyyy')}"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Update Forms -->
                <div class="col-lg-8">
                    <!-- Update Profile Information -->
                    <div class="card profile-card">
                        <div class="card-body">
                            <h5 class="section-title">
                                <i class="fas fa-user-edit me-2"></i>C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n
                            </h5>
                            
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>H∆∞·ªõng d·∫´n:</strong> B·∫°n c√≥ th·ªÉ s·ª≠a t·ª´ng tr∆∞·ªùng th√¥ng tin ƒë·ªôc l·∫≠p. ƒê·ªÉ tr·ªëng c√°c tr∆∞·ªùng kh√¥ng mu·ªën thay ƒë·ªïi. 
                                ƒê·ªÉ tr·ªëng s·ªë ƒëi·ªán tho·∫°i s·∫Ω x√≥a th√¥ng tin ƒë√≥. Avatar s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông c·∫≠p nh·∫≠t sau khi upload th√†nh c√¥ng.
                            </div>
                            
                            <form th:action="@{/profile/update}" method="post" th:object="${updateProfileDTO}">
                                <div class="form-section">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="fullName" class="form-label">H·ªç v√† t√™n</label>
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="fullName" 
                                                   th:field="*{fullName}"
                                                   th:value="${profile.fullName}"
                                                   th:class="${#fields.hasErrors('fullName')} ? 'form-control is-invalid' : 'form-control'"
                                                   placeholder="Nh·∫≠p h·ªç v√† t√™n m·ªõi (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng thay ƒë·ªïi)">
                                            <div th:if="${#fields.hasErrors('fullName')}" class="invalid-feedback">
                                                <span th:errors="*{fullName}"></span>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="email" class="form-label">Email</label>
                                            <input type="email" 
                                                   class="form-control" 
                                                   id="email" 
                                                   th:field="*{email}"
                                                   th:value="${profile.email}"
                                                   th:class="${#fields.hasErrors('email')} ? 'form-control is-invalid' : 'form-control'"
                                                   placeholder="Nh·∫≠p email m·ªõi (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng thay ƒë·ªïi)">
                                            <div th:if="${#fields.hasErrors('email')}" class="invalid-feedback">
                                                <span th:errors="*{email}"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="phoneNumber" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                                            <input type="tel" 
                                                   class="form-control" 
                                                   id="phoneNumber" 
                                                   th:field="*{phoneNumber}"
                                                   th:value="${profile.phoneNumber}"
                                                   th:class="${#fields.hasErrors('phoneNumber')} ? 'form-control is-invalid' : 'form-control'"
                                                   placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i m·ªõi (ƒë·ªÉ tr·ªëng ƒë·ªÉ x√≥a)">
                                            <div th:if="${#fields.hasErrors('phoneNumber')}" class="invalid-feedback">
                                                <span th:errors="*{phoneNumber}"></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="text-end">
                                        <button type="submit" class="btn btn-primary btn-save">
                                            <i class="fas fa-save me-2"></i>C·∫≠p nh·∫≠t th√¥ng tin
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Upload Avatar Section - SEPARATE FORM -->
                    <div class="card profile-card mt-4">
                        <div class="card-body">
                            <h5 class="section-title">
                                <i class="fas fa-image me-2"></i>C·∫≠p nh·∫≠t Avatar
                            </h5>
                            
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>H∆∞·ªõng d·∫´n:</strong> Ch·ªçn ·∫£nh t·ª´ m√°y t√≠nh, preview s·∫Ω hi·ªÉn th·ªã t·ª± ƒë·ªông v√† upload s·∫Ω ti·∫øn h√†nh.
                            </div>
                            
                            <form th:action="@{/profile/upload-avatar}" method="post" enctype="multipart/form-data" id="avatarUploadForm">
                                <div class="form-section">
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">Ch·ªçn ·∫£nh avatar</label>
                                            <div class="card border-2 border-dashed" style="border-color: #dee2e6 !important;">
                                                <div class="card-body text-center">
                                                    <div class="mb-3">
                                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                                        <h5 class="text-muted">Ch·ªçn ·∫£nh avatar</h5>
                                                        <p class="text-muted mb-3">
                                                            H·ªó tr·ª£: JPG, JPEG, PNG, GIF, WEBP<br>
                                                            K√≠ch th∆∞·ªõc t·ªëi ƒëa: 5MB
                                                        </p>
                                                        <input type="file" 
                                                               class="form-control" 
                                                               id="avatarFile" 
                                                               name="avatarFile" 
                                                               accept="image/*"
                                                               onchange="previewImage(this)">
                                                    </div>
                                                    <div id="imagePreview" class="mb-3" style="display: none;">
                                                        <img id="previewImg" src="" alt="Preview" class="img-thumbnail" style="max-width: 200px; max-height: 200px;">
                                                    </div>
                                                    <button type="submit" class="btn btn-success" id="uploadBtn" disabled>
                                                        <i class="fas fa-upload me-2"></i>Upload Avatar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Change Password -->
                    <h5 class="section-title">
                        <i class="fas fa-key me-2"></i>ƒê·ªïi m·∫≠t kh·∫©u
                    </h5>
                    
                    <form th:action="@{/profile/change-password}" method="post" th:object="${changePasswordDTO}">
                        <div class="form-section">
                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="currentPassword" class="form-label">M·∫≠t kh·∫©u hi·ªán t·∫°i *</label>
                                    <input type="password" 
                                           class="form-control" 
                                           id="currentPassword" 
                                           th:field="*{currentPassword}"
                                           th:class="${#fields.hasErrors('currentPassword')} ? 'form-control is-invalid' : 'form-control'"
                                           placeholder="Nh·∫≠p m·∫≠t kh·∫©u hi·ªán t·∫°i">
                                    <div th:if="${#fields.hasErrors('currentPassword')}" class="invalid-feedback">
                                        <span th:errors="*{currentPassword}"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="newPassword" class="form-label">M·∫≠t kh·∫©u m·ªõi *</label>
                                    <input type="password" 
                                           class="form-control" 
                                           id="newPassword" 
                                           th:field="*{newPassword}"
                                           th:class="${#fields.hasErrors('newPassword')} ? 'form-control is-invalid' : 'form-control'"
                                           placeholder="Nh·∫≠p m·∫≠t kh·∫©u m·ªõi">
                                    <div th:if="${#fields.hasErrors('newPassword')}" class="invalid-feedback">
                                        <span th:errors="*{newPassword}"></span>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="confirmPassword" class="form-label">X√°c nh·∫≠n m·∫≠t kh·∫©u *</label>
                                    <input type="password" 
                                           class="form-control" 
                                           id="confirmPassword" 
                                           th:field="*{confirmPassword}"
                                           th:class="${#fields.hasErrors('confirmPassword')} ? 'form-control is-invalid' : 'form-control'"
                                           placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u m·ªõi">
                                    <div th:if="${#fields.hasErrors('confirmPassword')}" class="invalid-feedback">
                                        <span th:errors="*{confirmPassword}"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="text-end">
                                <button type="submit" class="btn btn-warning btn-save">
                                    <i class="fas fa-key me-2"></i>ƒê·ªïi m·∫≠t kh·∫©u
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Notice -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>L∆∞u √Ω:</strong> T√™n ƒëƒÉng nh·∫≠p kh√¥ng th·ªÉ thay ƒë·ªïi. N·∫øu b·∫°n mu·ªën thay ƒë·ªïi t√™n ƒëƒÉng nh·∫≠p, vui l√≤ng li√™n h·ªá v·ªõi qu·∫£n tr·ªã vi√™n.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <th:block layout:fragment="scripts">
        <script>
            // Auto-hide alerts after 5 seconds
            setTimeout(function() {
                const alerts = document.querySelectorAll('.alert');
                alerts.forEach(function(alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                });
            }, 5000);
            
            // Form validation
            document.addEventListener('DOMContentLoaded', function() {
                // Password confirmation validation
                const newPassword = document.getElementById('newPassword');
                const confirmPassword = document.getElementById('confirmPassword');
                
                function validatePasswordMatch() {
                    if (newPassword.value !== confirmPassword.value) {
                        confirmPassword.setCustomValidity('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp');
                    } else {
                        confirmPassword.setCustomValidity('');
                    }
                }
                
                newPassword.addEventListener('input', validatePasswordMatch);
                confirmPassword.addEventListener('input', validatePasswordMatch);
            });
            
            // Image preview function
            function previewImage(input) {
                const file = input.files[0];
                const preview = document.getElementById('imagePreview');
                const previewImg = document.getElementById('previewImg');
                const uploadBtn = document.getElementById('uploadBtn');
                
                if (file) {
                    console.log("üìç [Profile] File selected: " + file.name);
                    
                    // Validate file size (5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        console.error("‚ùå [Profile] File too large: " + file.size + " bytes");
                        alert('File qu√° l·ªõn! K√≠ch th∆∞·ªõc t·ªëi ƒëa l√† 5MB.');
                        input.value = '';
                        preview.style.display = 'none';
                        uploadBtn.disabled = true;
                        return;
                    }
                    
                    // Validate file type
                    const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
                    if (!allowedTypes.includes(file.type)) {
                        console.error("‚ùå [Profile] File type not allowed: " + file.type);
                        alert('ƒê·ªãnh d·∫°ng file kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£! Ch·ªâ ch·∫•p nh·∫≠n: JPG, JPEG, PNG, GIF, WEBP.');
                        input.value = '';
                        preview.style.display = 'none';
                        uploadBtn.disabled = true;
                        return;
                    }
                    
                    console.log("‚úÖ [Profile] File validation passed");
                    
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImg.src = e.target.result;
                        preview.style.display = 'block';
                        uploadBtn.disabled = false;
                        
                        console.log("üìç [Profile] Preview displayed");
                        console.log("üìç [Profile] Auto-submitting upload form in 1 second...");
                        
                        // Auto-submit after 1 second to show preview
                        setTimeout(function() {
                            console.log("üîµ [Profile] Auto-submitting form...");
                            document.getElementById('avatarUploadForm').submit();
                        }, 1000);
                    };
                    reader.readAsDataURL(file);
                } else {
                    console.log("üìç [Profile] No file selected");
                    preview.style.display = 'none';
                    uploadBtn.disabled = true;
                }
            }
            
            // Upload form submission
            document.getElementById('avatarUploadForm').addEventListener('submit', function(e) {
                const fileInput = document.getElementById('avatarFile');
                const uploadBtn = document.getElementById('uploadBtn');
                
                console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
                console.log("üîµ [Profile] Avatar upload form - SUBMIT");
                console.log("   Timestamp: " + new Date().toISOString());
                
                if (!fileInput.files[0]) {
                    console.log("‚ùå [Profile] No file selected!");
                    e.preventDefault();
                    alert('Vui l√≤ng ch·ªçn file ·∫£nh!');
                    return;
                }
                
                const file = fileInput.files[0];
                console.log("üìç [Profile] Submitting file:");
                console.log("   Name: " + file.name);
                console.log("   Size: " + file.size + " bytes");
                console.log("   Type: " + file.type);
                
                console.log("üìç [Profile] Form details:");
                console.log("   Action: " + this.action);
                console.log("   Method: " + this.method);
                console.log("   Enctype: " + this.enctype);
                
                // Show loading state
                uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ƒêang upload...';
                uploadBtn.disabled = true;
                
                console.log("üìç [Profile] Form submitted to server...");
                console.log("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
                
                // Allow form to submit normally
            });
            
            // Log when page reloads after upload
            window.addEventListener('beforeunload', function() {
                console.log("üîÑ [Profile] Page reloading (probably redirect from upload)");
            });
        </script>
    </th:block>
</body>
</html>
