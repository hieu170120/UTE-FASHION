<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title>Qu·∫£n l√Ω C·ª≠a h√†ng</title>
    <th:block layout:fragment="styles">
        <style>
            body {
                background-color: #f8f9fa; /* Light gray background */
            }
            .card {
                border: 1px solid #e9ecef;
            }
            .card-header {
                background-color: #fff;
                border-bottom: 1px solid #e9ecef;
            }
            .table {
                color: #212529; /* Standard text color */
            }
            .table thead {
                background-color: #f8f9fa;
            }
            .table-hover tbody tr:hover {
                background-color: #f1f3f5;
            }
            .btn-outline-success {
                color: #198754;
                border-color: #198754;
            }
            .btn-outline-success:hover {
                background-color: #198754;
                color: #fff;
            }
            .btn-outline-danger {
                color: #dc3545;
                border-color: #dc3545;
            }
            .btn-outline-danger:hover {
                background-color: #dc3545;
                color: #fff;
            }
            .btn-outline-info {
                color: #0dcaf0;
                border-color: #0dcaf0;
            }
            .btn-outline-info:hover {
                background-color: #0dcaf0;
                color: #fff;
            }
            .badge.bg-success {
                background-color: #198754 !important;
            }
            .badge.bg-warning {
                background-color: #ffc107 !important;
            }
            .commission-badge {
                font-size: 12px;
                padding: 4px 8px;
                background-color: #e7f3ff;
                color: #0066cc;
                border-radius: 4px;
                font-weight: bold;
            }
        </style>
    </th:block>
</head>
<body>

<div layout:fragment="content">
    <div class="container my-5">

        <!-- Page Heading -->
        <div class="text-center mb-5">
            <h2 class="fw-bold">Qu·∫£n l√Ω C·ª≠a h√†ng</h2>
            <p class="text-muted">Duy·ªát v√† qu·∫£n l√Ω c√°c c·ª≠a h√†ng ƒëƒÉng k√Ω tr√™n h·ªá th·ªëng.</p>
        </div>

        <!-- Success/Error Messages -->
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div th:if="${successMessage}" class="alert alert-success" role="alert" th:text="${successMessage}"></div>
                <div th:if="${errorMessage}" class="alert alert-danger" role="alert" th:text="${errorMessage}"></div>
            </div>
        </div>

        <!-- Shops Table -->
        <div class="row justify-content-center">
            <div class="col-lg-12">
                <div class="card shadow-sm">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-dark">T·∫•t c·∫£ C·ª≠a h√†ng</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>T√™n Shop</th>
                                    <th>Logo</th>
                                    <th>Ch·ªß s·ªü h·ªØu</th>
                                    <th>Tr·∫°ng th√°i</th>
                                    <th class="text-center">Chi·∫øt kh·∫•u (%)</th>
                                    <th>Ng√†y t·∫°o</th>
                                    <th class="text-center">H√†nh ƒë·ªông</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="shop : ${shops}">
                                    <td class="fw-bold" th:text="${shop.id}"></td>
                                    <td th:text="${shop.shopName}"></td>
                                    <td><img th:src="${shop.logoUrl != null ? shop.logoUrl : 'https://via.placeholder.com/80x40.png?text=Logo'}" alt="Logo" class="img-fluid rounded" style="max-width: 80px;"/></td>
                                    <td th:text="${shop.vendor.username}"></td>
                                    <td>
                                        <span th:if="${shop.active}" class="badge bg-success">ƒê√£ duy·ªát</span>
                                        <span th:unless="${shop.active}" class="badge bg-warning text-dark">Ch·ªù duy·ªát</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="commission-badge" th:text="${shop.commissionPercentage != null ? shop.commissionPercentage : '0.00'} + '%'"></span>
                                    </td>
                                    <td th:text="${#temporals.format(shop.createdAt, 'dd/MM/yyyy')}"></td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-outline-info" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#commissionModal"
                                                th:data-shop-id="${shop.id}"
                                                th:data-shop-name="${shop.shopName}"
                                                th:data-commission="${shop.commissionPercentage != null ? shop.commissionPercentage : '0.00'}"
                                                onclick="openCommissionModal(this)">
                                            Chi·∫øt kh·∫•u
                                        </button>
                                        <form th:action="@{/admin/shops/approve/{id}(id=${shop.id})}" method="post" class="d-inline-block m-1">
                                            <button type="submit" class="btn btn-sm btn-outline-success" th:disabled="${shop.active}">Duy·ªát</button>
                                        </form>
                                        <form th:action="@{/admin/shops/reject/{id}(id=${shop.id})}" method="post" class="d-inline-block m-1">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" th:disabled="not ${shop.active}">Kh√≥a</button>
                                        </form>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal C·∫≠p nh·∫≠t Chi·∫øt kh·∫•u -->
    <div class="modal fade" id="commissionModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">C·∫≠p nh·∫≠t Chi·∫øt kh·∫•u</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="commissionForm">
                        <div class="mb-3">
                            <label class="form-label">T√™n Shop</label>
                            <input type="text" class="form-control" id="shopNameDisplay" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="commissionInput" class="form-label">Chi·∫øt kh·∫•u (%) <span class="text-danger">*</span></label>
                            <input type="number" step="0.01" min="0" max="100" class="form-control" id="commissionInput" placeholder="Nh·∫≠p % chi·∫øt kh·∫•u (0-100)" required>
                            <small class="form-text text-muted">Chi·∫øt kh·∫•u ph·∫£i t·ª´ 0% ƒë·∫øn 100%</small>
                        </div>
                        <input type="hidden" id="shopIdInput">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" onclick="saveCommission()">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script>
        function openCommissionModal(button) {
            console.log("üîµ [Frontend] openCommissionModal - START");
            const shopId = button.getAttribute('data-shop-id');
            const shopName = button.getAttribute('data-shop-name');
            const commission = button.getAttribute('data-commission');
            
            console.log("üìç [Frontend] Modal data extracted:");
            console.log("   shopId: " + shopId);
            console.log("   shopName: " + shopName);
            console.log("   current commission: " + commission);
            
            document.getElementById('shopIdInput').value = shopId;
            document.getElementById('shopNameDisplay').value = shopName;
            document.getElementById('commissionInput').value = commission;
            
            console.log("‚úÖ [Frontend] Modal fields populated");
        }
        
        function saveCommission() {
            console.log("üîµ [Frontend] saveCommission - START");
            console.log("‚è∞ Timestamp: " + new Date().toISOString());
            
            const shopId = document.getElementById('shopIdInput').value;
            const commission = document.getElementById('commissionInput').value;
            
            console.log("üìç [Frontend] Retrieved values from modal:");
            console.log("   shopId: " + shopId);
            console.log("   commission input: " + commission);
            
            // Validation
            console.log("üìç [Frontend] Validating input...");
            if (!commission) {
                console.error("‚ùå [Frontend] Commission is empty");
                alert('Vui l√≤ng nh·∫≠p chi·∫øt kh·∫•u h·ª£p l·ªá (0-100%)');
                return;
            }
            if (isNaN(commission)) {
                console.error("‚ùå [Frontend] Commission is not a number: " + commission);
                alert('Vui l√≤ng nh·∫≠p chi·∫øt kh·∫•u h·ª£p l·ªá (0-100%)');
                return;
            }
            if (commission < 0) {
                console.error("‚ùå [Frontend] Commission is negative: " + commission);
                alert('Vui l√≤ng nh·∫≠p chi·∫øt kh·∫•u h·ª£p l·ªá (0-100%)');
                return;
            }
            if (commission > 100) {
                console.error("‚ùå [Frontend] Commission exceeds 100%: " + commission);
                alert('Vui l√≤ng nh·∫≠p chi·∫øt kh·∫•u h·ª£p l·ªá (0-100%)');
                return;
            }
            console.log("‚úÖ [Frontend] Validation passed");
            
            const commissionValue = parseFloat(commission);
            console.log("üìç [Frontend] Parsed commission as float: " + commissionValue);
            
            const request = {
                commissionPercentage: commissionValue
            };
            
            // Get context path from current location
            const contextPath = window.location.pathname.split('/')[1]; // Get first path segment
            const apiUrl = "/" + contextPath + "/admin/shops/" + shopId + "/commission";
            
            // Get CSRF token from meta tag or cookie
            let csrfToken = document.querySelector('meta[name="_csrf"]') ? document.querySelector('meta[name="_csrf"]').getAttribute('content') : '';
            let csrfHeader = document.querySelector('meta[name="_csrf_header"]') ? document.querySelector('meta[name="_csrf_header"]').getAttribute('content') : 'X-CSRF-TOKEN';
            
            console.log("üìç [Frontend] CSRF Token info:");
            console.log("   Token: " + (csrfToken ? csrfToken.substring(0, 10) + "..." : "NOT FOUND"));
            console.log("   Header: " + csrfHeader);
            
            console.log("üìç [Frontend] Building API request");
            console.log("   Context Path: " + contextPath);
            console.log("   Full URL: " + apiUrl);
            console.log("   Method: PUT");
            console.log("   Payload: " + JSON.stringify(request));
            
            console.log("üìç [Frontend] Sending fetch request...");
            
            // Build headers
            const headers = {
                'Content-Type': 'application/json'
            };
            
            // Add CSRF token if available
            if (csrfToken) {
                headers[csrfHeader] = csrfToken;
                console.log("üìç [Frontend] Added CSRF token to headers");
            }
            
            fetch(apiUrl, {
                method: 'PUT',
                headers: headers,
                body: JSON.stringify(request)
            })
            .then(response => {
                console.log("üìç [Frontend] Response received");
                console.log("   Status: " + response.status);
                console.log("   Status Text: " + response.statusText);
                console.log("   Content-Type: " + response.headers.get('content-type'));
                
                // Check if response is OK
                if (!response.ok) {
                    console.error("‚ùå [Frontend] HTTP Error: " + response.status);
                    
                    // Try to get error details
                    if (response.status === 404) {
                        console.error("‚ùå [Frontend] 404 Not Found - Endpoint kh√¥ng t·ªìn t·∫°i!");
                        console.error("   Endpoint: " + apiUrl);
                        console.error("   Method: PUT");
                        return Promise.reject(new Error("Endpoint not found (404). Check if AdminController is compiled and deployed."));
                    } else if (response.status === 405) {
                        console.error("‚ùå [Frontend] 405 Method Not Allowed - PUT method kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£!");
                        return Promise.reject(new Error("Method PUT not allowed (405)"));
                    }
                }
                
                // Check content-type before parsing JSON
                const contentType = response.headers.get("content-type");
                console.log("   Content-Type check: " + contentType);
                
                if (!contentType || !contentType.includes("application/json")) {
                    console.error("‚ùå [Frontend] Response is not JSON!");
                    console.error("   Received Content-Type: " + contentType);
                    
                    // Try to read response as text for debugging
                    return response.text().then(text => {
                        console.error("   Response body (first 200 chars): " + text.substring(0, 200));
                        throw new Error("Response is not JSON. Received: " + contentType);
                    });
                }
                
                return response.json();
            })
            .then(data => {
                console.log("üìç [Frontend] Response parsed as JSON:");
                console.log("   Status: " + data.status);
                console.log("   Message: " + data.message);
                console.log("   Data: " + JSON.stringify(data.data));
                
                if (data.status === 'success') {
                    console.log("‚úÖ [Frontend] SUCCESS - Commission updated successfully");
                    alert('C·∫≠p nh·∫≠t chi·∫øt kh·∫•u th√†nh c√¥ng!');
                    location.reload();
                } else {
                    console.error("‚ùå [Frontend] API returned error status");
                    console.error("   Error message: " + data.message);
                    alert('L·ªói: ' + data.message);
                }
            })
            .catch(error => {
                console.error("‚ùå [Frontend] EXCEPTION caught");
                console.error("   Error name: " + error.name);
                console.error("   Error message: " + error.message);
                console.error("   Full error: ", error);
                console.error("   Stack: " + error.stack);
                alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t chi·∫øt kh·∫•u: ' + error.message);
            });
            
            console.log("‚úÖ [Frontend] Fetch request sent (async)");
        }
    </script>
</th:block>

</body>
</html>
