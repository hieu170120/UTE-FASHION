<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Tiết Đơn Hàng - NOVA Fashion Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #f8f9fa; }
        .navbar-custom { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .info-label { font-weight: 600; color: #6c757d; }
        .status-badge { padding: 8px 15px; border-radius: 20px; font-size: 14px; }
        .shipper-select-card { background: #fff3cd; border-left: 4px solid #ffc107; }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid white;
            object-fit: cover;
            cursor: pointer;
        }
        .dropdown-toggle::after { display: none; }
    </style>
    <script>
        // Detect nếu đến từ user-management và update nút back
        window.addEventListener('load', function() {
            console.log('=== DEBUG: Order Detail Page Loaded ===');
            
            const backButton = document.getElementById('backToListBtn');
            const fromUserManagement = sessionStorage.getItem('fromUserManagement');
            
            // Get context path from current URL
            const currentPath = window.location.pathname;
            const contextPath = currentPath.substring(0, currentPath.indexOf('/admin'));
            const userManagementUrl = contextPath + '/admin/users';
            
            console.log('DEBUG: currentPath:', currentPath);
            console.log('DEBUG: contextPath:', contextPath);
            console.log('DEBUG: userManagementUrl:', userManagementUrl);
            console.log('DEBUG: backButton found:', !!backButton);
            console.log('DEBUG: fromUserManagement:', fromUserManagement);
            console.log('DEBUG: referrer:', document.referrer);
            
            if (backButton) {
                if (fromUserManagement === 'true') {
                    console.log('DEBUG: Setting back button to user management (from sessionStorage)');
                    backButton.href = userManagementUrl;
                    backButton.innerHTML = '<i class="fas fa-arrow-left"></i> Quay Lại Danh Sách User';
                    sessionStorage.removeItem('fromUserManagement');
                } else if (document.referrer.includes('/admin/users') || document.referrer.includes('user-management')) {
                    console.log('DEBUG: Setting back button to user management (from referrer)');
                    backButton.href = userManagementUrl;
                    backButton.innerHTML = '<i class="fas fa-arrow-left"></i> Quay Lại Danh Sách User';
                }
            } else {
                console.error('DEBUG: backToListBtn not found!');
            }
        });
    </script>
</head>
<body>
    <nav class="navbar navbar-custom navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" th:href="@{/admin/dashboard}">
                <i class="fas fa-shopping-bag"></i> UTE Fashion Admin
            </a>
            <div class="d-flex align-items-center gap-2">
                <a id="backToListBtn" th:href="@{/admin/orders}" class="btn btn-light btn-sm me-2">
                    <i class="fas fa-arrow-left"></i> Quay Lại Danh Sách
                </a>
                <a th:href="@{/admin/orders/pending}" class="btn btn-warning btn-sm me-2">
                    <i class="fas fa-clock"></i> Đơn Chờ Xử Lý
                </a>
                
                <!-- User Avatar Dropdown -->
                <div class="dropdown">
                    <a class="dropdown-toggle" href="#" role="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <img src="https://ui-avatars.com/api/?name=Admin&background=667eea&color=fff&size=128" 
                             alt="User Avatar" 
                             class="user-avatar" />
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                        <li>
                            <a class="dropdown-item" th:href="@{/profile}">
                                <i class="fas fa-user me-2"></i>Thông tin cá nhân
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <a class="dropdown-item text-danger" th:href="@{/logout}">
                                <i class="fas fa-sign-out-alt me-2"></i>Đăng xuất
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <div class="card-body">
                <h2><i class="fas fa-receipt text-primary"></i> Chi Tiết Đơn Hàng #<span th:text="${order.orderNumber}"></span></h2>
            </div>
        </div>

        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle"></i> <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-circle"></i> <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5><i class="fas fa-info-circle text-info"></i> Thông Tin Đơn Hàng</h5>
                        <hr>
                        <p><span class="info-label">Ngày đặt:</span> <span th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}"></span></p>
                        <p><span class="info-label">Trạng thái:</span> 
                            <span class="status-badge" 
                                  th:classappend="${order.orderStatus == 'Processing' ? 'bg-warning text-dark' : 
                                                 (order.orderStatus == 'Vendor_Confirmed' ? 'bg-info text-white' :
                                                 (order.orderStatus == 'Confirmed' ? 'bg-info text-white' : 
                                                 (order.orderStatus == 'Shipping' ? 'bg-primary text-white' : 
                                                 (order.orderStatus == 'Delivered' ? 'bg-success text-white' : 
                                                 (order.orderStatus == 'Shipper_Cancelled' ? 'bg-danger text-white' : 
                                                 (order.orderStatus == 'Return_Requested' ? 'bg-warning text-white' : 
                                                 (order.orderStatus == 'Returned' ? 'bg-secondary text-white' : 'bg-danger text-white')))))))}"
                                  th:text="${order.orderStatus == 'Processing' ? 'Chờ Vendor Xác Nhận' : 
                                          (order.orderStatus == 'Vendor_Confirmed' ? 'Vendor Đã Xác Nhận' :
                                          (order.orderStatus == 'Confirmed' ? 'Đã Chọn Shipper' : 
                                          (order.orderStatus == 'Shipping' ? 'Đang Giao' : 
                                          (order.orderStatus == 'Delivered' ? 'Đã Giao' : 
                                          (order.orderStatus == 'Shipper_Cancelled' ? 'Shipper Hủy' : 
                                          (order.orderStatus == 'Return_Requested' ? 'Yêu Cầu Trả Hàng' : 
                                          (order.orderStatus == 'Returned' ? 'Đã Trả Hàng' : 'Đã Hủy')))))))}"></span>
                        </p>
                        <p><span class="info-label">Tổng tiền:</span> 
                            <span class="text-danger fw-bold fs-5" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                        </p>
                        <p th:if="${order.carrierName}">
                            <span class="info-label">Nhà vận chuyển:</span> 
                            <span class="badge bg-info" th:text="${order.carrierName}"></span>
                        </p>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5><i class="fas fa-shipping-fast text-success"></i> Thông Tin Giao Hàng</h5>
                        <hr>
                        <p><span class="info-label">Họ tên:</span> <span th:text="${order.recipientName}"></span></p>
                        <p><span class="info-label">Số điện thoại:</span> <span th:text="${order.phoneNumber}"></span></p>
                        <p><span class="info-label">Email:</span> <span th:text="${order.email}"></span></p>
                        <p><span class="info-label">Địa chỉ:</span> <span th:text="${order.shippingAddress + ', ' + order.ward + ', ' + order.district + ', ' + order.city}"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lịch sử hủy đơn (nếu có) - Hiển thị cho tất cả trạng thái -->
        <div th:if="${cancelHistory != null && !cancelHistory.isEmpty()}" class="card border-warning">
            <div class="card-body">
                <h5 class="text-warning"><i class="fas fa-exclamation-triangle"></i> Lịch Sử Hủy Đơn</h5>
                <hr>
                <p class="text-muted">Shipper trước đã hủy đơn này. Vui lòng xem lý do trước khi giao cho shipper khác.</p>
                
                <div th:each="history : ${cancelHistory}" class="mb-3 p-3" style="background: #FEF2F2; border-left: 4px solid #DC2626; border-radius: 4px;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <strong><i class="fas fa-user"></i> Shipper: <span th:text="${history.shipperName}"></span></strong>
                        <small class="text-muted" th:text="${#temporals.format(history.cancelledAt, 'dd/MM/yyyy HH:mm')}"></small>
                    </div>
                    <div>
                        <i class="fas fa-comment"></i> <strong>Lý do:</strong><br/>
                        <span th:text="${history.reason}"></span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hiển thị thông tin đơn Shipper hủy -->
        <div th:if="${order.orderStatus == 'Shipper_Cancelled'}" class="card border-danger">
            <div class="card-body">
                <h5 class="text-danger"><i class="fas fa-times-circle"></i> Đơn Bị Shipper Hủy</h5>
                <hr>
                <div class="alert alert-danger">
                    <p class="mb-2"><strong>Lý do hủy:</strong></p>
                    <p class="mb-0" th:text="${order.cancelReason != null ? order.cancelReason : 'Không có lý do'}"></p>
                </div>
                <p th:if="${order.cancelledAt}" class="text-muted small mb-0">
                    <i class="far fa-clock"></i> Thời gian hủy: <span th:text="${#temporals.format(order.cancelledAt, 'dd/MM/yyyy HH:mm')}"></span>
                </p>
            </div>
        </div>
        
        <!-- Chọn Shipper (hiện khi đơn đang Vendor_Confirmed hoặc Shipper_Cancelled) -->
        <div th:if="${(order.orderStatus == 'Vendor_Confirmed' || order.orderStatus == 'Shipper_Cancelled') && shippers != null}" class="card shipper-select-card">
            <div class="card-body">
                <h5><i class="fas fa-user-check text-warning"></i> Chọn Shipper Giao Hàng</h5>
                <p class="text-muted">Chọn shipper từ nhà vận chuyển mà khách hàng đã chọn</p>
                <form th:action="@{/admin/orders/{id}/assign-shipper(id=${order.id})}" method="post">
                    <div class="row align-items-end">
                        <div class="col-md-8">
                            <label class="form-label fw-bold">Chọn Shipper:</label>
                            <select name="shipperId" class="form-select form-select-lg" required>
                                <option value="">-- Chọn shipper --</option>
                                <option th:each="shipper : ${shippers}" 
                                        th:value="${shipper.id}" 
                                        th:text="${shipper.fullName + ' - ' + shipper.phoneNumber + ' (Hủy: ' + shipper.cancelCount + '/3)'}">
                                </option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button type="submit" class="btn btn-success btn-lg w-100">
                                <i class="fas fa-check-circle"></i> Xác Nhận & Giao Cho Shipper
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Hiển thị shipper đã được giao -->
        <div th:if="${order.shipperName != null}" class="card">
            <div class="card-body">
                <h5><i class="fas fa-user-tie text-primary"></i> Shipper Đã Được Giao</h5>
                <hr>
                <p><span class="info-label">Tên shipper:</span> <span th:text="${order.shipperName}"></span></p>
                <p><span class="info-label">SĐT shipper:</span> <span th:text="${order.shipperPhone}"></span></p>
            </div>
        </div>

        <!-- Xử lý yêu cầu trả hàng -->
        <div th:if="${order.orderStatus == 'Return_Requested'}" class="card border-warning">
            <div class="card-body">
                <h5 class="text-warning"><i class="fas fa-undo"></i> Yêu Cầu Trả Hàng</h5>
                <hr>
                <p><span class="info-label">Lý do trả hàng:</span></p>
                <div class="alert alert-light">
                    <p class="mb-0" th:text="${order.returnReason != null ? order.returnReason : 'Không có lý do'}"></p>
                </div>
                <div class="d-flex gap-3 mt-3">
                    <form th:action="@{/admin/orders/{id}/returns/approve(id=${order.id})}" method="post" style="flex: 1;" onsubmit="return confirm('Bạn có chắc chắn muốn chấp nhận yêu cầu trả hàng này không?');">
                        <button type="submit" class="btn btn-success w-100 btn-lg">
                            <i class="fas fa-check-circle"></i> Chấp Nhận Trả Hàng
                        </button>
                    </form>
                    <a th:href="@{/admin/orders/{id}/returns/reject(id=${order.id})}" class="btn btn-danger btn-lg" style="flex: 1;">
                        <i class="fas fa-times-circle"></i> Từ Chối Trả Hàng
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Hiển thị thông tin đơn đã trả hàng -->
        <div th:if="${order.orderStatus == 'Returned'}" class="card border-success">
            <div class="card-body">
                <h5 class="text-success"><i class="fas fa-check-circle"></i> Đơn Hàng Đã Trả Lại</h5>
                <hr>
                <div class="alert alert-success">
                    <i class="fas fa-info-circle"></i> Đơn hàng này đã được chấp nhận trả hàng thành công.
                </div>
                <p><span class="info-label">Lý do trả hàng của khách hàng:</span></p>
                <div class="alert alert-light">
                    <p class="mb-0" th:text="${order.returnReason != null ? order.returnReason : 'Không có lý do'}"></p>
                </div>
            </div>
        </div>
        
        <!-- Hiển thị lý do hủy đơn (nếu trạng thái là Cancelled) -->
        <div th:if="${order.orderStatus == 'Cancelled' && order.cancelReason != null}" class="card border-danger">
            <div class="card-body">
                <h5 class="text-danger"><i class="fas fa-times-circle"></i> Thông Tin Hủy Đơn</h5>
                <hr>
                <p><span class="info-label">Người hủy:</span> 
                    <strong th:text="${order.recipientName}"></strong>
                    <span class="badge ms-2" 
                          th:classappend="${order.cancelledBy == 'CUSTOMER' ? 'bg-warning text-dark' : 'bg-info'}"
                          th:text="${order.cancelledBy == 'CUSTOMER' ? 'Khách hàng' : (order.cancelledBy == 'SHIPPER' ? 'Shipper' : 'Không rõ')}"></span>
                </p>
                <p><span class="info-label">Lý do hủy:</span></p>
                <div class="alert alert-danger">
                    <p class="mb-0" th:text="${order.cancelReason}"></p>
                </div>
                <p th:if="${order.cancelledAt}" class="text-muted small mb-0">
                    <i class="far fa-clock"></i> Thời gian hủy: <span th:text="${#temporals.format(order.cancelledAt, 'dd/MM/yyyy HH:mm')}"></span>
                </p>
            </div>
        </div>
        
        <!-- Hiển thị lý do từ chối trả hàng (nếu trạng thái là Delivered và có adminNotes với từ chối) -->
        <div th:if="${order.orderStatus == 'Delivered' && order.adminNotes != null && #strings.contains(order.adminNotes, 'Lý do từ chối trả hàng')}" class="card border-dark">
            <div class="card-body">
                <h5 class="text-dark"><i class="fas fa-info-circle"></i> Thông Tin Từ Chối Trả Hàng</h5>
                <hr>
                <p class="mb-2"><span class="info-label">Trạng thái:</span> 
                    <span class="badge bg-danger">Admin đã từ chối yêu cầu trả hàng</span>
                </p>
                
                <!-- Lý do trả hàng của khách -->
                <div th:if="${order.returnReason != null}" class="mb-3">
                    <p class="mb-1"><strong>Lý do trả hàng của khách hàng:</strong></p>
                    <div class="alert alert-light mb-0">
                        <p class="mb-0" th:text="${order.returnReason}"></p>
                    </div>
                </div>
                
                <!-- Lý do từ chối của admin -->
                <div class="mb-3">
                    <p class="mb-1"><strong>Lý do admin từ chối:</strong></p>
                    <div class="alert alert-light mb-0">
                        <p class="mb-0" th:text="${order.adminNotes}"></p>
                    </div>
                </div>
                
                <p class="text-muted small mb-0">
                    <i class="fas fa-info-circle"></i> Đơn hàng vẫn giữ ở trạng thái đã giao và khách hàng không thể yêu cầu trả hàng lại.
                </p>
            </div>
        </div>

        <!-- ⚠️ TRẠNG THÁI ĐƠN HÀNG TỰ ĐỘNG - ADMIN KHÔNG ĐƯỢC SỬA THỦ CÔNG -->
        <div class="card border-warning">
            <div class="card-body">
                <div class="alert alert-warning mb-0">
                    <h5><i class="fas fa-info-circle"></i> Lưu Ý Quan Trọng</h5>
                    <p class="mb-2"><strong>Trạng thái đơn hàng được cập nhật TỰ ĐỘNG theo quy trình:</strong></p>
                    <ol class="mb-0">
                        <li><strong>Đang Xử Lý:</strong> Khi khách hàng đặt hàng</li>
                        <li><strong>Đã Xử Lý:</strong> Khi Admin chọn Shipper (tự động)</li>
                        <li><strong>Đang Giao:</strong> Khi Shipper xác nhận giao (tự động)</li>
                        <li><strong>Đã Giao:</strong> Khi hết thời gian countdown (tự động)</li>
                    </ol>
                    <p class="mt-3 mb-0"><i class="fas fa-lock text-danger"></i> Admin KHÔNG được phép thay đổi trạng thái thủ công để đảm bảo tính minh bạch!</p>
                </div>
            </div>
        </div>

        <!-- Danh sách sản phẩm -->
        <div class="card">
            <div class="card-body">
                <h5><i class="fas fa-box-open text-primary"></i> Danh Sách Sản Phẩm</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 120px;">Ảnh</th>
                                <th>Sản Phẩm</th>
                                <th>Size</th>
                                <th>Màu</th>
                                <th>Số Lượng</th>
                                <th>Đơn Giá</th>
                                <th>Thành Tiền</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="item : ${order.orderItems}">
                                <td>
                                     <img th:src="${#strings.isEmpty(item.productImage)
                  ? 'https://cdn.hstatic.net/products/200000182297/1.10_b8c81da853bd47bcb8dfe0addedfdd69_master.jpg'
                  : item.productImage}"
                                         alt="Product Image" 
                                         class="img-thumbnail" 
                                         style="width: 100px; height: 120px; object-fit: cover; border-radius: 8px;"
                                         onerror="this.onerror=null;this.src='https://cdn.hstatic.net/products/200000182297/1.10_b8c81da853bd47bcb8dfe0addedfdd69_master.jpg';">
                                </td>
                                <td><strong th:text="${item.productName}"></strong></td>
                                <td><span class="badge bg-secondary" th:text="${item.size}"></span></td>
                                <td><span class="badge bg-info" th:text="${item.color}"></span></td>
                                <td class="text-center"><strong th:text="${item.quantity}"></strong></td>
                                <td th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                                <td class="text-danger fw-bold" th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="6" class="text-end"><strong>Tạm tính:</strong></td>
                                <td class="fw-bold" th:text="${#numbers.formatDecimal(order.subtotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                            </tr>
                            <tr>
                                <td colspan="6" class="text-end"><strong>Phí vận chuyển:</strong></td>
                                <td class="fw-bold" th:text="${#numbers.formatDecimal(order.shippingFee != null ? order.shippingFee : 0, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                            </tr>
                            <tr th:if="${order.discountAmount != null && order.discountAmount > 0}">
                                <td colspan="6" class="text-end"><strong>Giảm giá:</strong></td>
                                <td class="text-success fw-bold" th:text="'-' + ${#numbers.formatDecimal(order.discountAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                            </tr>
                            <tr class="table-light">
                                <td colspan="6" class="text-end"><strong>TỔNG CỘNG:</strong></td>
                                <td class="text-danger fw-bold fs-5" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
