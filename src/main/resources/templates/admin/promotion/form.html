<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${promotionDTO.id != null ? 'Chỉnh sửa chương trình khuyến mãi' : 'Tạo chương trình khuyến mãi mới'}">Quản lý khuyến mãi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding-bottom: 150px;
        }

        .container-fluid {
            padding: 2rem 1rem;
        }

        /* Page Header */
        .page-header {
            background: white;
            border-radius: 0.75rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-left: 5px solid #007bff;
        }

        .page-header h2 {
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .page-header .breadcrumb {
            margin-bottom: 0;
            background: transparent;
        }

        /* Form Sections */
        .form-section {
            background: white;
            border-radius: 0.75rem;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border-top: 3px solid #007bff;
        }

        .form-section h5 {
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .form-section h5 i {
            color: #007bff;
            font-size: 1.25rem;
        }

        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }

        .required {
            color: #dc3545;
            font-weight: 700;
        }

        .form-control,
        .form-select {
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 0.95rem;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .form-control.is-invalid,
        .form-select.is-invalid {
            border-color: #dc3545;
        }

        .form-control.is-invalid:focus,
        .form-select.is-invalid:focus {
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }

        .invalid-feedback {
            display: block;
            color: #dc3545;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .form-text {
            color: #6c757d;
            font-size: 0.85rem;
        }

        .form-check-input {
            width: 1.25rem;
            height: 1.25rem;
        }

        .form-check-input:checked {
            background-color: #007bff;
            border-color: #007bff;
        }

        /* Cards */
        .card {
            border: 1px solid #dee2e6;
            border-radius: 0.75rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border-bottom: none;
            padding: 1.25rem;
        }

        .card-header h5 {
            color: white;
            margin: 0;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-body {
            padding: 1.75rem;
        }

        /* Preview Card */
        .preview-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 1rem;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .preview-icon {
            font-size: 3rem;
            color: #007bff;
            margin-bottom: 1rem;
        }

        .preview-section h5 {
            color: #2c3e50;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .preview-section p {
            color: #6c757d;
            margin-bottom: 1rem;
        }

        .discount-badge {
            display: inline-block;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 1.25rem;
            box-shadow: 0 0.25rem 0.5rem rgba(40, 167, 69, 0.3);
        }

        /* Buttons */
        .btn {
            border-radius: 0.5rem;
            font-weight: 600;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0, 123, 255, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(40, 167, 69, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(108, 117, 125, 0.3);
        }

        .btn-outline-secondary {
            border: 2px solid #6c757d;
            color: #6c757d;
            background: white;
        }

        .btn-outline-secondary:hover {
            background: #6c757d;
            color: white;
            transform: translateY(-2px);
        }

        .btn-lg {
            padding: 0.875rem 2.5rem;
            font-size: 1rem;
        }

        /* Sticky Footer Buttons */
        .sticky-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(255, 255, 255, 0.98), rgba(255, 255, 255, 0.95));
            border-top: 2px solid #dee2e6;
            padding: 1rem 1.5rem;
            z-index: 1000;
            box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .sticky-footer .btn {
            min-width: 140px;
        }

        /* Alert Messages */
        .alert {
            border-radius: 0.75rem;
            border: none;
            padding: 1.25rem;
            margin-bottom: 2rem;
        }

        .alert-info {
            background: linear-gradient(135deg, rgba(0, 123, 255, 0.1) 0%, rgba(0, 123, 255, 0.05) 100%);
            color: #004085;
            border-left: 4px solid #007bff;
        }

        .alert-success {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%);
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-danger {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(220, 53, 69, 0.05) 100%);
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .guide-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .guide-list li {
            padding: 0.75rem 0;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .guide-list i {
            color: #28a745;
            font-weight: 700;
        }

        /* Footer */
        .page-footer {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-top: 2rem;
        }

        .page-footer small {
            color: #6c757d;
        }

        .page-footer i {
            color: #28a745;
            margin: 0 0.5rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sticky-footer {
                flex-direction: column;
            }

            .sticky-footer .btn {
                width: 100%;
            }

            .page-header {
                padding: 1.5rem;
            }

            .form-section {
                padding: 1.5rem;
            }

            body {
                padding-bottom: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <!-- Header -->
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h2>
                        <i class="fas fa-percentage"></i>
                        <span th:text="${promotionDTO.id != null ? 'Chỉnh sửa chương trình khuyến mãi' : 'Tạo chương trình khuyến mãi mới'}">Quản lý khuyến mãi</span>
                    </h2>
                    <nav aria-label="breadcrumb" class="mt-2">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a th:href="@{/admin/dashboard}"><i class="fas fa-home me-1"></i>Dashboard</a></li>
                            <li class="breadcrumb-item"><a th:href="@{/admin/promotions}"><i class="fas fa-tags me-1"></i>Chương trình khuyến mãi</a></li>
                            <li class="breadcrumb-item active" th:text="${promotionDTO.id != null ? 'Chỉnh sửa' : 'Tạo mới'}">Tạo mới</li>
                        </ol>
                    </nav>
                </div>
                <div>
                    <a th:href="@{/admin/promotions}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Quay lại
                    </a>
                </div>
            </div>
        </div>

        <!-- Messages -->
        <div th:if="${message}" class="alert alert-success">
            <i class="fas fa-check-circle me-2"></i>
            <span th:text="${message}"></span>
        </div>
        <div th:if="${error}" class="alert alert-danger">
            <i class="fas fa-exclamation-circle me-2"></i>
            <span th:text="${error}"></span>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Form Column -->
            <div class="col-lg-8">
                <form id="promotionForm" th:action="@{/admin/promotions/save}" method="post" novalidate>
                    <input type="hidden" name="id" th:value="${promotionDTO.id}">

                    <!-- Basic Info Section -->
                    <div class="form-section">
                        <h5><i class="fas fa-info-circle"></i>Thông tin cơ bản</h5>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="promotionName" class="form-label">
                                        Tên chương trình
                                        <span class="required">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="promotionName" name="promotionName"
                                           th:value="${promotionDTO.promotionName}" maxlength="100" required
                                           placeholder="Nhập tên chương trình khuyến mãi">
                                    <small class="invalid-feedback" id="nameError"></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="promotionType" class="form-label">
                                        Loại chương trình
                                        <span class="required">*</span>
                                    </label>
                                    <select class="form-select" id="promotionType" name="promotionType" required>
                                        <option value="">-- Chọn loại --</option>
                                        <option value="PRODUCT" th:selected="${promotionDTO.promotionType == 'PRODUCT'}">Giảm giá sản phẩm</option>
                                        <option value="CATEGORY" th:selected="${promotionDTO.promotionType == 'CATEGORY'}">Giảm giá danh mục</option>
                                        <option value="BRAND" th:selected="${promotionDTO.promotionType == 'BRAND'}">Giảm giá thương hiệu</option>
                                        <option value="CART_TOTAL" th:selected="${promotionDTO.promotionType == 'CART_TOTAL'}">Giảm giá giỏ hàng</option>
                                        <option value="BUY_X_GET_Y" th:selected="${promotionDTO.promotionType == 'BUY_X_GET_Y'}">Mua X tặng Y</option>
                                    </select>
                                    <small class="invalid-feedback" id="typeError"></small>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label">Mô tả chương trình</label>
                            <textarea class="form-control" id="description" name="description" rows="3"
                                      th:text="${promotionDTO.description}" maxlength="500"
                                      placeholder="Mô tả chi tiết..."></textarea>
                            <small class="form-text"><span id="charCount">0</span>/500</small>
                        </div>
                    </div>

                    <!-- Discount Section -->
                    <div class="form-section">
                        <h5><i class="fas fa-percentage"></i>Thông tin giảm giá</h5>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="discountType" class="form-label">
                                        Loại giảm giá
                                        <span class="required">*</span>
                                    </label>
                                    <select class="form-select" id="discountType" name="discountType" required>
                                        <option value="">-- Chọn --</option>
                                        <option value="PERCENTAGE" th:selected="${promotionDTO.discountType == 'PERCENTAGE'}">Phần trăm (%)</option>
                                        <option value="FIXED_AMOUNT" th:selected="${promotionDTO.discountType == 'FIXED_AMOUNT'}">Số tiền (₫)</option>
                                    </select>
                                    <small class="invalid-feedback" id="discTypeError"></small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="discountValue" class="form-label">
                                        Giá trị giảm
                                        <span class="required">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="discountValue" name="discountValue"
                                           th:value="${promotionDTO.discountValue}" required
                                           placeholder="VD: 20 hoặc 50000">
                                    <small class="invalid-feedback" id="discValueError"></small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="minOrderValue" class="form-label">Đơn hàng tối thiểu (₫)</label>
                                    <input type="number" class="form-control" id="minOrderValue" name="minOrderValue"
                                           th:value="${promotionDTO.minOrderValue}" step="1000" min="0" value="0">
                                    <small class="form-text">Tối thiểu để áp dụng</small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="maxDiscountAmount" class="form-label">Giảm tối đa (₫)</label>
                                    <input type="number" class="form-control" id="maxDiscountAmount" name="maxDiscountAmount"
                                           th:value="${promotionDTO.maxDiscountAmount}" step="1000" min="0"
                                           placeholder="Không giới hạn">
                                    <small class="form-text">Để trống = không giới hạn</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="priority" class="form-label">Độ ưu tiên (0-100)</label>
                                    <input type="number" class="form-control" id="priority" name="priority"
                                           th:value="${promotionDTO.priority}" min="0" max="100" value="0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Limits Section -->
                    <div class="form-section">
                        <h5><i class="fas fa-users"></i>Giới hạn sử dụng</h5>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="usageLimit" class="form-label">Tổng lượt sử dụng</label>
                                    <input type="number" class="form-control" id="usageLimit" name="usageLimit"
                                           th:value="${promotionDTO.usageLimit}" min="1"
                                           placeholder="Không giới hạn">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="usageLimitPerUser" class="form-label">Lượt/người</label>
                                    <input type="number" class="form-control" id="usageLimitPerUser" name="usageLimitPerUser"
                                           th:value="${promotionDTO.usageLimitPerUser}" min="1" value="1">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <div class="form-check mt-4">
                                        <input type="checkbox" class="form-check-input" id="isActive" name="isActive"
                                               value="true" th:checked="${promotionDTO.isActive}">
                                        <label class="form-check-label" for="isActive">
                                            <i class="fas fa-power-off me-1"></i>Kích hoạt ngay
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Time Section -->
                    <div class="form-section">
                        <h5><i class="fas fa-calendar"></i>Thời gian áp dụng</h5>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="validFrom" class="form-label">
                                        Bắt đầu
                                        <span class="required">*</span>
                                    </label>
                                    <input type="datetime-local" class="form-control" id="validFrom" name="validFrom" required>
                                    <small class="invalid-feedback" id="fromError"></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="validTo" class="form-label">
                                        Kết thúc
                                        <span class="required">*</span>
                                    </label>
                                    <input type="datetime-local" class="form-control" id="validTo" name="validTo" required>
                                    <small class="invalid-feedback" id="toError"></small>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-clock me-2"></i>
                            <span>Thời gian: <strong id="timeDisplay">Chưa chọn</strong></span>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Preview -->
                <div class="card mb-3">
                    <div class="card-header">
                        <h5><i class="fas fa-eye me-2"></i>Xem trước</h5>
                    </div>
                    <div class="card-body">
                        <div class="preview-section">
                            <div class="preview-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <h5 id="previewName">Tên chương trình</h5>
                            <p id="previewDesc" class="text-muted mb-3">Mô tả</p>
                            <div class="discount-badge" id="previewValue">0%</div>
                        </div>
                        <hr>
                        <div class="small">
                            <p><strong>Loại:</strong> <span id="previewType">-</span></p>
                            <p><strong>Trạng thái:</strong> <span class="badge bg-secondary" id="previewStatus">Không kích hoạt</span></p>
                            <p><strong>Độ ưu tiên:</strong> <span id="previewPriority">0</span>/100</p>
                        </div>
                    </div>
                </div>

                <!-- Guide -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-lightbulb me-2"></i>Hướng dẫn</h5>
                    </div>
                    <div class="card-body">
                        <ul class="guide-list">
                            <li><i class="fas fa-check-circle"></i> Điền các trường <span class="badge bg-danger">bắt buộc</span></li>
                            <li><i class="fas fa-check-circle"></i> Kiểm tra thời gian hợp lệ</li>
                            <li><i class="fas fa-check-circle"></i> Xem trước kết quả</li>
                            <li><i class="fas fa-check-circle"></i> Nhấn nút "Tạo mới" để lưu</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="page-footer">
            <i class="fas fa-lock"></i>
            <small>Chương trình khuyến mãi sẽ áp dụng khi tất cả điều kiện được thỏa mãn</small>
            <i class="fas fa-check-circle"></i>
        </div>
    </div>

    <!-- Sticky Footer Buttons -->
    <div class="sticky-footer">
        <a th:href="@{/admin/promotions}" class="btn btn-secondary btn-lg">
            <i class="fas fa-times me-2"></i>Hủy
        </a>
        <button type="button" class="btn btn-outline-secondary btn-lg" id="resetBtn">
            <i class="fas fa-redo me-2"></i>Đặt lại
        </button>
        <button type="button" class="btn btn-success btn-lg" id="submitBtn">
            <i class="fas fa-save me-2"></i>
            <span th:text="${promotionDTO.id != null ? 'Cập nhật' : 'Tạo mới'}">Tạo mới</span>
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ===================== INIT =====================
        const form = document.getElementById('promotionForm');
        const nameInput = document.getElementById('promotionName');
        const typeSelect = document.getElementById('promotionType');
        const descInput = document.getElementById('description');
        const discTypeSelect = document.getElementById('discountType');
        const discValueInput = document.getElementById('discountValue');
        const minOrderInput = document.getElementById('minOrderValue');
        const maxDiscInput = document.getElementById('maxDiscountAmount');
        const priorityInput = document.getElementById('priority');
        const usageLimitInput = document.getElementById('usageLimit');
        const usageLimitPerUserInput = document.getElementById('usageLimitPerUser');
        const isActiveCheckbox = document.getElementById('isActive');
        const validFromInput = document.getElementById('validFrom');
        const validToInput = document.getElementById('validTo');

        // ===================== HELPER: Format DateTime =====================
        function formatDatetimeLocal(date) {
            if (!date) return '';
            const d = new Date(date);
            if (isNaN(d.getTime())) return '';
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const h = String(d.getHours()).padStart(2, '0');
            const min = String(d.getMinutes()).padStart(2, '0');
            return `${y}-${m}-${day}T${h}:${min}`;
        }

        // ===================== PREVIEW UPDATE =====================
        function updatePreview() {
            const name = nameInput.value || 'Tên chương trình';
            const desc = descInput.value || 'Mô tả chương trình';
            const type = typeSelect.value || '-';
            const discValue = discValueInput.value || '0';
            const discType = discTypeSelect.value;
            const priority = priorityInput.value || '0';
            const isActive = isActiveCheckbox.checked;

            document.getElementById('previewName').textContent = name;
            document.getElementById('previewDesc').textContent = desc;
            document.getElementById('previewType').textContent = type;
            document.getElementById('previewPriority').textContent = priority;

            const displayValue = discType === 'PERCENTAGE' ? 
                discValue + '%' : 
                (discValue ? new Intl.NumberFormat('vi-VN').format(discValue) + '₫' : '0%');
            document.getElementById('previewValue').textContent = displayValue;

            const statusBadge = document.getElementById('previewStatus');
            if (isActive) {
                statusBadge.textContent = 'Kích hoạt';
                statusBadge.className = 'badge bg-success';
            } else {
                statusBadge.textContent = 'Không kích hoạt';
                statusBadge.className = 'badge bg-secondary';
            }

            updateTimeDisplay();
        }

        function updateTimeDisplay() {
            const from = validFromInput.value;
            const to = validToInput.value;
            if (from && to) {
                const fromDate = new Date(from).toLocaleDateString('vi-VN');
                const toDate = new Date(to).toLocaleDateString('vi-VN');
                document.getElementById('timeDisplay').textContent = `${fromDate} - ${toDate}`;
            }
        }

        // ===================== VALIDATION =====================
        function validate() {
            console.log('=== VALIDATING FORM ===');
            const errors = [];
            clearErrors();

            // Name
            if (!nameInput.value.trim()) {
                console.warn('❌ Name validation failed: empty');
                errors.push('Tên chương trình là bắt buộc');
                nameInput.classList.add('is-invalid');
                document.getElementById('nameError').textContent = 'Bắt buộc';
            } else if (nameInput.value.trim().length < 3) {
                console.warn('❌ Name validation failed: too short');
                errors.push('Tên phải ≥ 3 ký tự');
                nameInput.classList.add('is-invalid');
                document.getElementById('nameError').textContent = 'Tối thiểu 3 ký tự';
            } else {
                console.log('✅ Name valid:', nameInput.value);
            }

            // Type
            if (!typeSelect.value) {
                console.warn('❌ Type validation failed: not selected');
                errors.push('Chọn loại chương trình');
                typeSelect.classList.add('is-invalid');
                document.getElementById('typeError').textContent = 'Bắt buộc';
            } else {
                console.log('✅ Type valid:', typeSelect.value);
            }

            // Discount Type
            if (!discTypeSelect.value) {
                console.warn('❌ Discount type validation failed: not selected');
                errors.push('Chọn loại giảm giá');
                discTypeSelect.classList.add('is-invalid');
                document.getElementById('discTypeError').textContent = 'Bắt buộc';
            } else {
                console.log('✅ Discount type valid:', discTypeSelect.value);
            }

            // Discount Value
            if (!discValueInput.value.trim()) {
                console.warn('❌ Discount value validation failed: empty');
                errors.push('Nhập giá trị giảm');
                discValueInput.classList.add('is-invalid');
                document.getElementById('discValueError').textContent = 'Bắt buộc';
            } else {
                const num = parseFloat(discValueInput.value);
                if (isNaN(num) || num <= 0) {
                    console.warn('❌ Discount value validation failed: not positive');
                    errors.push('Giá trị giảm phải > 0');
                    discValueInput.classList.add('is-invalid');
                    document.getElementById('discValueError').textContent = 'Phải > 0';
                } else if (discTypeSelect.value === 'PERCENTAGE' && num > 100) {
                    console.warn('❌ Discount value validation failed: percentage > 100');
                    errors.push('% không vượt 100');
                    discValueInput.classList.add('is-invalid');
                    document.getElementById('discValueError').textContent = 'Max 100%';
                } else {
                    console.log('✅ Discount value valid:', discValueInput.value);
                }
            }

            // Time
            if (!validFromInput.value) {
                console.warn('❌ ValidFrom validation failed: empty');
                errors.push('Chọn thời gian bắt đầu');
                validFromInput.classList.add('is-invalid');
                document.getElementById('fromError').textContent = 'Bắt buộc';
            } else if (!validToInput.value) {
                console.warn('❌ ValidTo validation failed: empty');
                errors.push('Chọn thời gian kết thúc');
                validToInput.classList.add('is-invalid');
                document.getElementById('toError').textContent = 'Bắt buộc';
            } else {
                const from = new Date(validFromInput.value);
                const to = new Date(validToInput.value);
                if (from >= to) {
                    console.warn('❌ Date range validation failed: from >= to');
                    errors.push('Kết thúc phải sau bắt đầu');
                    validToInput.classList.add('is-invalid');
                    document.getElementById('toError').textContent = 'Phải sau bắt đầu';
                } else {
                    console.log('✅ Date range valid: from=' + validFromInput.value + ', to=' + validToInput.value);
                }
            }

            console.log('Validation summary: ' + errors.length + ' errors found');
            if (errors.length > 0) {
                console.error('Validation errors:', errors);
            }
            return errors;
        }

        function clearErrors() {
            console.log('Clearing validation errors...');
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            document.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
        }

        // ===================== EVENTS =====================
        nameInput.addEventListener('input', updatePreview);
        descInput.addEventListener('input', function() {
            document.getElementById('charCount').textContent = this.value.length;
            updatePreview();
        });
        discValueInput.addEventListener('input', updatePreview);
        discTypeSelect.addEventListener('change', updatePreview);
        typeSelect.addEventListener('change', updatePreview);
        priorityInput.addEventListener('input', updatePreview);
        isActiveCheckbox.addEventListener('change', updatePreview);
        validFromInput.addEventListener('change', updatePreview);
        validToInput.addEventListener('change', updatePreview);

        // Submit
        document.getElementById('submitBtn').addEventListener('click', function(e) {
            e.preventDefault();
            console.log('=== SUBMIT BUTTON CLICKED ===');
            console.log('Form ID:', form.id);
            
            // Collect form data for logging
            const formData = {
                id: document.querySelector('input[name="id"]').value || 'NEW',
                name: nameInput.value,
                type: typeSelect.value,
                discountType: discTypeSelect.value,
                discountValue: discValueInput.value,
                isActive: isActiveCheckbox.checked,
                validFrom: validFromInput.value,
                validTo: validToInput.value
            };
            
            console.log('Form Data:', formData);
            console.log('Validating form...');
            
            const errors = validate();
            
            console.log('Validation errors:', errors.length > 0 ? errors : 'No errors');
            
            if (errors.length > 0) {
                console.error('❌ VALIDATION FAILED');
                errors.forEach((err, idx) => console.error(`  ${idx + 1}. ${err}`));
                alert('Lỗi:\n\n' + errors.join('\n'));
                return;
            }
            
            console.log('✅ VALIDATION PASSED');
            console.log('Preparing form submission...');
            console.log('Form action:', form.action);
            console.log('Form method:', form.method);
            
            // Log all form fields
            const formElements = form.elements;
            console.log('Form fields:');
            for (let i = 0; i < formElements.length; i++) {
                const field = formElements[i];
                if (field.name) {
                    console.log(`  ${field.name}: ${field.value}`);
                }
            }
            
            console.log('*** SUBMITTING FORM ***');
            form.submit();
        });

        // Reset
        document.getElementById('resetBtn').addEventListener('click', function(e) {
            e.preventDefault();
            console.log('=== RESET BUTTON CLICKED ===');
            console.log('Resetting form...');
            form.reset();
            console.log('Form reset complete');
            updatePreview();
            console.log('Preview updated after reset');
        });

        // ===================== INIT DATETIME =====================
        function initDatetime() {
            console.log('=== INITIALIZING DATETIME ===');
            const from = validFromInput.value;
            const to = validToInput.value;
            const promotionId = document.querySelector('input[name="id"]').value;
            
            console.log('Promotion ID:', promotionId || 'NEW PROMOTION');
            console.log('Current validFrom:', from);
            console.log('Current validTo:', to);

            // If editing and has values, format them
            if (from && !from.includes('T')) {
                console.log('Formatting existing validFrom date');
                validFromInput.value = formatDatetimeLocal(from);
            }
            if (to && !to.includes('T')) {
                console.log('Formatting existing validTo date');
                validToInput.value = formatDatetimeLocal(to);
            }

            // If creating new and empty, set defaults
            const isNew = !promotionId;
            console.log('Is new promotion:', isNew);
            
            if (isNew) {
                console.log('Setting default values for new promotion');
                if (!validFromInput.value) {
                    const now = new Date();
                    now.setHours(now.getHours() + 1);
                    validFromInput.value = formatDatetimeLocal(now);
                    console.log('Set validFrom to +1 hour:', validFromInput.value);
                }
                if (!validToInput.value) {
                    const later = new Date();
                    later.setDate(later.getDate() + 30);
                    validToInput.value = formatDatetimeLocal(later);
                    console.log('Set validTo to +30 days:', validToInput.value);
                }
                if (!usageLimitPerUserInput.value) {
                    usageLimitPerUserInput.value = '1';
                    console.log('Set usageLimitPerUser to 1');
                }
                if (!priorityInput.value) {
                    priorityInput.value = '0';
                    console.log('Set priority to 0');
                }
                if (!minOrderInput.value) {
                    minOrderInput.value = '0';
                    console.log('Set minOrderValue to 0');
                }
            } else {
                console.log('Editing existing promotion - skipping defaults');
            }
            
            console.log('DateTime initialization complete');
        }

        // ===================== STARTUP =====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('========== FORM PAGE LOADED ==========');
            console.log('Starting form initialization...');
            
            initDatetime();
            updatePreview();
            
            console.log('✅ Form initialization complete');
            console.log('Form is ready for user interaction');
        });
    </script>
</body>
</html>