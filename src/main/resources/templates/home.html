
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default}">
<head>
    <title>Trang chủ</title>
    <th:block layout:fragment="styles">
        <style>
            /* Copied from your original file to ensure consistency */
            .product-carousel-section .product-carousel-container { position: relative; }
            .product-carousel-section .product-carousel { display: flex; overflow-x: auto; scroll-behavior: smooth; -ms-overflow-style: none; scrollbar-width: none; gap: 1rem; padding-bottom: 1rem; }
            .product-carousel-section .product-carousel::-webkit-scrollbar { display: none; }
            .product-carousel-section .new-product-card { flex: 0 0 24%; max-width: 24%; text-align: center; text-decoration: none; color: #333; }
            .product-carousel-section .new-product-card h6 { margin-top: 0.5rem; font-size: 0.9rem; font-weight: normal; height: 36px; overflow: hidden; }
            .product-carousel-section .carousel-control-prev,
            .product-carousel-section .carousel-control-next { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(128, 128, 128, 0.7); color: white; border: none; width: 40px; height: 40px; line-height: 40px; text-align: center; border-radius: 50%; z-index: 10; }
            .product-carousel-section .carousel-control-prev { left: -20px; }
            .product-carousel-section .carousel-control-next { right: -20px; }
            .product-image-container { position: relative; overflow: hidden; background-color: #f0f0f0; }
            .product-image-container img { width: 100%; height: 320px; object-fit: cover; display: block; transition: transform 0.4s ease, opacity 0.5s ease; opacity: 0; }
            .product-image-container img.loaded { opacity: 1; }

            .product-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.4); display: flex; justify-content: center; align-items: center; transform: translateX(-101%); opacity: 1; transition: transform 0.4s ease; }
            .view-more-btn { background-color: transparent; color: white; border: 1px solid white; padding: 10px 25px; text-decoration: none; font-size: 0.9rem; font-weight: 500; border-radius: 2px; transform: translateY(20px); opacity: 0; transition: all 0.4s ease; }
            .view-more-btn:hover { background-color: white; color: #333; }

            .product-image-container:hover .product-overlay {
                transform: translateX(0);
            }
            .product-image-container:hover .view-more-btn {
                transform: translateY(0);
                opacity: 1;
            }

            .product-card:hover img, .new-product-card:hover img { transform: scale(1.05); }
            .product-carousel-section .product-image-container .sale-badge { position: absolute; top: 10px; right: 10px; background-color: #fff; color: rgb(255, 0, 0); padding: 2px 8px; font-size: 0.8rem; border: 1px solid #ccc; z-index: 5; }
            @media (max-width: 992px) { .product-carousel-section .new-product-card { flex: 0 0 32%; max-width: 32%; } }
            @media (max-width: 768px) { .product-carousel-section .new-product-card { flex: 0 0 48%; max-width: 48%; } }
            @media (max-width: 576px) { .product-carousel-section .new-product-card { flex: 0 0 80%; max-width: 80%; } }
        </style>
    </th:block>
</head>
<body>
<div class="container-fluid" layout:fragment="content">
    <!-- RESTORED: Header Carousel -->
    <div id="header-carousel" class="carousel slide mb-4" data-bs-ride="carousel">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img class="w-100" src="https://theme.hstatic.net/200000182297/1000887316/14/ms_banner_img1_master.jpg?v=2782" alt="Banner Image">
            </div>
            <div class="carousel-item">
                <img class="w-100" src="https://theme.hstatic.net/200000182297/1000887316/14/ms_banner_img1_master.jpg?v=2782" alt="Another Banner">
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#header-carousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span><span class="visually-hidden">Previous</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#header-carousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span><span class="visually-hidden">Next</span>
        </button>
    </div>
    <!-- Carousel End -->

    <!-- New Arrivals Section (with AJAX + Correct Paging) -->
    <div class="container product-carousel-section my-5" th:if="${!#lists.isEmpty(newestProducts)}">
        <h2 class="text-center mb-4">SẢN PHẨM MỚI</h2>
        <div class="product-carousel-container">
            <div class="product-carousel" id="newArrivalsCarousel">
                <a th:href="@{/products/{slug}(slug=${product.slug})}" class="new-product-card" th:each="product : ${newestProducts}" th:attr="data-product-id=${product.productId}">
                    <div class="product-image-container">
                        <img class="product-main-image" th:alt="${product.productName}">
                        <div class="sale-badge" th:if="${product.salePrice != null and product.salePrice < product.price}" th:text="|-${#numbers.formatInteger(((product.price - product.salePrice) * 100.0) / product.price, 0)}%|"></div>
                        <div class="product-overlay"><span class="view-more-btn">XEM THÊM</span></div>
                    </div>
                    <div class="product-info">
                        <h6 th:text="${product.productName}"></h6>
                        <div class="price" th:if="${product.price != null}">...</div>
                    </div>
                </a>
            </div>
            <!-- RESTORED: Original Buttons -->
            <button class="carousel-control-prev" id="prevBtnNew">&lt;</button>
            <button class="carousel-control-next" id="nextBtnNew">&gt;</button>
        </div>
    </div>

    <!-- Bestseller Section (with AJAX + Correct Paging) -->
    <div class="container product-carousel-section my-5" th:if="${!#lists.isEmpty(bestsellerProducts)}">
        <h2 class="text-center mb-4">SẢN PHẨM BÁN CHẠY</h2>
        <div class="product-carousel-container">
            <div class="product-carousel" id="bestsellerCarousel">
                <a th:href="@{/products/{slug}(slug=${product.slug})}" class="new-product-card" th:each="product : ${bestsellerProducts}" th:attr="data-product-id=${product.productId}">
                    <div class="product-image-container">
                        <img class="product-main-image" th:alt="${product.productName}">
                        <div class="sale-badge" th:if="${product.salePrice != null and product.salePrice < product.price}" th:text="|-${#numbers.formatInteger(((product.price - product.salePrice) * 100.0) / product.price, 0)}%|"></div>
                        <div class="product-overlay"><span class="view-more-btn">XEM THÊM</span></div>
                    </div>
                    <div class="product-info">
                        <h6 th:text="${product.productName}"></h6>
                        <div class="price" th:if="${product.price != null}">...</div>
                    </div>
                </a>
            </div>
            <!-- RESTORED: Original Buttons -->
            <button class="carousel-control-prev" id="prevBtnBestseller">&lt;</button>
            <button class="carousel-control-next" id="nextBtnBestseller">&gt;</button>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script th:inline="javascript">
        document.addEventListener("DOMContentLoaded", function() {
            // --- RESTORED: Script for the main header banner ---
            var headerCarouselEl = document.querySelector('#header-carousel');
            if (headerCarouselEl) {
                new bootstrap.Carousel(headerCarouselEl, { interval: 3000, wrap: true });
            }

            // --- RESTORED: Original script for product carousel "paging" ---
            function setupProductCarousel(carouselId, prevBtnId, nextBtnId) {
                const carousel = document.getElementById(carouselId);
                const nextBtn = document.getElementById(nextBtnId);
                const prevBtn = document.getElementById(prevBtnId);
                if (!carousel || !nextBtn || !prevBtn) return;
                function updateCarouselScroll() {
                    // Wait for images to potentially load and cards to have width
                    if (!carousel.querySelector('.new-product-card')) return;
                    const card = carousel.querySelector('.new-product-card');
                    const cardWidth = card.offsetWidth;
                    const gap = parseInt(window.getComputedStyle(carousel).gap) || 16; // 1rem fallback
                    const scrollAmount = cardWidth + gap;
                    nextBtn.onclick = () => carousel.scrollBy({ left: scrollAmount, behavior: 'smooth' });
                    prevBtn.onclick = () => carousel.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
                }
                // Use a timeout to ensure cards are rendered before calculating width
                setTimeout(() => { updateCarouselScroll(); }, 500); // Increased timeout for safety
                window.addEventListener('resize', updateCarouselScroll);
            }

            setupProductCarousel('newArrivalsCarousel', 'prevBtnNew', 'nextBtnNew');
            setupProductCarousel('bestsellerCarousel', 'prevBtnBestseller', 'nextBtnBestseller');

            // --- AJAX Lazy Loading Logic for Product Images ---
            const fetchAndDisplayImages = () => {
                const productCards = Array.from(document.querySelectorAll('.product-card[data-product-id], .new-product-card[data-product-id]'));
                const productIds = productCards.map(card => card.dataset.productId).filter(id => id);

                if (productIds.length === 0) return;

                const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

                fetch('/api/products/images-for-list', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...(csrfToken && { [csrfHeader]: csrfToken })
                    },
                    body: JSON.stringify(productIds)
                })
                .then(response => response.ok ? response.json() : Promise.reject('Failed to fetch images'))
                .then(imagesMap => {
                    productCards.forEach(card => {
                        const productId = card.dataset.productId;
                        const images = imagesMap[productId];
                        const imgElement = card.querySelector('.product-main-image');

                        if (imgElement) {
                            if (images && images.length > 0) {
                                imgElement.src = images[0].imageUrl;
                                imgElement.classList.add('loaded');

                                const container = imgElement.closest('.product-image-container');
                                if (container && images.length > 1) {
                                    const mainSrc = images[0].imageUrl;
                                    const hoverSrc = images[1].imageUrl;
                                    // Preload hover image
                                    const hoverImage = new Image();
                                    hoverImage.src = hoverSrc;

                                    container.addEventListener('mouseenter', () => { imgElement.src = hoverSrc; });
                                    container.addEventListener('mouseleave', () => { imgElement.src = mainSrc; });
                                }
                            } else {
                                imgElement.src = 'https://ih1.redbubble.net/image.4905811472.8675/bg,f8f8f8-flat,750x,075,f-pad,750x1000,f8f8f8.jpg';
                                imgElement.classList.add('loaded');
                            }
                        }
                    });
                })
                .catch(error => console.error('Error fetching homepage product images:', error));
            };

            fetchAndDisplayImages();
        });
    </script>
</th:block>

</body>
</html>
