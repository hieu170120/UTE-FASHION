<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Tiết Đơn Hàng - UTE Fashion Shipper</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #f8f9fa; }
        .navbar-custom { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .info-label { font-weight: 600; color: #6c757d; }
        .status-badge { padding: 8px 15px; border-radius: 20px; font-size: 14px; }
        .action-card { background: #fff3cd; border-left: 4px solid #ffc107; }
        .btn-action { padding: 12px 24px; font-size: 16px; border-radius: 8px; }
        
        /* Added styles based on vendor's order-status-detail */
        .order-detail-card {
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #E5E7EB;
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #F3F4F6;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            color: #6B7280;
            font-weight: 600;
        }
        .info-value {
            color: #1F2937;
            font-weight: 500;
        }
        .product-item {
            display: flex;
            padding: 20px;
            border: 1px solid #E5E7EB;
            border-radius: 12px;
            margin-bottom: 16px;
            transition: all 0.3s;
        }
        .product-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        .product-image {
            width: 100px;
            height: 120px;
            object-fit: cover;
            border-radius: 8px;
        }
        .status-badge {
            padding: 8px 20px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-custom navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" th:href="@{/}">
                <i class="fas fa-shopping-bag"></i> NOVA FASHION
            </a>
            <div>
                <a th:href="@{/shipper}" class="btn btn-light btn-sm">
                    <i class="fas fa-arrow-left"></i> Quay Lại Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container my-5">
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle"></i> <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-circle"></i> <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold mb-2">
                    <i class="fas fa-file-invoice text-primary"></i> 
                    Chi tiết đơn hàng
                </h2>
                <p class="text-muted mb-0">
                    Mã đơn: <strong th:text="${order.orderNumber}"></strong>
                </p>
            </div>
            <a th:href="@{/shipper}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Quay lại
            </a>
        </div>

        <div class="row">
            <!-- Left: Order Info -->
            <div class="col-lg-8">
                <!-- Status Card -->
                <div class="card order-detail-card mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h5 class="mb-1">Trạng thái đơn hàng</h5>
                                <p class="text-muted small mb-0">
                                    <i class="far fa-clock me-1"></i>
                                    <span th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}"></span>
                                </p>
                            </div>
                            <span class="status-badge"
                                  th:classappend="${order.orderStatus == 'Processing' ? 'bg-warning text-dark' : 
                                                 (order.orderStatus == 'Confirmed' ? 'bg-info text-white' : 
                                                 (order.orderStatus == 'Shipping' ? 'bg-primary text-white' : 
                                                 (order.orderStatus == 'Delivered' ? 'bg-success text-white' : 
                                                 (order.orderStatus == 'Shipper_Cancelled' ? 'bg-danger text-white' : 
                                                 (order.orderStatus == 'Return_Requested' ? 'bg-warning text-white' : 
                                                 (order.orderStatus == 'Returned' ? 'bg-secondary text-white' : 'bg-danger text-white'))))))}">
                                <i class="fas"
                                   th:classappend="${order.orderStatus == 'Processing' ? 'fa-clock' : 
                                                    (order.orderStatus == 'Confirmed' ? 'fa-hourglass-half' : 
                                                    (order.orderStatus == 'Shipping' ? 'fa-truck' : 
                                                    (order.orderStatus == 'Delivered' ? 'fa-check-double' : 
                                                    (order.orderStatus == 'Shipper_Cancelled' ? 'fa-times-circle' : 
                                                    (order.orderStatus == 'Return_Requested' ? 'fa-undo' : 
                                                    (order.orderStatus == 'Returned' ? 'fa-box-open' : 'fa-times-circle'))))))}"></i>
                                <span th:text="${order.orderStatus == 'Processing' ? 'Đang Xử Lý' : 
                                          (order.orderStatus == 'Confirmed' ? 'Chờ Xác Nhận Giao' : 
                                          (order.orderStatus == 'Shipping' ? 'Đang Giao' : 
                                          (order.orderStatus == 'Delivered' ? 'Đã Giao' : 
                                          (order.orderStatus == 'Shipper_Cancelled' ? 'Shipper Hủy' : 
                                          (order.orderStatus == 'Return_Requested' ? 'Yêu Cầu Trả Hàng' : 
                                          (order.orderStatus == 'Returned' ? 'Đã Trả Hàng' : 'Đã Hủy'))))))}"></span>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Products -->
                <div class="card order-detail-card">
                    <div class="card-body">
                        <h5 class="section-title">
                            <i class="fas fa-box-open text-primary me-2"></i>Danh Sách Sản Phẩm
                        </h5>
                        
                        <div th:each="item : ${order.orderItems}" class="product-item">
                            <!-- Product Image -->
                            <img th:src="${#strings.isEmpty(item.productImage)
                  ? 'https://cdn.hstatic.net/products/200000182297/1.10_b8c81da853bd47bcb8dfe0addedfdd69_master.jpg'
                  : item.productImage}"
                                 class="product-image me-3" 
                                 alt="Product Image"
                                 onerror="this.onerror=null;this.src='https://cdn.hstatic.net/products/200000182297/1.10_b8c81da853bd47bcb8dfe0addedfdd69_master.jpg';">
                            <div class="flex-grow-1">
                                <h6 class="mb-2 fw-bold" th:text="${item.productName}"></h6>
                                <p class="text-muted small mb-2">
                                    <span th:if="${item.size}">
                                        Size: <strong th:text="${item.size}"></strong>
                                    </span>
                                    <span th:if="${item.color}">
                                        | Màu: <strong th:text="${item.color}"></strong>
                                    </span>
                                </p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">
                                        Số lượng: <strong th:text="${item.quantity}"></strong>
                                    </span>
                                    <div class="text-end">
                                        <p class="mb-0 text-muted small" th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></p>
                                        <p class="mb-0 fw-bold text-danger" th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="card order-detail-card">
                    <div class="card-body">
                        <h5 class="section-title">
                            <i class="fas fa-cog text-primary me-2"></i>Hành Động
                        </h5>
                        
                        <!-- Actions Card (Chỉ hiện khi Confirmed - chờ shipper xác nhận) -->
                        <div th:if="${order.orderStatus == 'Confirmed'}" class="card action-card mb-3">
                            <div class="card-body">
                                <h6 class="text-warning"><i class="fas fa-hand-pointer me-2"></i>Hành Động</h6>
                                <p class="text-muted">Bạn đã hủy <strong><span th:text="${cancelCount}">0</span>/3</strong> đơn hàng. 
                                    <span th:if="${cancelCount >= 3}" class="text-danger">Bạn không thể hủy thêm đơn nào nữa!</span>
                                </p>
                                <div class="d-flex gap-3">
                                    <form th:action="@{/shipper/orders/{id}/confirm(id=${order.id})}" method="post" style="flex: 1;" 
                                          onsubmit="return confirm('Xác nhận nhận đơn này và bắt đầu giao hàng?\n\nThời gian giao sẽ được random từ 2-5 phút.');">
                                        <button type="submit" class="btn btn-success btn-action w-100">
                                            <i class="fas fa-check-circle"></i> Xác Nhận Giao Hàng
                                        </button>
                                    </form>
                                    <a th:if="${cancelCount < 3}" 
                                       th:href="@{/shipper/orders/{id}/cancel(id=${order.id})}"
                                       class="btn btn-danger btn-action w-100" 
                                       style="flex: 1; text-decoration: none; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-times-circle"></i> Hủy Đơn
                                    </a>
                                </div>
                            </div>
                        </div>

                        <!-- Hiển thị thông tin yêu cầu trả hàng -->
                        <div th:if="${order.orderStatus == 'Return_Requested'}" class="alert alert-warning mb-0">
                            <i class="fas fa-undo me-2"></i>
                            <strong>Yêu Cầu Trả Hàng</strong>
                            <p class="mb-0 mt-2 small">Đơn hàng này đang chờ vendor (cửa hàng) xử lý yêu cầu trả hàng.</p>
                            <div th:if="${order.returnReason != null && !#strings.isEmpty(order.returnReason)}" class="mt-2 pt-2 border-top">
                                <strong>Lý do trả hàng của khách:</strong><br/>
                                <span th:text="${order.returnReason}"></span>
                            </div>
                        </div>
                        
                        <!-- Hiển thị thông tin đơn đã trả hàng -->
                        <div th:if="${order.orderStatus == 'Returned'}" class="alert alert-secondary mb-0">
                            <i class="fas fa-check-circle me-2"></i>
                            <strong>Đơn Hàng Đã Trả Lại</strong>
                            <p class="mb-0 mt-2 small">Đơn hàng này đã được vendor (cửa hàng) chấp nhận trả hàng.</p>
                            <div th:if="${order.returnReason != null && !#strings.isEmpty(order.returnReason)}" class="mt-2 pt-2 border-top">
                                <strong>Lý do trả hàng của khách:</strong><br/>
                                <span th:text="${order.returnReason != null ? order.returnReason : 'Không có lý do'}"></span>
                            </div>
                        </div>
                        
                        <!-- Hiển thị lý do shipper hủy đơn -->
                        <div th:if="${order.orderStatus == 'Shipper_Cancelled'}" class="alert alert-danger mb-0">
                            <i class="fas fa-times-circle me-2"></i>
                            <strong>Bạn đã hủy đơn này</strong>
                            <div th:if="${order.cancelReason != null && !#strings.isEmpty(order.cancelReason)}" class="mt-2 pt-2 border-top">
                                <strong>Lý do hủy:</strong><br/>
                                <span th:text="${order.cancelReason != null ? order.cancelReason : 'Không có lý do'}"></span>
                            </div>
                            <p th:if="${order.cancelledAt}" class="text-muted small mt-2">
                                <i class="far fa-clock"></i> Thời gian hủy: <span th:text="${#temporals.format(order.cancelledAt, 'dd/MM/yyyy HH:mm')}"></span>
                            </p>
                            <p class="mb-0 mt-2 small">Đơn này đang chờ admin chọn shipper khác để giao.</p>
                        </div>
                        
                        <!-- Hiển thị lý do hủy đơn (nếu trạng thái là Cancelled) -->
                        <div th:if="${order.orderStatus == 'Cancelled' && order.cancelReason != null}" class="alert alert-danger mb-0">
                            <i class="fas fa-times-circle me-2"></i>
                            <strong>Đơn hàng đã bị hủy</strong>
                            <p class="mb-0 mt-2 small">
                                Người hủy: <strong th:text="${order.recipientName}"></strong>
                                <span class="badge ms-2" 
                                      th:classappend="${order.cancelledBy == 'CUSTOMER' ? 'bg-warning text-dark' : 'bg-info'}"
                                      th:text="${order.cancelledBy == 'CUSTOMER' ? 'Khách hàng' : (order.cancelledBy == 'SHIPPER' ? 'Shipper' : 'Không rõ')}"></span>
                            </p>
                            <div th:if="${order.cancelReason != null && !#strings.isEmpty(order.cancelReason)}" class="mt-2 pt-2 border-top">
                                <strong>Lý do hủy:</strong><br/>
                                <span th:text="${order.cancelReason}"></span>
                            </div>
                            <p th:if="${order.cancelledAt}" class="text-muted small mt-2">
                                <i class="far fa-clock"></i> Thời gian hủy: <span th:text="${#temporals.format(order.cancelledAt, 'dd/MM/yyyy HH:mm')}"></span>
                            </p>
                        </div>
                        
                        <!-- Hiển thị lý do từ chối trả hàng (nếu trạng thái là Delivered và có adminNotes với từ chối) -->
                        <div th:if="${order.orderStatus == 'Delivered' && order.adminNotes != null && #strings.contains(order.adminNotes, 'Lý do từ chối trả hàng')}" class="alert alert-danger mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Thông Tin Từ Chối Trả Hàng</strong>
                            <p class="mb-0 mt-2 small">Vendor (cửa hàng) đã từ chối yêu cầu trả hàng.</p>
                            <div th:if="${order.returnReason != null}" class="mt-2 pt-2 border-top">
                                <strong>Lý do trả hàng của khách hàng:</strong><br/>
                                <span th:text="${order.returnReason}"></span>
                            </div>
                            <div class="mt-2 pt-2 border-top">
                                <strong>Lý do vendor từ chối:</strong><br/>
                                <span th:text="${order.adminNotes}"></span>
                            </div>
                            <p class="text-muted small mt-2">
                                Đơn hàng vẫn giữ ở trạng thái đã giao và khách hàng không thể yêu cầu trả hàng lại.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Summary -->
            <div class="col-lg-4">
                <!-- Delivery Info -->
                <div class="card order-detail-card">
                    <div class="card-body">
                        <h5 class="section-title">
                            <i class="fas fa-shipping-fast text-primary me-2"></i>Thông Tin Người Nhận
                        </h5>
                        <div class="info-row">
                            <span class="info-label">Họ tên:</span>
                            <span class="info-value" th:text="${order.recipientName}"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Số điện thoại:</span>
                            <span class="info-value" th:text="${order.phoneNumber}"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Email:</span>
                            <span class="info-value" th:text="${order.email}"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Địa chỉ:</span>
                            <span class="info-value text-end" th:text="${order.shippingAddress + ', ' + order.ward + ', ' + order.district + ', ' + order.city}"></span>
                        </div>
                    </div>
                </div>

                <!-- Payment Summary -->
                <div class="card order-detail-card">
                    <div class="card-body">
                        <h5 class="section-title">
                            <i class="fas fa-receipt text-primary me-2"></i>Thông tin thanh toán
                        </h5>
                        <div class="info-row">
                            <span class="info-label">Tạm tính:</span>
                            <span class="info-value" th:text="${#numbers.formatDecimal(order.subtotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Phí vận chuyển:</span>
                            <span class="info-value" th:text="${#numbers.formatDecimal(order.shippingFee != null ? order.shippingFee : 0, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                        </div>
                        <div class="info-row" th:if="${order.discountAmount != null && order.discountAmount > 0}">
                            <span class="info-label text-success">Giảm giá:</span>
                            <span class="info-value text-success">-<span th:text="${#numbers.formatDecimal(order.discountAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span></span>
                        </div>
                        <hr>
                        <div class="info-row">
                            <span class="info-label fs-5 fw-bold">Tổng cộng:</span>
                            <span class="info-value fs-4 fw-bold text-danger" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                        </div>
                        <hr>
                        <div class="info-row">
                            <span class="info-label">Phương thức thanh toán:</span>
                            <span class="info-value" th:text="${order.paymentStatus == 'Paid' ? 'Đã thanh toán online' : 'COD (Thanh toán khi nhận hàng)'}"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>