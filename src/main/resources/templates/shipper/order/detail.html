<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chi Tiết Đơn Hàng - UTE Fashion Shipper</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #f8f9fa; }
        .navbar-custom { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .info-label { font-weight: 600; color: #6c757d; }
        .status-badge { padding: 8px 15px; border-radius: 20px; font-size: 14px; }
        .action-card { background: #fff3cd; border-left: 4px solid #ffc107; }
        .btn-action { padding: 12px 24px; font-size: 16px; border-radius: 8px; }
    </style>
</head>
<body>
    <nav class="navbar navbar-custom navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" th:href="@{/}">
                <i class="fas fa-shopping-bag"></i> NOVA FASHION
            </a>
            <div>
                <a th:href="@{/shipper}" class="btn btn-light btn-sm">
                    <i class="fas fa-arrow-left"></i> Quay Lại Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <div class="card-body">
                <h2><i class="fas fa-receipt text-success"></i> Chi Tiết Đơn Hàng #<span th:text="${order.orderNumber}"></span></h2>
            </div>
        </div>

        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle"></i> <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-circle"></i> <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5><i class="fas fa-info-circle text-info"></i> Thông Tin Đơn Hàng</h5>
                        <hr>
                        <p><span class="info-label">Ngày đặt:</span> <span th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}"></span></p>
                        <p><span class="info-label">Trạng thái:</span> 
                            <span class="status-badge" 
                                  th:classappend="${order.orderStatus == 'Processing' ? 'bg-warning text-dark' : 
                                                 (order.orderStatus == 'Confirmed' ? 'bg-info text-white' : 
                                                 (order.orderStatus == 'Shipping' ? 'bg-primary text-white' : 
                                                 (order.orderStatus == 'Delivered' ? 'bg-success text-white' : 
                                                 (order.orderStatus == 'Shipper_Cancelled' ? 'bg-danger text-white' : 
                                                 (order.orderStatus == 'Return_Requested' ? 'bg-warning text-white' : 
                                                 (order.orderStatus == 'Returned' ? 'bg-secondary text-white' : 'bg-danger text-white'))))))}"
                                  th:text="${order.orderStatus == 'Processing' ? 'Đang Xử Lý' : 
                                          (order.orderStatus == 'Confirmed' ? 'Chờ Xác Nhận Giao' : 
                                          (order.orderStatus == 'Shipping' ? 'Đang Giao' : 
                                          (order.orderStatus == 'Delivered' ? 'Đã Giao' : 
                                          (order.orderStatus == 'Shipper_Cancelled' ? 'Shipper Hủy' : 
                                          (order.orderStatus == 'Return_Requested' ? 'Yêu Cầu Trả Hàng' : 
                                          (order.orderStatus == 'Returned' ? 'Đã Trả Hàng' : 'Đã Hủy'))))))}"></span>
                        </p>
                        <p><span class="info-label">Tổng tiền:</span> 
                            <span class="text-danger fw-bold fs-5" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                        </p>
                        <p><span class="info-label">Phương thức thanh toán:</span> 
                            <span class="badge bg-info" th:text="${order.paymentStatus == 'Paid' ? 'Đã thanh toán online' : 'COD (Thanh toán khi nhận hàng)'}"></span>
                        </p>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5><i class="fas fa-shipping-fast text-success"></i> Thông Tin Người Nhận</h5>
                        <hr>
                        <p><span class="info-label">Họ tên:</span> <span th:text="${order.recipientName}"></span></p>
                        <p><span class="info-label">Số điện thoại:</span> <span th:text="${order.phoneNumber}"></span></p>
                        <p><span class="info-label">Email:</span> <span th:text="${order.email}"></span></p>
                        <p><span class="info-label">Địa chỉ:</span> <span th:text="${order.shippingAddress + ', ' + order.ward + ', ' + order.district + ', ' + order.city}"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions Card (Chỉ hiện khi Confirmed - chờ shipper xác nhận) -->
        <div th:if="${order.orderStatus == 'Confirmed'}" class="card action-card">
            <div class="card-body">
                <h5><i class="fas fa-hand-pointer text-warning"></i> Hành Động</h5>
                <p class="text-muted">Bạn đã hủy <strong><span th:text="${cancelCount}">0</span>/3</strong> đơn hàng. 
                    <span th:if="${cancelCount >= 3}" class="text-danger">Bạn không thể hủy thêm đơn nào nữa!</span>
                </p>
                <div class="d-flex gap-3">
                    <form th:action="@{/shipper/orders/{id}/confirm(id=${order.id})}" method="post" style="flex: 1;" 
                          onsubmit="return confirm('Xác nhận nhận đơn này và bắt đầu giao hàng?\n\nThời gian giao sẽ được random từ 2-5 phút.');">
                        <button type="submit" class="btn btn-success btn-action w-100">
                            <i class="fas fa-check-circle"></i> Xác Nhận Giao Hàng
                        </button>
                    </form>
                    <a th:if="${cancelCount < 3}" 
                       th:href="@{/shipper/orders/{id}/cancel(id=${order.id})}"
                       class="btn btn-danger btn-action w-100" 
                       style="flex: 1; text-decoration: none; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-times-circle"></i> Hủy Đơn
                    </a>
                </div>
            </div>
        </div>

        <!-- Hiển thị thông tin yêu cầu trả hàng -->
        <div th:if="${order.orderStatus == 'Return_Requested'}" class="card border-warning">
            <div class="card-body">
                <h5 class="text-warning"><i class="fas fa-undo"></i> Yêu Cầu Trả Hàng</h5>
                <hr>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle"></i> Đơn hàng này đang chờ admin xử lý yêu cầu trả hàng.
                </div>
                <p><span class="info-label">Lý do trả hàng của khách:</span></p>
                <div class="alert alert-light">
                    <p class="mb-0" th:text="${order.returnReason != null ? order.returnReason : 'Không có lý do'}"></p>
                </div>
            </div>
        </div>
        
        <!-- Hiển thị thông tin đơn đã trả hàng -->
        <div th:if="${order.orderStatus == 'Returned'}" class="card border-success">
            <div class="card-body">
                <h5 class="text-success"><i class="fas fa-check-circle"></i> Đơn Hàng Đã Trả Lại</h5>
                <hr>
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i> Đơn hàng này đã được admin chấp nhận trả hàng.
                </div>
                <p><span class="info-label">Lý do trả hàng của khách:</span></p>
                <div class="alert alert-light">
                    <p class="mb-0" th:text="${order.returnReason != null ? order.returnReason : 'Không có lý do'}"></p>
                </div>
            </div>
        </div>
        
        <!-- Hiển thị lý do shipper hủy đơn -->
        <div th:if="${order.orderStatus == 'Shipper_Cancelled'}" class="card border-danger">
            <div class="card-body">
                <h5 class="text-danger"><i class="fas fa-times-circle"></i> Thông Tin Hủy Đơn</h5>
                <hr>
                <p><span class="info-label">Bạn đã hủy đơn này</span></p>
                <p><span class="info-label">Lý do hủy:</span></p>
                <div class="alert alert-danger">
                    <p class="mb-0" th:text="${order.cancelReason != null ? order.cancelReason : 'Không có lý do'}"></p>
                </div>
                <p th:if="${order.cancelledAt}" class="text-muted small mb-0">
                    <i class="far fa-clock"></i> Thời gian hủy: <span th:text="${#temporals.format(order.cancelledAt, 'dd/MM/yyyy HH:mm')}"></span>
                </p>
                <div class="alert alert-warning mb-0 mt-3">
                    <i class="fas fa-info-circle"></i> Đơn này đang chờ admin chọn shipper khác để giao.
                </div>
            </div>
        </div>
        
        <!-- Hiển thị lý do hủy đơn (nếu trạng thái là Cancelled) -->
        <div th:if="${order.orderStatus == 'Cancelled' && order.cancelReason != null}" class="card border-danger">
            <div class="card-body">
                <h5 class="text-danger"><i class="fas fa-times-circle"></i> Thông Tin Hủy Đơn</h5>
                <hr>
                <p><span class="info-label">Người hủy:</span> 
                    <strong th:text="${order.recipientName}"></strong>
                    <span class="badge ms-2" 
                          th:classappend="${order.cancelledBy == 'CUSTOMER' ? 'bg-warning text-dark' : 'bg-info'}"
                          th:text="${order.cancelledBy == 'CUSTOMER' ? 'Khách hàng' : (order.cancelledBy == 'SHIPPER' ? 'Shipper' : 'Không rõ')}"></span>
                </p>
                <p><span class="info-label">Lý do hủy:</span></p>
                <div class="alert alert-danger">
                    <p class="mb-0" th:text="${order.cancelReason}"></p>
                </div>
                <p th:if="${order.cancelledAt}" class="text-muted small mb-0">
                    <i class="far fa-clock"></i> Thời gian hủy: <span th:text="${#temporals.format(order.cancelledAt, 'dd/MM/yyyy HH:mm')}"></span>
                </p>
            </div>
        </div>
        
        <!-- Hiển thị lý do từ chối trả hàng (nếu trạng thái là Delivered và có adminNotes với từ chối) -->
        <div th:if="${order.orderStatus == 'Delivered' && order.adminNotes != null && #strings.contains(order.adminNotes, 'Lý do từ chối trả hàng')}" class="card border-dark">
            <div class="card-body">
                <h5 class="text-dark"><i class="fas fa-info-circle"></i> Thông Tin Từ Chối Trả Hàng</h5>
                <hr>
                <p class="mb-2"><span class="info-label">Trạng thái:</span> 
                    <span class="badge bg-danger">Admin đã từ chối yêu cầu trả hàng</span>
                </p>
                
                <!-- Lý do trả hàng của khách -->
                <div th:if="${order.returnReason != null}" class="mb-3">
                    <p class="mb-1"><strong>Lý do trả hàng của khách hàng:</strong></p>
                    <div class="alert alert-light mb-0">
                        <p class="mb-0" th:text="${order.returnReason}"></p>
                    </div>
                </div>
                
                <!-- Lý do từ chối của admin -->
                <div class="mb-3">
                    <p class="mb-1"><strong>Lý do admin từ chối:</strong></p>
                    <div class="alert alert-light mb-0">
                        <p class="mb-0" th:text="${order.adminNotes}"></p>
                    </div>
                </div>
                
                <p class="text-muted small mb-0">
                    <i class="fas fa-info-circle"></i> Đơn hàng vẫn giữ ở trạng thái đã giao và khách hàng không thể yêu cầu trả hàng lại.
                </p>
            </div>
        </div>

        <!-- Danh sách sản phẩm -->
        <div class="card">
            <div class="card-body">
                <h5><i class="fas fa-box-open text-primary"></i> Danh Sách Sản Phẩm</h5>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 120px;">Ảnh</th>
                                <th>Sản Phẩm</th>
                                <th>Size</th>
                                <th>Màu</th>
                                <th>Số Lượng</th>
                                <th>Đơn Giá</th>
                                <th>Thành Tiền</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="item : ${order.orderItems}">
                                <td>
                                    <img th:src="${#strings.isEmpty(item.productImage)
                  ? 'https://cdn.hstatic.net/products/200000182297/1.10_b8c81da853bd47bcb8dfe0addedfdd69_master.jpg'
                  : item.productImage}"
                                         alt="Product Image" 
                                         class="img-thumbnail" 
                                         style="width: 100px; height: 120px; object-fit: cover; border-radius: 8px;"
                                         onerror="this.onerror=null;this.src='https://cdn.hstatic.net/products/200000182297/1.10_b8c81da853bd47bcb8dfe0addedfdd69_master.jpg';">
                                </td>
                                <td><strong th:text="${item.productName}"></strong></td>
                                <td><span class="badge bg-secondary" th:text="${item.size}"></span></td>
                                <td><span class="badge bg-info" th:text="${item.color}"></span></td>
                                <td class="text-center"><strong th:text="${item.quantity}"></strong></td>
                                <td th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                                <td class="text-danger fw-bold" th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="6" class="text-end"><strong>Tạm tính:</strong></td>
                                <td class="fw-bold" th:text="${#numbers.formatDecimal(order.subtotal, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                            </tr>
                            <tr>
                                <td colspan="6" class="text-end"><strong>Phí vận chuyển:</strong></td>
                                <td class="fw-bold" th:text="${#numbers.formatDecimal(order.shippingFee != null ? order.shippingFee : 0, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                            </tr>
                            <tr th:if="${order.discountAmount != null && order.discountAmount > 0}">
                                <td colspan="6" class="text-end"><strong>Giảm giá:</strong></td>
                                <td class="text-success fw-bold" th:text="'-' + ${#numbers.formatDecimal(order.discountAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                            </tr>
                            <tr class="table-light">
                                <td colspan="6" class="text-end"><strong>TỔNG CỘNG:</strong></td>
                                <td class="text-danger fw-bold fs-5" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
