<!-- ƒê∆°n ƒëang giao - Delivering Content Fragment -->
<div xmlns:th="http://www.thymeleaf.org">
    <h2 style="margin-bottom: 24px; font-weight: 700; color: #1E293B;">üöö ƒê∆°n ƒëang giao & ƒê√£ ho√†n th√†nh</h2>

    <!-- Filter Tabs -->
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#delivering-tab">
                <i class="fas fa-shipping-fast"></i> ƒêang giao (<span th:text="${deliveringOrders.size()}">0</span>)
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#delivered-tab">
                <i class="fas fa-check-circle"></i> ƒê√£ giao (<span th:text="${deliveredOrders.size()}">0</span>)
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#returned-tab">
                <i class="fas fa-undo"></i> ƒê√£ tr·∫£ h√†ng (<span th:text="${returnedOrders.size()}">0</span>)
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#cancelled-tab">
                <i class="fas fa-times-circle"></i> ƒê√£ h·ªßy (<span th:text="${cancelledOrders.size()}">0</span>)
            </a>
        </li>
    </ul>

    <div class="tab-content">
        <!-- ƒêang giao -->
        <div class="tab-pane fade show active" id="delivering-tab">
            <div th:if="${deliveringOrders.isEmpty()}" class="alert alert-info">
                <i class="fas fa-info-circle"></i> Kh√¥ng c√≥ ƒë∆°n ƒëang giao.
            </div>
            
            <div th:each="order : ${deliveringOrders}" class="order-card" style="background: white; border: 1px solid #E2E8F0; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div style="font-weight: 600; font-size: 16px;">
                        <i class="fas fa-truck"></i> <span th:text="${order.orderNumber}"></span>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span th:if="${order.paymentMethod == 'COD'}" style="background: #FEF3C7; color: #92400E; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">COD</span>
                        <span th:if="${order.paymentMethod == 'SEPAY_QR'}" style="background: #D1FAE5; color: #065F46; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">ƒê√£ thanh to√°n</span>
                        <span style="background: #DBEAFE; color: #1E40AF; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">ƒêang giao</span>
                    </div>
                </div>
                <div style="color: #64748B; font-size: 14px; line-height: 1.6;">
                    <div><i class="fas fa-user"></i> <strong>Kh√°ch h√†ng:</strong> <span th:text="${order.recipientName}"></span></div>
                    <div><i class="fas fa-phone"></i> <strong>SƒêT:</strong> <span th:text="${order.phoneNumber}"></span></div>
                    <div><i class="fas fa-map-marker-alt"></i> <strong>ƒê·ªãa ch·ªâ:</strong> <span th:text="${order.shippingAddress}"></span></div>
                    <div><i class="fas fa-money-bill-wave"></i> <strong>T·ªïng ti·ªÅn:</strong> 
                        <span th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
                    </div>
                    <div style="margin-top: 12px;">
                        <i class="fas fa-clock"></i> <strong>Th·ªùi gian c√≤n l·∫°i:</strong> 
                        <span style="background: #3B82F6; color: white; padding: 8px 16px; border-radius: 8px; font-weight: 600;" 
                              th:id="'timer-del-' + ${order.id}"
                              th:attr="data-delivery-time=${order.estimatedDeliveryTime},data-payment-method=${order.paymentMethod}"
                              class="countdown-timer">--:--</span>
                    </div>
                    
                    <!-- Buttons cho COD -->
                    <div th:if="${order.paymentMethod == 'COD'}" style="margin-top: 16px; display: flex; gap: 8px;">
                        <button class="btn btn-success btn-sm" 
                                th:onclick="'confirmCODPayment(' + ${order.id} + ')'"
                                style="flex: 1;">
                            <i class="fas fa-check-circle"></i> ƒê√£ nh·∫≠n ti·ªÅn
                        </button>
                        <a th:href="@{/shipper/orders/{id}/failed-delivery(id=${order.id})}" 
                           class="btn btn-danger btn-sm" style="flex: 1;">
                            <i class="fas fa-times-circle"></i> Kh√¥ng giao ƒë∆∞·ª£c
                        </a>
                    </div>
                    
                    <!-- Buttons cho QR payment (ƒë√£ thanh to√°n) -->
                    <div th:if="${order.paymentMethod != 'COD'}" style="margin-top: 16px; display: flex; gap: 8px;">
                        <button class="btn btn-success btn-sm" 
                                th:onclick="'confirmDelivery(' + ${order.id} + ')'"
                                style="flex: 1;">
                            <i class="fas fa-check-circle"></i> ƒê√£ giao th√†nh c√¥ng
                        </button>
                        <a th:href="@{/shipper/orders/{id}/failed-delivery(id=${order.id})}" 
                           class="btn btn-danger btn-sm" style="flex: 1;">
                            <i class="fas fa-times-circle"></i> Kh√¥ng giao ƒë∆∞·ª£c
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- ƒê√£ giao -->
        <div class="tab-pane fade" id="delivered-tab">
            <div th:if="${deliveredOrders.isEmpty()}" class="alert alert-info">
                <i class="fas fa-info-circle"></i> Ch∆∞a c√≥ ƒë∆°n n√†o ƒë∆∞·ª£c giao.
            </div>
            
            <div th:each="order : ${deliveredOrders}" class="order-card" style="background: white; border: 1px solid #E2E8F0; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div style="font-weight: 600; font-size: 16px;">
                        <i class="fas fa-check-circle"></i> <span th:text="${order.orderNumber}"></span>
                    </div>
                    <span style="background: #D1FAE5; color: #065F46; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">ƒê√£ giao</span>
                </div>
                <div style="color: #64748B; font-size: 14px; line-height: 1.6;">
                    <div><i class="fas fa-user"></i> <strong>Kh√°ch h√†ng:</strong> <span th:text="${order.recipientName}"></span></div>
                    <div><i class="fas fa-money-bill-wave"></i> <strong>T·ªïng ti·ªÅn:</strong> 
                        <span th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
                    </div>
                    <div><i class="fas fa-calendar"></i> <strong>Ng√†y giao:</strong> 
                        <span th:text="${#temporals.format(order.deliveredAt, 'dd/MM/yyyy HH:mm')}"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ƒê√£ tr·∫£ h√†ng -->
        <div class="tab-pane fade" id="returned-tab">
            <div th:if="${returnedOrders.isEmpty()}" class="alert alert-info">
                <i class="fas fa-info-circle"></i> Kh√¥ng c√≥ ƒë∆°n n√†o b·ªã tr·∫£ h√†ng.
            </div>
            
            <div th:each="order : ${returnedOrders}" class="order-card" style="background: white; border: 1px solid #E2E8F0; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div style="font-weight: 600; font-size: 16px;">
                        <i class="fas fa-box-open"></i> <span th:text="${order.orderNumber}"></span>
                    </div>
                    <span style="background: #E0E7FF; color: #3730A3; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">ƒê√£ tr·∫£ h√†ng</span>
                </div>
                <div style="color: #64748B; font-size: 14px; line-height: 1.6;">
                    <div><i class="fas fa-user"></i> <strong>Kh√°ch h√†ng:</strong> <span th:text="${order.recipientName}"></span></div>
                    <div><i class="fas fa-money-bill-wave"></i> <strong>T·ªïng ti·ªÅn:</strong> 
                        <span th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
                    </div>
                    <div th:if="${order.returnReason != null}">
                        <i class="fas fa-comment"></i> <strong>L√Ω do:</strong> 
                        <span th:text="${order.returnReason}"></span>
                    </div>
                    <div><i class="fas fa-calendar"></i> <strong>Ng√†y tr·∫£:</strong> 
                        <span th:text="${order.orderDate != null ? #temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm') : 'N/A'}"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ƒê√£ h·ªßy -->
        <div class="tab-pane fade" id="cancelled-tab">
            <div th:if="${cancelledOrders.isEmpty()}" class="alert alert-info">
                <i class="fas fa-info-circle"></i> B·∫°n ch∆∞a h·ªßy ƒë∆°n n√†o.
            </div>
            
            <div th:each="cancelHistory : ${cancelledOrders}" class="order-card" style="background: white; border: 1px solid #E2E8F0; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div style="font-weight: 600; font-size: 16px;">
                        <i class="fas fa-times-circle"></i> <span th:text="${cancelHistory.orderNumber}"></span>
                    </div>
                    <span th:if="${cancelHistory.orderStatus == 'Processing'}" 
                          style="background: #FEF3C7; color: #92400E; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">ƒêang x·ª≠ l√Ω (Ch·ªù shipper kh√°c)</span>
                    <span th:if="${cancelHistory.orderStatus == 'Cancelled'}" 
                          style="background: #FEE2E2; color: #991B1B; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">ƒê√£ h·ªßy</span>
                </div>
                <div style="color: #64748B; font-size: 14px; line-height: 1.6;">
                    <div><i class="fas fa-user"></i> <strong>Kh√°ch h√†ng:</strong> <span th:text="${cancelHistory.recipientName}"></span></div>
                    <div><i class="fas fa-money-bill-wave"></i> <strong>T·ªïng ti·ªÅn:</strong> 
                        <span th:text="${#numbers.formatDecimal(cancelHistory.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
                    </div>
                    <div><i class="fas fa-calendar"></i> <strong>Ng√†y h·ªßy:</strong> 
                        <span th:text="${#temporals.format(cancelHistory.cancelledAt, 'dd/MM/yyyy HH:mm')}"></span>
                    </div>
                    <div th:if="${cancelHistory.reason != null}" style="margin-top: 8px; padding: 12px; background: #FEF2F2; border-left: 4px solid #DC2626; border-radius: 4px;">
                        <i class="fas fa-comment"></i> <strong>L√Ω do h·ªßy:</strong><br/>
                        <span th:text="${cancelHistory.reason}"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Confirm COD Payment
        function confirmCODPayment(orderId) {
            if (!confirm('ƒê√£ nh·∫≠n ƒë·ªß ti·ªÅn t·ª´ kh√°ch h√†ng?')) return;
            
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
            
            const headers = {};
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }
            
            fetch('/UTE_Fashion/shipper/orders/' + orderId + '/confirm-payment', {
                method: 'POST',
                headers: headers,
                credentials: 'include'
            })
            .then(response => response.text())
            .then(result => {
                if (result === 'Success') {
                    alert('ƒê√£ x√°c nh·∫≠n giao h√†ng th√†nh c√¥ng!');
                    if (typeof loadContent === 'function') {
                        loadContent('delivering');
                    } else {
                        location.reload();
                    }
                } else {
                    alert('L·ªói: ' + result);
                }
            })
            .catch(error => {
                alert('L·ªói k·∫øt n·ªëi: ' + error);
            });
        }
        
        // Confirm Delivery (for already paid orders)
        function confirmDelivery(orderId) {
            if (!confirm('ƒê√£ giao h√†ng th√†nh c√¥ng?')) return;
            
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.content;
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content;
            
            const headers = {};
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }
            
            fetch('/UTE_Fashion/shipper/orders/' + orderId + '/complete', {
                method: 'POST',
                headers: headers,
                credentials: 'include'
            })
            .then(response => response.text())
            .then(result => {
                if (result === 'Success') {
                    alert('ƒê√£ x√°c nh·∫≠n giao h√†ng th√†nh c√¥ng!');
                    if (typeof loadContent === 'function') {
                        loadContent('delivering');
                    } else {
                        location.reload();
                    }
                } else {
                    alert('L·ªói: ' + result);
                }
            })
            .catch(error => {
                alert('L·ªói k·∫øt n·ªëi: ' + error);
            });
        }
        
        // Start countdown timers for all delivering orders
        (function() {
            document.querySelectorAll('.countdown-timer[data-delivery-time]').forEach(function(timerEl) {
                const orderId = timerEl.id.replace('timer-del-', '');
                const deliveryTime = new Date(timerEl.getAttribute('data-delivery-time')).getTime();
                const paymentMethod = timerEl.getAttribute('data-payment-method');
                
                const interval = setInterval(function() {
                    const now = new Date().getTime();
                    const distance = deliveryTime - now;
                    
                    if (distance < 0) {
                        clearInterval(interval);
                        // Hi·ªÉn th·ªã th√¥ng b√°o h·∫øt gi·ªù cho c·∫£ COD v√† QR, shipper ph·∫£i x√°c nh·∫≠n th·ªß c√¥ng
                        timerEl.textContent = 'H·∫øt gi·ªù! Vui l√≤ng x√°c nh·∫≠n';
                        timerEl.style.background = '#EF4444';
                        return;
                    }
                    
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    timerEl.textContent = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
                }, 1000);
            });
        })();
    </script>
</div>
