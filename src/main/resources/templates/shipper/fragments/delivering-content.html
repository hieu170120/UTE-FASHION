<!-- ƒê∆°n ƒëang giao - Delivering Content Fragment -->
<div xmlns:th="http://www.thymeleaf.org">
    <h2 style="margin-bottom: 24px; font-weight: 700; color: #1E293B;">üöö ƒê∆°n ƒëang giao & ƒê√£ ho√†n th√†nh</h2>

    <!-- Filter Tabs -->
    <ul class="nav nav-tabs mb-4">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#delivering-tab">
                <i class="fas fa-shipping-fast"></i> ƒêang giao (<span th:text="${deliveringOrders.size()}">0</span>)
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#delivered-tab">
                <i class="fas fa-check-circle"></i> ƒê√£ giao (<span th:text="${deliveredOrders.size()}">0</span>)
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#returned-tab">
                <i class="fas fa-undo"></i> ƒê√£ tr·∫£ h√†ng (<span th:text="${returnedOrders.size()}">0</span>)
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#cancelled-tab">
                <i class="fas fa-times-circle"></i> ƒê√£ h·ªßy (<span th:text="${cancelledOrders.size()}">0</span>)
            </a>
        </li>
    </ul>

    <div class="tab-content">
        <!-- ƒêang giao -->
        <div class="tab-pane fade show active" id="delivering-tab">
            <div th:if="${deliveringOrders.isEmpty()}" class="alert alert-info">
                <i class="fas fa-info-circle"></i> Kh√¥ng c√≥ ƒë∆°n ƒëang giao.
            </div>
            
            <div th:each="order : ${deliveringOrders}" class="order-card" style="background: white; border: 1px solid #E2E8F0; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div style="font-weight: 600; font-size: 16px;">
                        <i class="fas fa-truck"></i> <span th:text="${order.orderNumber}"></span>
                    </div>
                    <span style="background: #DBEAFE; color: #1E40AF; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">ƒêang giao</span>
                </div>
                <div style="color: #64748B; font-size: 14px; line-height: 1.6;">
                    <div><i class="fas fa-user"></i> <strong>Kh√°ch h√†ng:</strong> <span th:text="${order.recipientName}"></span></div>
                    <div><i class="fas fa-phone"></i> <strong>SƒêT:</strong> <span th:text="${order.phoneNumber}"></span></div>
                    <div><i class="fas fa-map-marker-alt"></i> <strong>ƒê·ªãa ch·ªâ:</strong> <span th:text="${order.shippingAddress}"></span></div>
                    <div><i class="fas fa-money-bill-wave"></i> <strong>T·ªïng ti·ªÅn:</strong> 
                        <span th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
                    </div>
                    <div style="margin-top: 12px;">
                        <i class="fas fa-clock"></i> <strong>Th·ªùi gian c√≤n l·∫°i:</strong> 
                        <span style="background: #3B82F6; color: white; padding: 8px 16px; border-radius: 8px; font-weight: 600;" 
                              th:id="'timer-del-' + ${order.id}"
                              th:attr="data-delivery-time=${order.estimatedDeliveryTime}"
                              class="countdown-timer">--:--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ƒê√£ giao -->
        <div class="tab-pane fade" id="delivered-tab">
            <div th:if="${deliveredOrders.isEmpty()}" class="alert alert-info">
                <i class="fas fa-info-circle"></i> Ch∆∞a c√≥ ƒë∆°n n√†o ƒë∆∞·ª£c giao.
            </div>
            
            <div th:each="order : ${deliveredOrders}" class="order-card" style="background: white; border: 1px solid #E2E8F0; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div style="font-weight: 600; font-size: 16px;">
                        <i class="fas fa-check-circle"></i> <span th:text="${order.orderNumber}"></span>
                    </div>
                    <span style="background: #D1FAE5; color: #065F46; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">ƒê√£ giao</span>
                </div>
                <div style="color: #64748B; font-size: 14px; line-height: 1.6;">
                    <div><i class="fas fa-user"></i> <strong>Kh√°ch h√†ng:</strong> <span th:text="${order.recipientName}"></span></div>
                    <div><i class="fas fa-money-bill-wave"></i> <strong>T·ªïng ti·ªÅn:</strong> 
                        <span th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
                    </div>
                    <div><i class="fas fa-calendar"></i> <strong>Ng√†y giao:</strong> 
                        <span th:text="${#temporals.format(order.deliveredAt, 'dd/MM/yyyy HH:mm')}"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ƒê√£ tr·∫£ h√†ng -->
        <div class="tab-pane fade" id="returned-tab">
            <div th:if="${returnedOrders.isEmpty()}" class="alert alert-info">
                <i class="fas fa-info-circle"></i> Kh√¥ng c√≥ ƒë∆°n n√†o b·ªã tr·∫£ h√†ng.
            </div>
            
            <div th:each="order : ${returnedOrders}" class="order-card" style="background: white; border: 1px solid #E2E8F0; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div style="font-weight: 600; font-size: 16px;">
                        <i class="fas fa-box-open"></i> <span th:text="${order.orderNumber}"></span>
                    </div>
                    <span style="background: #E0E7FF; color: #3730A3; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">ƒê√£ tr·∫£ h√†ng</span>
                </div>
                <div style="color: #64748B; font-size: 14px; line-height: 1.6;">
                    <div><i class="fas fa-user"></i> <strong>Kh√°ch h√†ng:</strong> <span th:text="${order.recipientName}"></span></div>
                    <div><i class="fas fa-money-bill-wave"></i> <strong>T·ªïng ti·ªÅn:</strong> 
                        <span th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
                    </div>
                    <div th:if="${order.returnReason != null}">
                        <i class="fas fa-comment"></i> <strong>L√Ω do:</strong> 
                        <span th:text="${order.returnReason}"></span>
                    </div>
                    <div><i class="fas fa-calendar"></i> <strong>Ng√†y tr·∫£:</strong> 
                        <span th:text="${order.orderDate != null ? #temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm') : 'N/A'}"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ƒê√£ h·ªßy -->
        <div class="tab-pane fade" id="cancelled-tab">
            <div th:if="${cancelledOrders.isEmpty()}" class="alert alert-info">
                <i class="fas fa-info-circle"></i> Kh√¥ng c√≥ ƒë∆°n n√†o b·ªã h·ªßy.
            </div>
            
            <div th:each="order : ${cancelledOrders}" class="order-card" style="background: white; border: 1px solid #E2E8F0; border-radius: 12px; padding: 20px; margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <div style="font-weight: 600; font-size: 16px;">
                        <i class="fas fa-times-circle"></i> <span th:text="${order.orderNumber}"></span>
                    </div>
                    <span style="background: #FEE2E2; color: #991B1B; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">ƒê√£ h·ªßy</span>
                </div>
                <div style="color: #64748B; font-size: 14px; line-height: 1.6;">
                    <div><i class="fas fa-user"></i> <strong>Kh√°ch h√†ng:</strong> <span th:text="${order.recipientName}"></span></div>
                    <div><i class="fas fa-calendar"></i> <strong>Ng√†y h·ªßy:</strong> 
                        <span th:text="${#temporals.format(order.cancelledAt, 'dd/MM/yyyy HH:mm')}"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Start countdown timers for all delivering orders
        (function() {
            document.querySelectorAll('.countdown-timer[data-delivery-time]').forEach(function(timerEl) {
                const orderId = timerEl.id.replace('timer-del-', '');
                const deliveryTime = new Date(timerEl.getAttribute('data-delivery-time')).getTime();
                
                const interval = setInterval(function() {
                    const now = new Date().getTime();
                    const distance = deliveryTime - now;
                    
                    if (distance < 0) {
                        clearInterval(interval);
                        timerEl.textContent = 'ƒê√£ giao!';
                        timerEl.style.background = '#10B981';
                        
                        // Auto complete delivery
                        fetch('/UTE_Fashion/shipper/orders/' + orderId + '/complete', {
                            method: 'POST'
                        }).then(() => {
                            setTimeout(() => {
                                if (typeof loadContent === 'function') {
                                    loadContent('delivering');
                                } else {
                                    location.reload();
                                }
                            }, 2000);
                        });
                        return;
                    }
                    
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    timerEl.textContent = minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
                }, 1000);
            });
        })();
    </script>
</div>
