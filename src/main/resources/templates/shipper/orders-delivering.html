<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đơn Đang Giao</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .order-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            padding: 25px;
            margin-bottom: 20px;
        }
        .countdown-timer {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
        }
        .countdown-timer.warning { color: #ff6b6b; animation: pulse 1s infinite; }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .delivered-badge {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 24px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="bg-white rounded p-3 mb-4">
            <h2><i class="fas fa-shipping-fast text-primary"></i> Đơn Đang Giao</h2>
        </div>

        <!-- Empty State -->
        <div th:if="${#lists.isEmpty(deliveringOrders)}" class="text-center py-5">
            <div class="bg-white rounded p-5">
                <i class="fas fa-box-open fa-5x text-muted mb-3"></i>
                <h4 class="text-muted">Chưa có đơn nào đang giao</h4>
                <a href="/shipper/orders/assigned" class="btn btn-primary mt-3">
                    <i class="fas fa-list"></i> Xem Đơn Được Giao
                </a>
            </div>
        </div>

        <!-- Delivering Orders -->
        <div th:each="order : ${deliveringOrders}" class="order-card">
            <div class="row">
                <div class="col-md-7">
                    <h4><i class="fas fa-receipt text-success"></i> <span th:text="${order.orderNumber}"></span></h4>
                    <hr>
                    <p><strong>Khách hàng:</strong> <span th:text="${order.recipientName}"></span></p>
                    <p><strong>Địa chỉ:</strong> <span th:text="${order.shippingAddress}"></span></p>
                    <p><strong>SĐT:</strong> <span th:text="${order.phoneNumber}"></span></p>
                    <p><strong>Tổng tiền:</strong> 
                        <span class="text-danger fw-bold fs-5" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' ₫'"></span>
                    </p>
                </div>
                <div class="col-md-5">
                    <!-- Đồng hồ đếm ngược -->
                    <div th:if="${order.estimatedDeliveryTime}" 
                         class="countdown-timer"
                         th:attr="data-target=${order.estimatedDeliveryTime}"
                         th:data-order-id="${order.id}">
                        <div class="countdown-display">
                            <span class="minutes">00</span>:<span class="seconds">00</span>
                        </div>
                        <small class="d-block mt-2 text-muted">Thời gian giao còn lại</small>
                    </div>

                    <!-- Badge đã giao (sẽ hiện khi hết giờ) -->
                    <div class="delivered-badge d-none" th:id="'delivered-' + ${order.id}">
                        <i class="fas fa-check-circle"></i> Đã Giao Thành Công!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const timers = document.querySelectorAll('.countdown-timer');
            
            timers.forEach(timer => {
                const targetTime = new Date(timer.dataset.target);
                const orderId = timer.dataset.orderId;
                
                function updateCountdown() {
                    const now = new Date();
                    const diff = targetTime - now;
                    
                    if (diff <= 0) {
                        // Hết giờ - Hiển thị badge đã giao
                        timer.classList.add('d-none');
                        document.getElementById('delivered-' + orderId).classList.remove('d-none');
                        
                        // Reload sau 2 giây để cập nhật trạng thái
                        setTimeout(() => location.reload(), 2000);
                        return;
                    }
                    
                    const minutes = Math.floor(diff / 1000 / 60);
                    const seconds = Math.floor((diff / 1000) % 60);
                    
                    timer.querySelector('.minutes').textContent = String(minutes).padStart(2, '0');
                    timer.querySelector('.seconds').textContent = String(seconds).padStart(2, '0');
                    
                    // Warning khi còn < 1 phút
                    if (diff < 60000) {
                        timer.classList.add('warning');
                    }
                }
                
                updateCountdown();
                setInterval(updateCountdown, 1000);
            });
        });
    </script>
</body>
</html>
