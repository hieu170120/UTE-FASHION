================================================================================
HÆ¯á»šNG DáºªN TRIá»‚N KHAI CHá»¨C NÄ‚NG QUáº¢N LÃ CHIáº¾T KHáº¤U (COMMISSION MANAGEMENT)
================================================================================

NGÃ€Y: 24/10/2025
NGÆ¯á»œI PHÃT TRIá»‚N: Admin / Hiáº¿u
TRáº NG THÃI: HoÃ n táº¥t

================================================================================
1. Tá»”NG QUAN CHá»¨C NÄ‚NG
================================================================================

Chá»©c nÄƒng "Quáº£n lÃ½ chiáº¿t kháº¥u" cho phÃ©p Admin thiáº¿t láº­p % chiáº¿t kháº¥u cho tá»«ng 
shop (cá»­a hÃ ng). Chiáº¿t kháº¥u nÃ y sáº½ Ä‘Æ°á»£c sá»­ dá»¥ng trong há»‡ thá»‘ng thanh toÃ¡n vÃ  
bÃ¡o cÃ¡o doanh thu cá»§a shop.

QUá»€N TRUY Cáº¬P: Chá»‰ Admin cÃ³ thá»ƒ cáº­p nháº­t chiáº¿t kháº¥u cho shop
ENDPOINT API: PUT /admin/shops/{id}/commission

================================================================================
2. CÃC THAY Äá»”I TRONG CÆ  Sá» Dá»® LIá»†U
================================================================================

2.1 Táº¡o cá»™t má»›i trong báº£ng Shops:
   - TÃªn cá»™t: commission_percentage
   - Kiá»ƒu dá»¯ liá»‡u: DECIMAL(5, 2)
   - GiÃ¡ trá»‹ máº·c Ä‘á»‹nh: 0.00
   - KhÃ´ng Ä‘Æ°á»£c NULL

2.2 Migration file:
   - ÄÆ°á»ng dáº«n: database/migration_add_commission_percentage.sql
   - Ná»™i dung: ThÃªm cá»™t commission_percentage vÃ o báº£ng Shops
   - Index: idx_shops_commission_percentage (tÃ¹y chá»n, Ä‘á»ƒ tá»‘i Æ°u truy váº¥n)

2.3 Thá»±c hiá»‡n migration:
   Cháº¡y script sau trÃªn database:
   
   ALTER TABLE Shops
   ADD COLUMN commission_percentage DECIMAL(5, 2) DEFAULT 0.00 NOT NULL;

================================================================================
3. CÃC THAY Äá»”I TRONG BACKEND
================================================================================

3.1 ENTITY - src/main/java/com/example/demo/entity/Shop.java
   - ThÃªm field: private BigDecimal commissionPercentage
   - Annotation: @Column(name = "commission_percentage", precision = 5, scale = 2)
   - GiÃ¡ trá»‹ máº·c Ä‘á»‹nh: new BigDecimal("0.00")

3.2 DTO - src/main/java/com/example/demo/dto/ShopDTO.java
   - ThÃªm field: private BigDecimal commissionPercentage
   - DÃ¹ng @Data tá»« Lombok Ä‘á»ƒ tá»± Ä‘á»™ng generate getter/setter

3.3 DTO - src/main/java/com/example/demo/dto/CommissionRequest.java (Äá»ŒC)
   - Lá»›p má»›i Ä‘á»ƒ nháº­n request tá»« client
   - Fields: 
     * commissionPercentage: BigDecimal (chiáº¿t kháº¥u %)
     * reason: String (lÃ½ do thay Ä‘á»•i - tÃ¹y chá»n)

3.4 SERVICE INTERFACE - src/main/java/com/example/demo/service/ShopService.java
   - ThÃªm method: ShopDTO updateShopCommission(Integer shopId, BigDecimal commissionPercentage)

3.5 SERVICE IMPL - src/main/java/com/example/demo/service/impl/ShopServiceImpl.java
   - Implement updateShopCommission():
     * TÃ¬m shop theo ID
     * Validate chiáº¿t kháº¥u (0-100%)
     * Cáº­p nháº­t giÃ¡ trá»‹
     * LÆ°u vÃ o DB
     * Tráº£ vá» ShopDTO cáº­p nháº­t
   - Exception handling:
     * ResourceNotFoundException: Náº¿u shop khÃ´ng tá»“n táº¡i
     * IllegalArgumentException: Náº¿u chiáº¿t kháº¥u khÃ´ng há»£p lá»‡

3.6 CONTROLLER - src/main/java/com/example/demo/controller/admin/AdminController.java
   - Endpoint: @PutMapping("/{id}/commission")
   - URL: PUT /admin/shops/{id}/commission
   - Request body: CommissionRequest (JSON)
   - Response: ApiResponse {status, message, data}
   - Xá»­ lÃ½ lá»—i: Tráº£ vá» 400 (Bad Request) hoáº·c 500 (Internal Server Error)

================================================================================
4. CÃC THAY Äá»”I TRONG FRONTEND
================================================================================

4.1 Trang Danh sÃ¡ch Shop - src/main/resources/templates/admin/shops/list.html
   - ThÃªm cá»™t "Chiáº¿t kháº¥u (%)" trong báº£ng
   - Hiá»ƒn thá»‹ giÃ¡ trá»‹ commission_percentage dáº¡ng badge
   - ThÃªm button "Chiáº¿t kháº¥u" Ä‘á»ƒ má»Ÿ modal

4.2 Modal Cáº­p nháº­t Chiáº¿t kháº¥u
   - ID: #commissionModal
   - Fields:
     * TÃªn Shop (read-only)
     * Chiáº¿t kháº¥u (%) - sá»‘ input, range 0-100, step 0.01
   - Buttons: "Há»§y" vÃ  "LÆ°u"

4.3 JavaScript
   - Function openCommissionModal(): Má»Ÿ modal vÃ  Ä‘iá»n dá»¯ liá»‡u tá»« button
   - Function saveCommission(): 
     * Validate dá»¯ liá»‡u
     * Gá»i API PUT /admin/shops/{id}/commission
     * Reload trang náº¿u thÃ nh cÃ´ng
     * Hiá»ƒn thá»‹ error message náº¿u tháº¥t báº¡i

================================================================================
5. HÆ¯á»šNG DáºªN Sá»¬ Dá»¤NG
================================================================================

5.1 Tá»« giao diá»‡n Admin:
   1. ÄÄƒng nháº­p vá»›i tÃ i khoáº£n Admin
   2. VÃ o menu "Quáº£n lÃ½ Cá»­a hÃ ng" â†’ "Danh sÃ¡ch Shop"
   3. Nháº¥n nÃºt "Chiáº¿t kháº¥u" trÃªn hÃ ng cá»§a shop cáº§n cáº­p nháº­t
   4. Nháº­p % chiáº¿t kháº¥u mong muá»‘n (0-100)
   5. Nháº¥n "LÆ°u"
   6. Chá» thÃ´ng bÃ¡o thÃ nh cÃ´ng vÃ  trang sáº½ reload

5.2 Tá»« API (curl):
   curl -X PUT http://localhost:8080/admin/shops/1/commission \
     -H "Content-Type: application/json" \
     -d '{"commissionPercentage": 15.50, "reason": "TÄƒng Ä‘á»ƒ khuyáº¿n khÃ­ch"}'

5.3 Tá»« API (Postman):
   - Method: PUT
   - URL: http://localhost:8080/admin/shops/{id}/commission
   - Header: Content-Type: application/json
   - Body (raw JSON):
     {
       "commissionPercentage": 15.50,
       "reason": "LÃ½ do tÃ¹y chá»n"
     }

================================================================================
6. VALIDATION & ERROR HANDLING
================================================================================

6.1 Validation Rules:
   - commissionPercentage pháº£i >= 0%
   - commissionPercentage pháº£i <= 100%
   - Shop pháº£i tá»“n táº¡i

6.2 HTTP Status Code:
   - 200 OK: Cáº­p nháº­t thÃ nh cÃ´ng
   - 400 Bad Request: Chiáº¿t kháº¥u khÃ´ng há»£p lá»‡
   - 404 Not Found: Shop khÃ´ng tá»“n táº¡i (tÃ¹y tuá»³)
   - 500 Internal Server Error: Lá»—i server

6.3 Response Format:
   Success (200):
   {
     "status": "success",
     "message": "Cáº­p nháº­t chiáº¿t kháº¥u thÃ nh cÃ´ng",
     "data": {
       "id": 1,
       "shopName": "Shop A",
       "commissionPercentage": 15.50,
       ...
     }
   }

   Error (400):
   {
     "status": "error",
     "message": "Chiáº¿t kháº¥u pháº£i náº±m trong khoáº£ng 0-100%",
     "data": null
   }

================================================================================
7. CÃCH Sá»¬ Dá»¤NG CHO DEVELOPERS
================================================================================

7.1 Inject Service:
   @Autowired
   private ShopService shopService;

7.2 Gá»i Service:
   BigDecimal commission = new BigDecimal("15.50");
   ShopDTO updatedShop = shopService.updateShopCommission(shopId, commission);

7.3 Xá»­ lÃ½ Exception:
   try {
       ShopDTO updatedShop = shopService.updateShopCommission(shopId, commission);
   } catch (ResourceNotFoundException ex) {
       // Shop khÃ´ng tÃ¬m tháº¥y
   } catch (IllegalArgumentException ex) {
       // Chiáº¿t kháº¥u khÃ´ng há»£p lá»‡
   }

================================================================================
8. TEST CASES
================================================================================

8.1 Test Case 1: Cáº­p nháº­t chiáº¿t kháº¥u há»£p lá»‡
   - Input: shopId=1, commission=15.50
   - Expected: Cáº­p nháº­t thÃ nh cÃ´ng, tráº£ vá» 200 OK

8.2 Test Case 2: Chiáº¿t kháº¥u Ã¢m
   - Input: shopId=1, commission=-5.00
   - Expected: Tráº£ vá» 400 Bad Request

8.3 Test Case 3: Chiáº¿t kháº¥u > 100%
   - Input: shopId=1, commission=150.00
   - Expected: Tráº£ vá» 400 Bad Request

8.4 Test Case 4: Shop khÃ´ng tá»“n táº¡i
   - Input: shopId=9999, commission=15.50
   - Expected: Tráº£ vá» 404 hoáº·c 500

8.5 Test Case 5: Cáº­p nháº­t thÃ nh 0%
   - Input: shopId=1, commission=0.00
   - Expected: Cáº­p nháº­t thÃ nh cÃ´ng

================================================================================
9. CÃ“ THá»‚ Má» Rá»˜NG TRONG TÆ¯Æ NG LAI
================================================================================

9.1 ThÃªm loáº¡i chiáº¿t kháº¥u khÃ¡c nhau:
   - Chiáº¿t kháº¥u theo danh má»¥c sáº£n pháº©m
   - Chiáº¿t kháº¥u theo Ä‘Æ¡n hÃ ng
   - Chiáº¿t kháº¥u theo khÃ¡ch hÃ ng

9.2 Lá»‹ch sá»­ thay Ä‘á»•i chiáº¿t kháº¥u:
   - Báº£ng CommissionHistory
   - Log ai, khi nÃ o, thay Ä‘á»•i tá»« bao nhiÃªu sang bao nhiÃªu

9.3 TÃ­nh toÃ¡n tá»± Ä‘á»™ng:
   - TÃ­nh chiáº¿t kháº¥u dá»±a trÃªn hiá»‡u suáº¥t shop
   - Tá»± Ä‘á»™ng Ä‘iá»u chá»‰nh theo tá»«ng ká»³

9.4 Report & Analytics:
   - BÃ¡o cÃ¡o chiáº¿t kháº¥u hÃ ng thÃ¡ng
   - So sÃ¡nh hiá»‡u suáº¥t cÃ¡c shop vá»›i cÃ¹ng má»©c chiáº¿t kháº¥u

================================================================================
10. CÃCH Sá»¬ Dá»¤NG CHO DEVELOPERS
================================================================================

7.1 Inject Service:
   @Autowired
   private ShopService shopService;

7.2 Gá»i Service:
   BigDecimal commission = new BigDecimal("15.50");
   ShopDTO updatedShop = shopService.updateShopCommission(shopId, commission);

7.3 Xá»­ lÃ½ Exception:
   try {
       ShopDTO updatedShop = shopService.updateShopCommission(shopId, commission);
   } catch (ResourceNotFoundException ex) {
       // Shop khÃ´ng tÃ¬m tháº¥y
   } catch (IllegalArgumentException ex) {
       // Chiáº¿t kháº¥u khÃ´ng há»£p lá»‡
   }

================================================================================
11. CHIáº¾N LÆ¯á»¢C ÃP Dá»¤NG CHIáº¾T KHáº¤U KHI ÄÆ N HÃ€NG THÃ€NH CÃ”NG
================================================================================

PHáº¦N NÃ€Y CHI TIáº¾T CÃC BÆ¯á»šC TRIá»‚N KHAI TÃNH TOÃN VÃ€ LÆ¯U TRá»® CHIáº¾T KHáº¤U

ğŸ“‹ Tá»”NG QUÃT WORKFLOW:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. KHÃCH HÃ€NG Äáº¶T HÃ€NG + THANH TOÃN
   â†“
2. Há»† THá»NG Táº O ORDER Vá»šI Tá»”NG TIá»€N (totalAmount)
   â†“
3. SHIPPER GIAO HÃ€NG (Status: SHIPPING)
   â†“
4. KHÃCH NHáº¬N HÃ€NG âœ“ (Status: DELIVERED) â† ÄIá»‚M KÃCH HOáº T TÃNH CHIáº¾T KHáº¤U
   â†“
5. TÃNH TOÃN CHIáº¾T KHáº¤U Dá»°A TRÃŠN COMMISSION_PERCENTAGE
   â†“
6. LÆ¯U VÃ€O SHOPANALYTICS & TRá»ª Tá»ª TIá»€N SHOP NHáº¬N
   â†“
7. Cáº¬P NHáº¬T DASHBOARD CHO ADMIN & SHOP OWNER


ğŸ“ IMPLEMENTATION DETAILS - Tá»ªNG BÆ¯á»šC CHI TIáº¾T
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

BÆ¯á»šC 1: ÄIá»‚M KÃCH HOáº T - PHÃT HIá»†N ÄÆ N HÃ€NG DELIVERED
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Vá»‹ trÃ­: OrderServiceImpl.java - HÃ m updateOrderStatus()
KÃ­ch hoáº¡t khi: Order chuyá»ƒn tá»« SHIPPING â†’ DELIVERED

```java
@Override
@Transactional
public OrderDTO updateOrderStatus(Integer orderId, String newStatus, 
                                  String notes, Integer changedBy) {
    Order order = orderRepository.findById(orderId)
        .orElseThrow(() -> new ResourceNotFoundException("Order not found"));
    
    String oldStatus = order.getOrderStatus();
    
    // Cáº­p nháº­t tráº¡ng thÃ¡i
    order.setOrderStatus(newStatus);
    order.setDeliveredAt(LocalDateTime.now());
    
    // ğŸ”¥ KÃCH HOáº T TÃNH CHIáº¾T KHáº¤U KHI DELIVERED
    if ("DELIVERED".equals(newStatus) && 
        !"DELIVERED".equals(oldStatus)) {
        
        // Gá»i service tÃ­nh toÃ¡n chiáº¿t kháº¥u
        dailyAnalyticsService.updateDailyAnalyticsForOrder(order);
        logger.info("âœ… Commission calculation triggered for order: {}", orderId);
    }
    
    // ... cÃ¡c xá»­ lÃ½ khÃ¡c ...
    return mapToOrderDTO(order);
}
```

BÆ¯á»šC 2: TÃNH TOÃN CHIáº¾T KHáº¤U
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Vá»‹ trÃ­: DailyAnalyticsServiceImpl.java - HÃ m updateShopAnalytics()
ÄÃ£ triá»ƒn khai sáºµn! (Xem chi tiáº¿t trong mÃ£ nguá»“n)

CÃ´ng thá»©c:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ commissionAmount = totalAmount Ã— commissionPercentage / 100 â”‚
â”‚ shopNetRevenue = totalAmount - commissionAmount             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Code logic:
```java
private void updateShopAnalytics(Integer shopId, LocalDate date, Order order) {
    // TÃ¬m hoáº·c táº¡o ShopAnalytics cho ngÃ y hÃ´m nay
    ShopAnalytics analytics = findOrCreateShopAnalytics(shopId, date, order);
    
    // Cá»™ng doanh thu
    analytics.setTotalRevenue(
        analytics.getTotalRevenue().add(order.getTotalAmount())
    );
    analytics.setTotalOrders(analytics.getTotalOrders() + 1);
    
    // ğŸ†• TÃNH CHIáº¾T KHáº¤U
    Shop shop = order.getShop();
    if (shop != null && shop.getCommissionPercentage() != null) {
        BigDecimal commissionPercentage = shop.getCommissionPercentage();
        
        // TÃ­nh tiá»n chiáº¿t kháº¥u cho Ä‘Æ¡n hÃ ng nÃ y
        BigDecimal commissionAmount = order.getTotalAmount()
            .multiply(commissionPercentage)
            .divide(new BigDecimal("100"), 2, RoundingMode.HALF_UP);
        
        // TÃ­nh tiá»n shop thá»±c nháº­n
        BigDecimal shopNetRevenue = order.getTotalAmount()
            .subtract(commissionAmount);
        
        // Cá»™ng dá»“n vÃ o ShopAnalytics hÃ´m nay
        analytics.setCommissionPercentage(commissionPercentage);
        analytics.setCommissionAmount(
            (analytics.getCommissionAmount() != null ? 
             analytics.getCommissionAmount() : BigDecimal.ZERO)
            .add(commissionAmount)
        );
        analytics.setShopNetRevenue(
            (analytics.getShopNetRevenue() != null ? 
             analytics.getShopNetRevenue() : BigDecimal.ZERO)
            .add(shopNetRevenue)
        );
    }
    
    shopAnalyticsRepository.save(analytics);
}
```

BÆ¯á»šC 3: LÆ¯U CHIáº¾T KHáº¤U VÃ€O DATABASE
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Báº£ng: ShopAnalytics
Báº£n ghi lÆ°u nhá»¯ng thÃ´ng tin sau:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ShopAnalytics Record                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ analytics_id:         1001          â”‚
â”‚ shop_id:              1             â”‚
â”‚ period_type:          'DAY'         â”‚
â”‚ period_start:         2025-10-24    â”‚
â”‚ period_end:           2025-10-24    â”‚
â”‚ total_revenue:        400.000 Ä‘     â”‚  â† Doanh thu ghi nháº­n
â”‚ total_orders:         1             â”‚  â† Sá»‘ Ä‘Æ¡n hÃ ng
â”‚ commission_percentage: 10.00%       â”‚  â† Tá»· lá»‡ chiáº¿t kháº¥u
â”‚ commission_amount:    40.000 Ä‘      â”‚  â† Tiá»n chiáº¿t kháº¥u
â”‚ shop_net_revenue:     360.000 Ä‘     â”‚  â† Tiá»n shop nháº­n
â”‚ growth_percent:       0%            â”‚
â”‚ created_at:           2025-10-24    â”‚
â”‚ updated_at:           2025-10-24    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

BÆ¯á»šC 4: Sá»¬ Dá»¤NG CHIáº¾T KHáº¤U CHO CÃC Má»¤C ÄÃCH
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. DASHBOARD ADMIN: Xem tiá»n chiáº¿t kháº¥u láº¥y Ä‘Æ°á»£c
   - Tá»•ng tiá»n tá»« táº¥t cáº£ orders
   - Tá»•ng chiáº¿t kháº¥u hÃ´m nay
   - Danh sÃ¡ch cÃ¡c shop vÃ  chiáº¿t kháº¥u tá»«ng shop

2. DASHBOARD SHOP OWNER: Xem tiá»n thá»±c nháº­n
   - Doanh thu ghi nháº­n: 400.000 Ä‘
   - Trá»« chiáº¿t kháº¥u: -40.000 Ä‘
   - Tiá»n cÃ³ thá»ƒ rÃºt: 360.000 Ä‘

3. BÃNG CÃO & ANALYTICS:
   - TÃ­nh tá»‘c Ä‘á»™ phÃ¡t triá»ƒn (growth%)
   - So sÃ¡nh hiá»‡u suáº¥t shop
   - BÃ¡o cÃ¡o doanh thu theo giai Ä‘oáº¡n (DAY, WEEK, MONTH)

4. TÃNH TIá»€N RÃšT:
   - Tiá»n rÃºt = ShopNetRevenue - (Sá»‘ tiá»n Ä‘Ã£ rÃºt trÆ°á»›c Ä‘Ã¢y)


ğŸ“Š Báº¢NG Sá»¬ LÃ TOÃ€N QUY TRÃŒNH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Giáº£ sá»­: Shop A cÃ³ commission 10%, khÃ¡ch thanh toÃ¡n 400.000 Ä‘

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BÆ¯á»šC 1: KHÃCH HÃ€NG THANH TOÃN 400.000 Ä‘                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Order.totalAmount = 400.000 Ä‘ âœ“                             â”‚
â”‚ Order.status = "PROCESSING"                                 â”‚
â”‚ Chiáº¿t kháº¥u chÆ°a tÃ­nh                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BÆ¯á»šC 2: KHÃCH NHáº¬N HÃ€NG THÃ€NH CÃ”NG                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Order.status = "DELIVERED" âœ“ â† KÃCH HOáº T TÃNH CHIáº¾T KHáº¤U   â”‚
â”‚ Order.deliveredAt = 2025-10-24 14:00:00                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BÆ¯á»šC 3: Há»† THá»NG TÃNH CHIáº¾T KHáº¤U                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ commissionAmount = 400.000 Ã— 10% / 100 = 40.000 Ä‘           â”‚
â”‚ shopNetRevenue = 400.000 - 40.000 = 360.000 Ä‘               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BÆ¯á»šC 4: LÆ¯U VÃ€O SHOPANALYTICS                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ShopAnalytics.totalRevenue += 400.000 Ä‘                     â”‚
â”‚ ShopAnalytics.commissionAmount += 40.000 Ä‘                  â”‚
â”‚ ShopAnalytics.shopNetRevenue += 360.000 Ä‘                   â”‚
â”‚ ShopAnalytics.totalOrders += 1                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BÆ¯á»šC 5: HIá»‚N THá»Š TRÃŠN DASHBOARD                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ADMIN XEM:                                                   â”‚
â”‚ â”œâ”€ HÃ´m nay Platform láº¥y: 40.000 Ä‘ (tá»« commission)           â”‚
â”‚ â”œâ”€ Shop A doanh thu: 400.000 Ä‘                              â”‚
â”‚ â””â”€ Shop A thá»±c nháº­n: 360.000 Ä‘                              â”‚
â”‚                                                              â”‚
â”‚ SHOP OWNER XEM:                                              â”‚
â”‚ â”œâ”€ Doanh thu ghi nháº­n: 400.000 Ä‘                            â”‚
â”‚ â”œâ”€ Trá»« chiáº¿t kháº¥u: -40.000 Ä‘                                â”‚
â”‚ â””â”€ CÃ³ thá»ƒ rÃºt: 360.000 Ä‘                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜


ğŸ”§ CÃC TRÆ¯á»œNG Há»¢P Äáº¶C BIá»†T Cáº¦N Xá»¬ LÃ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. ORDER Bá»Š Há»¦Y (CANCELLED)
   - KhÃ´ng tÃ­nh chiáº¿t kháº¥u
   - KhÃ´ng cáº­p nháº­t ShopAnalytics
   - HoÃ n tiá»n cho khÃ¡ch

2. ORDER Bá»Š TRÆ¯áº¢ (REFUNDED)
   - Náº¿u Ä‘Ã£ tÃ­nh chiáº¿t kháº¥u â†’ HoÃ n láº¡i chiáº¿t kháº¥u cho shop
   - Cáº­p nháº­t ShopAnalytics: trá»« Ä‘i commissionAmount
   - HoÃ n toÃ n bá»™ tiá»n cho khÃ¡ch

3. ORDER KHÃ”NG CÃ“ SHOP (EDGE CASE)
   - Validate: order.getShop() != null
   - Náº¿u NULL â†’ Skip tÃ­nh chiáº¿t kháº¥u, log warning

4. SHOP KHÃ”NG CÃ“ COMMISSION PERCENTAGE
   - Máº·c Ä‘á»‹nh = 0.00%
   - KhÃ´ng láº¥y chiáº¿t kháº¥u tá»« order nÃ y
   - ShopNetRevenue = totalAmount (toÃ n bá»™ cho shop)

5. NHIá»€U ORDER TRONG 1 NGÃ€Y
   - Má»—i order Ä‘Æ°á»£c tÃ­nh chiáº¿t kháº¥u riÃªng
   - Cá»™ng dá»“n táº¥t cáº£ vÃ o 1 ShopAnalytics record
   - KhÃ´ng táº¡o báº£n ghi riÃªng cho tá»«ng order


âœ… CHECKLIST TRIá»‚N KHAI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Frontend:
  â˜‘ Hiá»ƒn thá»‹ commission_percentage trÃªn trang quáº£n lÃ½ shop (Admin)
  â˜‘ ThÃªm modal/form Ä‘á»ƒ cáº­p nháº­t commission
  â˜‘ Hiá»ƒn thá»‹ chiáº¿t kháº¥u trÃªn dashboard shop owner
  â˜‘ Hiá»ƒn thá»‹ tiá»n thá»±c nháº­n (sau trá»« chiáº¿t kháº¥u) trÃªn dashboard

Backend - Services:
  â˜‘ ShopService.updateShopCommission() - Cáº­p nháº­t má»©c chiáº¿t kháº¥u
  â˜‘ DailyAnalyticsService.updateDailyAnalyticsForOrder() - TÃ­nh chiáº¿t kháº¥u
  â˜‘ OrderService.updateOrderStatus() - KÃ­ch hoáº¡t tÃ­nh chiáº¿t kháº¥u khi DELIVERED
  â˜‘ ThÃªm xá»­ lÃ½ hoÃ n chiáº¿t kháº¥u khi refund

Backend - Database:
  â˜‘ Shops table cÃ³ commission_percentage
  â˜‘ ShopAnalytics cÃ³ commission_percentage, commission_amount, shop_net_revenue
  â˜‘ Migration scripts táº¡o cÃ¡c cá»™t má»›i

Testing:
  â˜‘ Test tÃ­nh toÃ¡n chiáº¿t kháº¥u chÃ­nh xÃ¡c
  â˜‘ Test order há»§y khÃ´ng tÃ­nh chiáº¿t kháº¥u
  â˜‘ Test refund hoÃ n chiáº¿t kháº¥u
  â˜‘ Test multiple orders cumulative calculation
  â˜‘ Test commission 0% khÃ´ng láº¥y tiá»n


ğŸ“ˆ CÃ”NG THá»¨C TÃNH TOÃN - CHUáº¨N HÃ“A
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Cho má»—i Ä‘Æ¡n hÃ ng thÃ nh cÃ´ng (DELIVERED):

1. Chiáº¿t kháº¥u tá»« Platform:
   CommissionAmount = TotalAmount Ã— (CommissionPercentage / 100)

2. Tiá»n Shop nháº­n:
   ShopNetRevenue = TotalAmount - CommissionAmount

3. Kiá»ƒm chá»©ng:
   CommissionAmount + ShopNetRevenue = TotalAmount âœ“

VÃ­ dá»¥ thá»±c táº¿:
   TotalAmount = 1.000.000 Ä‘
   CommissionPercentage = 15%
   
   CommissionAmount = 1.000.000 Ã— (15 / 100) = 150.000 Ä‘
   ShopNetRevenue = 1.000.000 - 150.000 = 850.000 Ä‘
   
   Kiá»ƒm chá»©ng: 150.000 + 850.000 = 1.000.000 âœ“


================================================================================
12. LIÃŠN Há»† & Há»– TRá»¢
================================================================================

Náº¿u cÃ³ báº¥t ká»³ cÃ¢u há»i hoáº·c váº¥n Ä‘á», vui lÃ²ng liÃªn há»‡:
- Hiáº¿u: [admin.hiá»u]
- Email: [admin-email]
- Slack: #development

================================================================================
