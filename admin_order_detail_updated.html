<!-- UPDATED: admin/order/detail.html - Giao diện admin chi tiết đơn hàng -->

<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chi tiết đơn hàng - UTE Fashion Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container mt-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Chi tiết đơn hàng #<span th:text="${order.orderNumber}"></span></h1>
            <a href="/admin/orders" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Quay lại
            </a>
        </div>

        <!-- Flash Messages -->
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show">
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show">
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Order Status Badge -->
        <div class="mb-3">
            <span class="badge fs-6" th:classappend="${order.orderStatus == 'Processing'} ? 'bg-warning text-dark' : 
                                                      ${order.orderStatus == 'Confirmed'} ? 'bg-info' : 
                                                      ${order.orderStatus == 'Shipping'} ? 'bg-primary' : 
                                                      ${order.orderStatus == 'Delivered'} ? 'bg-success' : 
                                                      ${order.orderStatus == 'Cancelled'} ? 'bg-danger' : 
                                                      ${order.orderStatus == 'RETURN_REQUESTED'} ? 'bg-warning' : 'bg-secondary'"
                  th:text="${order.orderStatus == 'Processing'} ? 'Đơn Đang Xử Lý' : 
                            ${order.orderStatus == 'Confirmed'} ? 'Đã Xử Lý Đơn Hàng' : 
                            ${order.orderStatus == 'Shipping'} ? 'Đang Giao' : 
                            ${order.orderStatus == 'Delivered'} ? 'Đã Giao' : 
                            ${order.orderStatus == 'Cancelled'} ? 'Đã Hủy' : 
                            ${order.orderStatus == 'RETURN_REQUESTED'} ? 'Yêu Cầu Trả Hàng' : ${order.orderStatus}">
            </span>
        </div>

        <div class="row">
            <!-- Order Information -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> Thông tin đơn hàng</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Ngày đặt:</strong> <span th:text="${#temporals.format(order.orderDate, 'dd/MM/yyyy HH:mm')}"></span></p>
                        <p><strong>Khách hàng:</strong> <span th:text="${order.user?.fullName}"></span></p>
                        <p><strong>Email:</strong> <span th:text="${order.email}"></span></p>
                        <p><strong>Tổng tiền:</strong> <span class="text-success fw-bold" th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></span></p>
                        <p><strong>Phí vận chuyển:</strong> <span th:text="${#numbers.formatDecimal(order.shippingFee, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></span></p>
                        <p><strong>Nhà vận chuyển:</strong> <span th:text="${order.carrier?.carrierName}"></span></p>
                        <p th:if="${order.shipper}" class="mb-0">
                            <strong>Shipper:</strong> <span th:text="${order.shipper?.fullName}"></span>
                            <small class="text-muted">(<span th:text="${order.shipper?.phoneNumber}"></span>)</small>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Shipping Information -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-truck"></i> Thông tin giao hàng</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Người nhận:</strong> <span th:text="${order.recipientName}"></span></p>
                        <p><strong>Số điện thoại:</strong> <span th:text="${order.phoneNumber}"></span></p>
                        <p><strong>Địa chỉ:</strong></p>
                        <address class="ms-3">
                            <span th:text="${order.shippingAddress}"></span><br>
                            <span th:text="${order.ward + ', ' + order.district + ', ' + order.city}"></span>
                        </address>
                        <p th:if="${order.customerNotes}" class="mb-0">
                            <strong>Ghi chú:</strong> <span th:text="${order.customerNotes}"></span>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Items -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-shopping-cart"></i> Sản phẩm đặt hàng</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Sản phẩm</th>
                                <th>SKU</th>
                                <th>Kích thước</th>
                                <th>Màu sắc</th>
                                <th class="text-center">Số lượng</th>
                                <th class="text-end">Đơn giá</th>
                                <th class="text-end">Thành tiền</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="item : ${order.orderItems}">
                                <td>
                                    <strong th:text="${item.productName}"></strong>
                                </td>
                                <td class="text-muted" th:text="${item.productSku}"></td>
                                <td>
                                    <span th:if="${item.size}" th:text="${item.size}" class="badge bg-light text-dark"></span>
                                    <span th:unless="${item.size}">-</span>
                                </td>
                                <td>
                                    <span th:if="${item.color}" th:text="${item.color}" class="badge bg-light text-dark"></span>
                                    <span th:unless="${item.color}">-</span>
                                </td>
                                <td class="text-center" th:text="${item.quantity}"></td>
                                <td class="text-end" th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></td>
                                <td class="text-end fw-bold" th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></td>
                            </tr>
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td colspan="6" class="text-end"><strong>Tổng cộng:</strong></td>
                                <td class="text-end"><strong th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VNĐ'"></strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- ADMIN ACTION PANELS -->
        
        <!-- Panel 1: Chọn Shipper (chỉ hiển thị khi Processing) -->
        <div th:if="${order.orderStatus == 'Processing' and availableShippers != null}" class="card mt-4">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-user-plus"></i> Xác nhận đơn hàng và chọn Shipper</h5>
            </div>
            <div class="card-body">
                <form th:action="@{/admin/orders/{id}/assign-shipper(id=${order.id})}" method="post">
                    <div class="mb-3">
                        <label class="form-label">Chọn Shipper phù hợp với <strong th:text="${order.carrier?.carrierName}"></strong>:</label>
                        <select name="shipperId" class="form-select" required>
                            <option value="">-- Chọn Shipper --</option>
                            <option th:each="shipper : ${availableShippers}" 
                                    th:value="${shipper.id}"
                                    th:text="${shipper.fullName + ' - ' + shipper.phoneNumber + ' (Đã hủy: ' + shipper.cancelCount + '/3)'}"></option>
                        </select>
                        <div class="form-text">Shipper sẽ nhận thông báo và có thể xác nhận giao hàng</div>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Xác nhận và giao cho Shipper
                    </button>
                </form>
            </div>
        </div>

        <!-- Panel 2: Xử lý yêu cầu trả hàng -->
        <div th:if="${order.orderStatus == 'RETURN_REQUESTED'}" class="card mt-4">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-undo"></i> Yêu cầu trả hàng từ khách hàng</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Khách hàng đã yêu cầu trả hàng đơn này. Vui lòng xem xét và quyết định.
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <form th:action="@{/admin/orders/{id}/process-return(id=${order.id})}" method="post" class="d-inline">
                            <input type="hidden" name="approved" value="true">
                            <div class="mb-3">
                                <label class="form-label">Ghi chú chấp thuận:</label>
                                <textarea name="notes" class="form-control" placeholder="Lý do chấp thuận trả hàng..." required></textarea>
                            </div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-check"></i> Chấp thuận trả hàng
                            </button>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <form th:action="@{/admin/orders/{id}/process-return(id=${order.id})}" method="post" class="d-inline">
                            <input type="hidden" name="approved" value="false">
                            <div class="mb-3">
                                <label class="form-label">Ghi chú từ chối:</label>
                                <textarea name="notes" class="form-control" placeholder="Lý do từ chối yêu cầu..." required></textarea>
                            </div>
                            <button type="submit" class="btn btn-danger">
                                <i class="fas fa-times"></i> Từ chối trả hàng
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel 3: Thông tin trạng thái (khi Confirmed, Shipping, etc.) -->
        <div th:if="${order.orderStatus != 'Processing' and order.orderStatus != 'RETURN_REQUESTED'}" class="card mt-4">
            <div class="card-header" th:classappend="${order.orderStatus == 'Confirmed'} ? 'bg-info text-white' : 
                                                     ${order.orderStatus == 'Shipping'} ? 'bg-primary text-white' : 
                                                     ${order.orderStatus == 'Delivered'} ? 'bg-success text-white' : 
                                                     ${order.orderStatus == 'Cancelled'} ? 'bg-danger text-white' : 'bg-secondary text-white'">
                <h5><i class="fas fa-info"></i> Trạng thái hiện tại</h5>
            </div>
            <div class="card-body">
                <div th:switch="${order.orderStatus}">
                    
                    <!-- Confirmed Status -->
                    <div th:case="'Confirmed'">
                        <div class="alert alert-info">
                            <i class="fas fa-clock"></i> <strong>Đã xử lý đơn hàng</strong> - Đơn hàng đã được xác nhận và giao cho shipper.
                            Shipper cần xác nhận để bắt đầu giao hàng.
                        </div>
                        <p><strong>Shipper được giao:</strong> <span th:text="${order.shipper?.fullName}"></span></p>
                        <p><strong>Thời gian xác nhận:</strong> <span th:text="${#temporals.format(order.confirmedAt, 'dd/MM/yyyy HH:mm')}"></span></p>
                    </div>
                    
                    <!-- Shipping Status -->
                    <div th:case="'Shipping'">
                        <div class="alert alert-primary">
                            <i class="fas fa-truck"></i> <strong>Đang giao hàng</strong> - Shipper đã xác nhận và đang giao hàng.
                        </div>
                        <p><strong>Shipper:</strong> <span th:text="${order.shipper?.fullName}"></span></p>
                        <p><strong>Bắt đầu giao:</strong> <span th:text="${#temporals.format(order.shippedAt, 'dd/MM/yyyy HH:mm')}"></span></p>
                        <p th:if="${order.estimatedDeliveryTime}">
                            <strong>Dự kiến giao xong:</strong> 
                            <span th:text="${#temporals.format(order.estimatedDeliveryTime, 'dd/MM/yyyy HH:mm')}"></span>
                        </p>
                    </div>
                    
                    <!-- Delivered Status -->
                    <div th:case="'Delivered'">
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> <strong>Đã giao thành công</strong> - Đơn hàng đã được giao đến khách hàng.
                        </div>
                        <p><strong>Thời gian giao:</strong> <span th:text="${#temporals.format(order.deliveredAt, 'dd/MM/yyyy HH:mm')}"></span></p>
                    </div>
                    
                    <!-- Cancelled Status -->
                    <div th:case="'Cancelled'">
                        <div class="alert alert-danger">
                            <i class="fas fa-times-circle"></i> <strong>Đã hủy</strong> - Đơn hàng đã bị hủy.
                        </div>
                        <p><strong>Thời gian hủy:</strong> <span th:text="${#temporals.format(order.cancelledAt, 'dd/MM/yyyy HH:mm')}"></span></p>
                    </div>
                    
                </div>
            </div>
        </div>

        <!-- Order Status History -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> Lịch sử trạng thái đơn hàng</h5>
            </div>
            <div class="card-body">
                <!-- TODO: Display order status history if available in orderDTO -->
                <p class="text-muted">Lịch sử thay đổi trạng thái sẽ được hiển thị tại đây.</p>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>